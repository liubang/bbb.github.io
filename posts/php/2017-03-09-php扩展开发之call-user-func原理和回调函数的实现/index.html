<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=zh-cn data-palette=blue-gray><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>PHP扩展开发之call_user_func原理和回调函数的实现 - liubang's blog</title><link rel=apple-touch-icon href=https://iliubang.cn/images/icons/icon-180x180.png sizes=180x180><link rel=icon href=https://iliubang.cn/images/icons/icon-32x32.png sizes=32x32 type=image/png><link rel=icon href=https://iliubang.cn/images/icons/icon-16x16.png sizes=16x16 type=image/png><link rel=icon href=https://iliubang.cn/images/icons/favicon.ico><link rel=manifest href=https://iliubang.cn/manifest.json><meta name=keywords content><meta name=description content="函数调用 很多时候，我们需要通过函数名来调用函数，并传递参数，或者把匿名函数作为函数的参数传递，实现回调。当我们在遇到这样的需求的时候，用 php 代"><meta name=robots content="index, follow"><meta itemprop=name content="PHP扩展开发之call_user_func原理和回调函数的实现"><meta itemprop=description content="函数调用 很多时候，我们需要通过函数名来调用函数，并传递参数，或者把匿名函数作为函数的参数传递，实现回调。当我们在遇到这样的需求的时候，用 php 代"><meta itemprop=datePublished content="2017-03-09T00:00:00+00:00"><meta itemprop=dateModified content="2017-03-09T00:00:00+00:00"><meta itemprop=wordCount content="2199"><meta itemprop=keywords content="c,php,"><meta property="og:title" content="PHP扩展开发之call_user_func原理和回调函数的实现"><meta property="og:description" content="函数调用 很多时候，我们需要通过函数名来调用函数，并传递参数，或者把匿名函数作为函数的参数传递，实现回调。当我们在遇到这样的需求的时候，用 php 代"><meta property="og:type" content="article"><meta property="og:url" content="https://iliubang.cn/posts/php/2017-03-09-php%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91%E4%B9%8Bcall-user-func%E5%8E%9F%E7%90%86%E5%92%8C%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%9E%E7%8E%B0/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-03-09T00:00:00+00:00"><meta property="article:modified_time" content="2017-03-09T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="PHP扩展开发之call_user_func原理和回调函数的实现"><meta name=twitter:description content="函数调用 很多时候，我们需要通过函数名来调用函数，并传递参数，或者把匿名函数作为函数的参数传递，实现回调。当我们在遇到这样的需求的时候，用 php 代"><meta property="og:image" content="https://iliubang.cn/images/apple-touch-icon.png"><meta name=twitter:image content="https://iliubang.cn/images/apple-touch-icon.png"><link rel=stylesheet href="https://iliubang.cn/assets/main/bundle.min.8bdb858b19c90cb2b5a3fc4c663f96440877f24a4cd3f75d1e2e7eeecf5084c6.css" integrity="sha256-i9uFixnJDLK1o/xMZj+WRAh38kpM0/ddHi5+7s9QhMY=" crossorigin=anonymous><link rel=stylesheet href=https://iliubang.cn/assets/katex/bundle.min.1e4d98f6a1073d58e1fc772be53b5b12b73e09bf4fa0d5ef6e2df558c8188ef8.css integrity="sha256-Hk2Y9qEHPVjh/Hcr5TtbErc+Cb9PoNXvbi31WMgYjvg=" crossorigin=anonymous><link rel=stylesheet href=https://iliubang.cn/assets/viewer/bundle.min.f05183267bb952fbc8c63a7178364de2951614ab71d544ec1068ad36c7447ccc.css integrity="sha256-8FGDJnu5UvvIxjpxeDZN4pUWFKtx1UTsEGitNsdEfMw=" crossorigin=anonymous></head><body><script>const items=["mode","palette"];items.forEach(function(e){const t=localStorage.getItem("hbs-"+e);t&&document.body.parentElement.setAttribute("data-"+e,t)})</script><header><nav class="navbar top-app-bar top-app-bar-expand-lg fixed-top"><div class=container><button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<i class="fas fa-bars"></i>
</button><a class="navbar-brand flex-grow-1 flex-lg-grow-0 text-center text-lg-start mx-auto me-lg-3" href=https://iliubang.cn><img class=logo alt=Logo src=https://iliubang.cn/images/apple-touch-icon.png loading=lazy width=180 height=180>
HIGHKYCK</a><div class="offcanvas offcanvas-bottom surface" tabindex=-1 id=offcanvasSocialShare aria-labelledby=offcanvasSocialShare><div class=offcanvas-header><h3 class=offcanvas-title>Share</h3><button type=button class="btn btn-sm btn-outline-primary" data-bs-dismiss=offcanvas aria-label=Close>
<i class="fas fa-times"></i></button></div><div class=offcanvas-body><a class="btn btn-sm btn-outline-primary social-share-button" rel="noopener noreferrer" aria-label="Twitter Share Button" target=_blank href="https://twitter.com/intent/tweet?title=PHP%e6%89%a9%e5%b1%95%e5%bc%80%e5%8f%91%e4%b9%8bcall_user_func%e5%8e%9f%e7%90%86%e5%92%8c%e5%9b%9e%e8%b0%83%e5%87%bd%e6%95%b0%e7%9a%84%e5%ae%9e%e7%8e%b0&url=https%3a%2f%2filiubang.cn%2fposts%2fphp%2f2017-03-09-php%25E6%2589%25A9%25E5%25B1%2595%25E5%25BC%2580%25E5%258F%2591%25E4%25B9%258Bcall-user-func%25E5%258E%259F%25E7%2590%2586%25E5%2592%258C%25E5%259B%259E%25E8%25B0%2583%25E5%2587%25BD%25E6%2595%25B0%25E7%259A%2584%25E5%25AE%259E%25E7%258E%25B0%2f"><i class="fab fa-fw fa-twitter"></i> Twitter</a>
<a class="btn btn-sm btn-outline-primary social-share-button" rel="noopener noreferrer" aria-label="Facebook Share Button" target=_blank href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2filiubang.cn%2fposts%2fphp%2f2017-03-09-php%25E6%2589%25A9%25E5%25B1%2595%25E5%25BC%2580%25E5%258F%2591%25E4%25B9%258Bcall-user-func%25E5%258E%259F%25E7%2590%2586%25E5%2592%258C%25E5%259B%259E%25E8%25B0%2583%25E5%2587%25BD%25E6%2595%25B0%25E7%259A%2584%25E5%25AE%259E%25E7%258E%25B0%2f"><i class="fab fa-fw fa-facebook-f"></i> Facebook</a></div></div><button class=navbar-settings type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasSettings aria-controls=offcanvasSettings aria-label="Toggle settings">
<i class="fas fa-ellipsis-v"></i></button><div class="offcanvas offcanvas-end surface h-100" tabindex=-1 id=offcanvasSettings aria-labelledby=offcanvasSettings><div class=offcanvas-header><h3 class=offcanvas-title>设置</h3><button type=button class="btn btn-sm btn-outline-primary" data-bs-dismiss=offcanvas aria-label=Close>
<i class="fas fa-times"></i></button></div><div class="offcanvas-body d-flex flex-column"><div class=setting><form class=row><div class=col-auto><label for=fontSize class=form-label><i class="fas fa-fw fa-language"></i> 语言</label></div><div class="col-auto ms-auto"><div class=dropdown><a class="btn btn-sm btn-outline-primary dropdown-toggle" href=# id=languageDropdown role=button data-bs-toggle=dropdown aria-expanded=false>简体中文</a><ul class="dropdown-menu dropdown-menu-end" aria-labelledby=languageDropdown><li><a class=dropdown-item href=https://iliubang.cn/en/>English</a></li></ul></div></div></form></div><div class=setting><form class=row><div class=col-auto><label><i class="fas fa-fw fa-adjust"></i> 模式</label></div><div class="col-auto ms-auto"><div class="form-check form-switch"><input class=form-check-input type=checkbox id=modeSwitcher></div></div></form></div><div class="setting palettes"><form class=row><div class=col-auto><label><i class="fas fa-fw fa-palette"></i> 配色</label></div><div class="col-auto ms-auto"><a id=btnPalette class="btn btn-sm btn-outline-primary" role=button aria-label=palettePicker><i class="fas fa-eye-dropper"></i></a></div></form><div class="mt-2 d-flex justify-content-between visually-hidden" id=palettePicker><button type=button id=palette-blue aria-label=蓝色 class="btn btn-sm w-100 palette" data-palette=blue>
</button><button type=button id=palette-blue-gray aria-label=蓝灰色 class="btn btn-sm w-100 palette" data-palette=blue-gray>
</button><button type=button id=palette-brown aria-label=棕色 class="btn btn-sm w-100 palette" data-palette=brown>
</button><button type=button id=palette-cyan aria-label=青色 class="btn btn-sm w-100 palette" data-palette=cyan>
</button><button type=button id=palette-green aria-label=绿色 class="btn btn-sm w-100 palette" data-palette=green>
</button><button type=button id=palette-indigo aria-label=靛青色 class="btn btn-sm w-100 palette" data-palette=indigo>
</button><button type=button id=palette-orange aria-label=橙色 class="btn btn-sm w-100 palette" data-palette=orange>
</button><button type=button id=palette-pink aria-label=粉色 class="btn btn-sm w-100 palette" data-palette=pink>
</button><button type=button id=palette-purple aria-label=紫色 class="btn btn-sm w-100 palette" data-palette=purple>
</button><button type=button id=palette-red aria-label=红色 class="btn btn-sm w-100 palette" data-palette=red>
</button><button type=button id=palette-teal aria-label=蓝绿色 class="btn btn-sm w-100 palette" data-palette=teal>
</button><button type=button id=palette-yellow aria-label=黄色 class="btn btn-sm w-100 palette" data-palette=yellow></button></div></div><div class="setting actions d-flex justify-content-around mt-auto overflow-auto"><a role=button class="action action-go-back" href="javascript: window.history.back();"><span class=action-icon><i class="fas fa-2x fa-chevron-circle-down" data-fa-transform=rotate-90></i></span> 返回</a>
<a role=button class="action action-reload-page"><span class=action-icon><i class="fas fa-2x fa-redo-alt"></i></span> 刷新</a>
<a role=button class="action action-copy-url"><span class=action-icon><i class="fas fa-2x fa-link"></i></span> 复制链接
</a><a class="action action-social-share" role=button data-bs-toggle=offcanvas data-bs-target=#offcanvasSocialShare aria-controls=offcanvasSocialShare aria-label="Toggle social share"><span class=action-icon><i class="fas fa-2x fa-share-alt"></i></span> 分享</a></div></div></div><div class="collapse navbar-collapse" tabindex=-1 id=navbarSupportedContent aria-labelledby=navbarSupportedContent><form class="search-bar my-1" action=https://iliubang.cn/search><div class="input-group input-group-sm"><span class="btn btn-search disabled position-absolute left-0"><i class="fas fa-fw fa-search"></i></span>
<input class="form-control rounded-pill" name=q type=search aria-label=Search></div></form><ul class="navbar-nav ms-auto"><li class=nav-item><a class=nav-link href=https://iliubang.cn/series/><i class="fas fa-fw fa-columns"></i>专栏</a></li><li class=nav-item><a class=nav-link href=https://iliubang.cn/archives/><i class="fas fa-fw fa-file-archive"></i>归档</a></li><li class=nav-item><a class=nav-link href=https://iliubang.cn/categories/><i class="fas fa-fw fa-folder"></i>分类</a></li><li class=nav-item><a class=nav-link href=https://iliubang.cn/tags/><i class="fas fa-fw fa-tags"></i>标签</a></li></ul></div></div></nav></header><main class=container><div class="row content"><div class=col-lg-8><div class=container><nav class="row card component" aria-label=breadcrumb><div class=card-body><ol class=breadcrumb><li class=breadcrumb-item><a href=https://iliubang.cn/>主页</a></li><li class=breadcrumb-item><a href=https://iliubang.cn/posts/>文章</a></li><li class="breadcrumb-item active">PHP扩展开发之call_user_func原理和回调函数的实现</li></ol></div></nav><div class=post-panel-wrapper><div class="d-flex flex-column component rounded post-panel"><a class="action action-panel-toggler" role=button title="Panel toggler"><i class="fas fa-fw fa-chevron-circle-down"></i></a>
<a id=sidebarToggler class="action d-none d-lg-block" role=button title="Sidebar toggler"><i class="fas fa-fw fa-expand-alt" data-fa-transform=rotate-45></i></a>
<a class="action btn-reward" role=button data-bs-toggle=modal data-bs-target=#rewardModal title=打赏><i class="fas fa-fw fa-coffee"></i></a>
<a class=action href=#post-copyright role=button aria-label=Copyright title=Copyright><i class="fas fa-fw fa-copyright"></i></a>
<a class=action href=#post-comments role=button aria-label=Comments title=Comments><i class="fas fa-fw fa-comments"></i></a>
<a class=action href=#postTOC aria-controls="Table of contents" role=button title="Table of contents"><i class="fas fa-fw fa-list-alt"></i></a></div></div><article class="row card component mb-4 post"><div class=card-header><h1 class="card-title post-title">PHP扩展开发之call_user_func原理和回调函数的实现</h1></div><div class=card-body><div class=post-meta><span class=post-date title="创建于 2017-03-09 00:00:00 +0000 UTC。">2017-03-09
</span><span class=post-reading-time>5 分钟阅读
</span><span class=post-taxonomies><a href=https://iliubang.cn/categories/programming/ class="badge post-taxonomy">programming</a><a href=https://iliubang.cn/tags/c/ class="badge post-taxonomy">c</a><a href=https://iliubang.cn/tags/php/ class="badge post-taxonomy">php</a></span></div><div class="post-share mb-3"><div class=addthis_inline_share_toolbox></div></div><div class="post-content mb-3"><h2 id=函数调用>函数调用<a class="anchor ms-1" href=#函数调用><i class="fas fa-link"></i></a></h2><p>很多时候，我们需要通过函数名来调用函数，并传递参数，或者把匿名函数作为函数的参数传递，实现回调。当我们在遇到这样的需求的时候，用 php 代码实现起来肯定是非常容易和简单的。但是，当我们在用 c 语言编写 php 扩展的时候，如何来实现这样的功能呢？下面就一起来深入了解 php 内核，看看如何实现。</p><p>在 Zend 引擎中，给我们提供了<code>zend_call_function</code>,<code>call_user_function</code>以及<code>call_user_function_ex</code>函数来帮助我们实现函数调用。在<code>zend_API.h</code>文件中，我们可以看到如下函数原型的声明：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln>1</span><span class=cl><span class=n>ZEND_API</span> <span class=kt>int</span> <span class=nf>zend_call_function</span><span class=p>(</span><span class=n>zend_fcall_info</span> <span class=o>*</span><span class=n>fci</span><span class=p>,</span> <span class=n>zend_fcall_info_cache</span> <span class=o>*</span><span class=n>fci_cache</span> <span class=n>TSRMLS_DC</span><span class=p>);</span>
</span></span><span class=line><span class=ln>2</span><span class=cl><span class=n>ZEND_API</span> <span class=kt>int</span> <span class=nf>call_user_function</span><span class=p>(</span><span class=n>HashTable</span> <span class=o>*</span><span class=n>function_table</span><span class=p>,</span> <span class=n>zval</span> <span class=o>**</span><span class=n>object_pp</span><span class=p>,</span> <span class=n>zval</span> <span class=o>*</span><span class=n>function_name</span><span class=p>,</span> <span class=n>zval</span> <span class=o>*</span><span class=n>retval_ptr</span><span class=p>,</span> <span class=n>zend_uint</span> <span class=n>param_count</span><span class=p>,</span> <span class=n>zval</span> <span class=o>*</span><span class=n>params</span><span class=p>[]</span> <span class=n>TSRMLS_DC</span><span class=p>);</span>
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=n>ZEND_API</span> <span class=kt>int</span> <span class=nf>call_user_function_ex</span><span class=p>(</span><span class=n>HashTable</span> <span class=o>*</span><span class=n>function_table</span><span class=p>,</span> <span class=n>zval</span> <span class=o>**</span><span class=n>object_pp</span><span class=p>,</span> <span class=n>zval</span> <span class=o>*</span><span class=n>function_name</span><span class=p>,</span> <span class=n>zval</span> <span class=o>**</span><span class=n>retval_ptr_ptr</span><span class=p>,</span> <span class=n>zend_uint</span> <span class=n>param_count</span><span class=p>,</span> <span class=n>zval</span> <span class=o>**</span><span class=n>params</span><span class=p>[],</span> <span class=kt>int</span> <span class=n>no_separation</span><span class=p>,</span> <span class=n>HashTable</span> <span class=o>*</span><span class=n>symbol_table</span> <span class=n>TSRMLS_DC</span><span class=p>);</span>
</span></span></code></pre></div><p>从函数的参数上来看，显然<code>zend_call_function</code>需要的参数很少，而其他两个都需要一堆参数，所以，我们可能会想，达到相同的效果为什么参数上有如此大的区别，于是带着这个疑问我们来解刨<code>zend_fcall_info</code>结构体。同样在<code>zend_API.h</code>中会看到如下结构体的定义：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln> 1</span><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=n>_zend_fcall_info</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>        <span class=n>size_t</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>        <span class=n>HashTable</span> <span class=o>*</span><span class=n>function_table</span><span class=p>;</span> <span class=c1>//函数表
</span></span></span><span class=line><span class=ln> 4</span><span class=cl><span class=c1></span>        <span class=n>zval</span> <span class=o>*</span><span class=n>function_name</span><span class=p>;</span>	   <span class=c1>//函数，可以是函数名，也可以直接是匿名函数本身
</span></span></span><span class=line><span class=ln> 5</span><span class=cl><span class=c1></span>        <span class=n>HashTable</span> <span class=o>*</span><span class=n>symbol_table</span><span class=p>;</span>   <span class=c1>//符号表
</span></span></span><span class=line><span class=ln> 6</span><span class=cl><span class=c1></span>        <span class=n>zval</span> <span class=o>**</span><span class=n>retval_ptr_ptr</span><span class=p>;</span>	   <span class=c1>//返回值
</span></span></span><span class=line><span class=ln> 7</span><span class=cl><span class=c1></span>        <span class=n>zend_uint</span> <span class=n>param_count</span><span class=p>;</span>     <span class=c1>//参数个数
</span></span></span><span class=line><span class=ln> 8</span><span class=cl><span class=c1></span>        <span class=n>zval</span> <span class=o>***</span><span class=n>params</span><span class=p>;</span> 		   <span class=c1>//参数，数组
</span></span></span><span class=line><span class=ln> 9</span><span class=cl><span class=c1></span>        <span class=n>zval</span> <span class=o>*</span><span class=n>object_ptr</span><span class=p>;</span>		   <span class=c1>//调用对象方法时候需要传调用的对象
</span></span></span><span class=line><span class=ln>10</span><span class=cl><span class=c1></span>        <span class=n>zend_bool</span> <span class=n>no_separation</span><span class=p>;</span>
</span></span><span class=line><span class=ln>11</span><span class=cl><span class=p>}</span> <span class=n>zend_fcall_info</span><span class=p>;</span>
</span></span></code></pre></div><p>不难发现，原来是把相关字段封装到了结构体中了，所以显得参数数量少，实际上该有的都有。</p><p>对于<code>call_user_function</code>中相关参数含义的解释，这里就不强行翻译了，引用官方的一段话，虽然是英文，但是我相信聪明的你也肯定能看懂的！</p><blockquote><p>User functions can be called with the function call_user_function_ex(). It requires a hash value for the function table you want to access, a pointer to an object (if you want to call a method), the function name, return value, number of arguments, argument array, and a flag indicating whether you want to perform zval separation.
Note that you don&rsquo;t have to specify both function_table and object; either will do. If you want to call a method, you have to supply the object that contains this method, in which case call_user_function()automatically sets the function table to this object&rsquo;s function table. Otherwise, you only need to specify function_table and can set object to NULL.
Next is the parameter count as integer and an array containing all necessary parameters. The last argument specifies whether the function should perform zval separation - this should always be set to 0. If set to 1, the function consumes less memory but fails if any of the parameters need separation.</p></blockquote><h2 id=实现自己的-call_user_func-函数>实现自己的 call_user_func 函数<a class="anchor ms-1" href=#实现自己的-call_user_func-函数><i class="fas fa-link"></i></a></h2><p>废话不多说，下面就来动手实现一个自己的<code>call_user_func</code>函数;
这个函数是一个比较特殊的函数，因为他除了第一个参数是一个字符串之外，剩余的参数都是可变参数，而且没有固定的个数，所以想到这里是不是发现又遇到了一些小小的困难。不过没关系，遇到一切问题首先要想到查阅官方文档，于是在<a href=http://php.net/manual/en/internals2.funcs.php target=_blank rel="noopener noreferrer">php 官方文档</a>中找到了答案，在该文档页中，向我们列举了所有的 Type Specifiers:</p><table><thead><tr><th style=text-align:left>Spec</th><th style=text-align:left>Type</th><th style=text-align:left>Locals</th></tr></thead><tbody><tr><td style=text-align:left>a</td><td style=text-align:left>array</td><td style=text-align:left>zval*</td></tr><tr><td style=text-align:left>A</td><td style=text-align:left>array or object</td><td style=text-align:left>zval*</td></tr><tr><td style=text-align:left>b</td><td style=text-align:left>boolean</td><td style=text-align:left>zend_bool</td></tr><tr><td style=text-align:left>C</td><td style=text-align:left>class</td><td style=text-align:left>zend_class_entry*</td></tr><tr><td style=text-align:left>d</td><td style=text-align:left>double</td><td style=text-align:left>double</td></tr><tr><td style=text-align:left>f</td><td style=text-align:left>function</td><td style=text-align:left>zend_fcall_info*, zend_fcall_info_cache*</td></tr><tr><td style=text-align:left>h</td><td style=text-align:left>array</td><td style=text-align:left>HashTable*</td></tr><tr><td style=text-align:left>H</td><td style=text-align:left>array or object</td><td style=text-align:left>HashTable*</td></tr><tr><td style=text-align:left>l</td><td style=text-align:left>long</td><td style=text-align:left>long</td></tr><tr><td style=text-align:left>L</td><td style=text-align:left>long(limits out-of-range LONG_MAX/LONG_MIN)</td><td style=text-align:left>long</td></tr><tr><td style=text-align:left>o</td><td style=text-align:left>object</td><td style=text-align:left>zval*</td></tr><tr><td style=text-align:left>O</td><td style=text-align:left>object(of specified zend_class_entry)</td><td style=text-align:left>zval*, zend_class_entry *</td></tr><tr><td style=text-align:left>p</td><td style=text-align:left>string(a valid path)</td><td style=text-align:left>char*, int</td></tr><tr><td style=text-align:left>r</td><td style=text-align:left>resource</td><td style=text-align:left>zval*</td></tr><tr><td style=text-align:left>s</td><td style=text-align:left>string</td><td style=text-align:left>char*, int</td></tr><tr><td style=text-align:left>z</td><td style=text-align:left>mixed</td><td style=text-align:left>zval*</td></tr><tr><td style=text-align:left>Z</td><td style=text-align:left>mixed</td><td style=text-align:left>zval**</td></tr></tbody></table><p>当我们看到这张表的时候只是了解到了在 php 扩展中参数传递对应关系，以及如何切当使用类型标记符，但是并没有解决我们需要传递不定长参数的问题。别着急，往下看会看到 Advanced Type Specifiers 这样的文字，是的，你没有看错，这玩意还有高级用法：</p><table><thead><tr><th style=text-align:left>Spec</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left>*</td><td style=text-align:left>a variable number of argument of the preceeding type, 0 or more</td></tr><tr><td style=text-align:left>+</td><td style=text-align:left>a variable number of argument of the preceeding type, 1 or more</td></tr><tr><td style=text-align:left>$\mid$</td><td style=text-align:left>indicates that the remaining parameters are optional</td></tr><tr><td style=text-align:left>!</td><td style=text-align:left>the preceeding parameter can be of the specified type or null For &lsquo;b&rsquo;, &rsquo;l&rsquo; and &rsquo;d&rsquo;, an extra argument of type zend_bool* must be passed after the corresponding bool*, long* or double* addresses which will be set true if null is recieved.</td></tr></tbody></table><p>*，这不正是我们需要的吗！万事俱备，只欠东风，接下来，实现自己的<code>call_user_func</code>就是顺水推舟的事情了。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln> 1</span><span class=cl><span class=n>PHP_FUNCTION</span><span class=p>(</span><span class=n>demo_call_user_func</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>	<span class=n>zend_fcall_info</span>  <span class=n>fci</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>	<span class=n>zend_fcall_info_cache</span> <span class=n>fci_cache</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>	<span class=n>zval</span> <span class=o>*</span><span class=n>retval_ptr</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>zend_parse_parameters</span><span class=p>(</span><span class=n>ZEND_NUM_ARGS</span><span class=p>()</span> <span class=n>TSRMLS_CC</span><span class=p>,</span> <span class=s>&#34;f*&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>fci</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>fci_cache</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>fci</span><span class=p>.</span><span class=n>params</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>fci</span><span class=p>.</span><span class=n>param_count</span><span class=p>)</span> <span class=o>!=</span> <span class=n>SUCCESS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>		<span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>	<span class=n>fci</span><span class=p>.</span><span class=n>retval_ptr_ptr</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>retval_ptr</span><span class=p>;</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>zend_call_function</span><span class=p>(</span><span class=o>&amp;</span><span class=n>fci</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>fci_cache</span> <span class=n>TSRMLS_CC</span><span class=p>)</span> <span class=o>==</span> <span class=n>SUCCESS</span> <span class=o>&amp;&amp;</span> <span class=n>fci</span><span class=p>.</span><span class=n>retval_ptr_ptr</span> <span class=o>&amp;&amp;</span> <span class=o>*</span><span class=n>fci</span><span class=p>.</span><span class=n>retval_ptr_ptr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>		<span class=n>return_value</span> <span class=o>=</span> <span class=o>*</span><span class=n>fci</span><span class=p>.</span><span class=n>retval_ptr_ptr</span><span class=p>;</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>		<span class=n>zval_copy_ctor</span><span class=p>(</span><span class=n>return_value</span><span class=p>);</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>		<span class=n>zval_ptr_dtor</span><span class=p>(</span><span class=o>&amp;</span><span class=n>fci</span><span class=p>.</span><span class=n>retval_ptr_ptr</span><span class=p>);</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>fci</span><span class=p>.</span><span class=n>params</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>		<span class=n>efree</span><span class=p>(</span><span class=n>fci</span><span class=p>.</span><span class=n>params</span><span class=p>);</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln>18</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>看到这里的代码，可能有些人还是一头雾水，不太明白为什么要这么写，至此我需要声明一下，我在写这篇博客的时候假想读者都是对 php 扩展开发有过一定了解的人，至少知道如何用 c 语言写一个输出"hello world"的扩展，知道如何返回值，以及如何创建 php 中的基本数据类型，如何赋值甚至了解 php 扩展中如何开发一个类。所以呢，假如你还没有这些基础怎么办，那也没办法，建议先回去补充知识咯。</p><p>写好扩展，编译安装后我们来测试一下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=ln> 1</span><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=k>function</span> <span class=nf>say</span><span class=p>(</span><span class=nv>$msg</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>	<span class=k>echo</span> <span class=nv>$msg</span><span class=p>,</span> <span class=nx>PHP_EOL</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>
</span></span><span class=line><span class=ln> 7</span><span class=cl><span class=nx>demo_call_user_func</span><span class=p>(</span><span class=s1>&#39;say&#39;</span><span class=p>,</span> <span class=s2>&#34;hello world&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>
</span></span><span class=line><span class=ln> 9</span><span class=cl><span class=nx>demo_call_user_func</span><span class=p>(</span><span class=k>function</span><span class=p>(</span><span class=nv>$msg</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>	<span class=k>echo</span> <span class=nv>$msg</span><span class=p>,</span> <span class=nx>PHP_EOL</span><span class=p>;</span>
</span></span><span class=line><span class=ln>11</span><span class=cl><span class=p>},</span> <span class=s2>&#34;hello liubang&#34;</span><span class=p>);</span>
</span></span></code></pre></div><p>测试结果很自然的如我们所期待：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=ln>1</span><span class=cl>ubuntu@vm-911:~/workspace/c/php-5.6.30/ext/demo$ php test.php
</span></span><span class=line><span class=ln>2</span><span class=cl>hello world
</span></span><span class=line><span class=ln>3</span><span class=cl>hello liubang
</span></span></code></pre></div><h2 id=回调函数>回调函数<a class="anchor ms-1" href=#回调函数><i class="fas fa-link"></i></a></h2><p>有了上面的铺垫，我想到这里写一个回调函数已经是一件非常简单的事情了，只不过在<code>call_user_func</code>之前或者之后来做一些其他的操作。废话不多说，直接上代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln> 1</span><span class=cl><span class=n>PHP_FUNCTION</span><span class=p>(</span><span class=n>demo_callback</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>	<span class=n>zend_fcall_info</span> <span class=n>fci</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>	<span class=n>zend_fcall_info_cache</span> <span class=n>fci_cache</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>zend_parse_parameters</span><span class=p>(</span><span class=n>ZEND_NUM_ARGS</span><span class=p>()</span> <span class=n>TSRMLS_CC</span><span class=p>,</span> <span class=s>&#34;f&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>fci</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>fci_cache</span><span class=p>)</span> <span class=o>==</span> <span class=n>FAILURE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>		<span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>
</span></span><span class=line><span class=ln> 9</span><span class=cl>	<span class=n>php_printf</span><span class=p>(</span><span class=s>&#34;this is callback demo...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>	<span class=n>php_printf</span><span class=p>(</span><span class=s>&#34;start call callback function</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>	<span class=n>zval</span> <span class=o>*</span><span class=n>retval_ptr</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>	<span class=n>fci</span><span class=p>.</span><span class=n>retval_ptr_ptr</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>retval_ptr</span><span class=p>;</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>	<span class=n>zval</span> <span class=o>**</span><span class=n>arg</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>	<span class=n>zval</span> <span class=o>*</span><span class=n>param</span><span class=p>;</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>	<span class=n>MAKE_STD_ZVAL</span><span class=p>(</span><span class=n>param</span><span class=p>);</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>	<span class=n>ZVAL_STRING</span><span class=p>(</span><span class=n>param</span><span class=p>,</span> <span class=s>&#34;hello world&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>	<span class=n>arg</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>param</span><span class=p>;</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>	<span class=n>fci</span><span class=p>.</span><span class=n>param_count</span> <span class=o>=</span> <span class=mi>1</span><span class=p>;</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>	<span class=n>fci</span><span class=p>.</span><span class=n>params</span> <span class=o>=</span> <span class=n>arg</span><span class=p>;</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>zend_call_function</span><span class=p>(</span><span class=o>&amp;</span><span class=n>fci</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>fci_cache</span> <span class=n>TSRMLS_CC</span><span class=p>)</span> <span class=o>==</span> <span class=n>SUCCESS</span> <span class=o>&amp;&amp;</span> <span class=n>fci</span><span class=p>.</span><span class=n>retval_ptr_ptr</span> <span class=o>&amp;&amp;</span> <span class=o>*</span><span class=n>fci</span><span class=p>.</span><span class=n>retval_ptr_ptr</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>		<span class=n>COPY_PZVAL_TO_ZVAL</span><span class=p>(</span><span class=o>*</span><span class=n>return_value</span><span class=p>,</span> <span class=o>*</span><span class=n>fci</span><span class=p>.</span><span class=n>retval_ptr_ptr</span><span class=p>);</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln>23</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>以上代码所对应的 php 代码为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=ln>1</span><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=k>function</span> <span class=nf>demo_callback</span><span class=p>(</span><span class=nx>callable</span> <span class=nv>$callback</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>	<span class=k>echo</span> <span class=s2>&#34;this is callback demo...</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>	<span class=k>return</span> <span class=nv>$callback</span><span class=p>(</span><span class=s2>&#34;hello world&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>6</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>下面我们编译安装后测试一下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=ln>1</span><span class=cl><span class=o>&lt;?</span><span class=nx>php</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>
</span></span><span class=line><span class=ln>3</span><span class=cl><span class=nx>demo_callback</span><span class=p>(</span><span class=k>function</span><span class=p>(</span><span class=nv>$msg</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>	<span class=k>echo</span> <span class=nv>$msg</span><span class=p>,</span> <span class=nx>PHP_EOL</span><span class=p>;</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>	<span class=k>echo</span> <span class=s2>&#34;this is in callback function</span><span class=se>\n</span><span class=s2>&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=ln>6</span><span class=cl><span class=p>});</span>
</span></span></code></pre></div><p>执行结果如下：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln>1</span><span class=cl>ubuntu@vm-911:~/workspace/c/php-5.6.30/ext/demo$ php test.php
</span></span><span class=line><span class=ln>2</span><span class=cl>this is callback demo...
</span></span><span class=line><span class=ln>3</span><span class=cl>start call callback <span class=k>function</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>hello world
</span></span><span class=line><span class=ln>5</span><span class=cl>this is in callback <span class=k>function</span>
</span></span></code></pre></div><p>下面我再来用<code>call_user_function_ex</code>把回调重新实现一遍，写法基本一样：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=ln> 1</span><span class=cl><span class=n>PHP_FUNCTION</span><span class=p>(</span><span class=n>demo_callback_o</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>	<span class=n>zval</span> <span class=o>*</span><span class=n>func</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>zend_parse_parameters</span><span class=p>(</span><span class=n>ZEND_NUM_ARGS</span><span class=p>()</span> <span class=n>TSRMLS_CC</span><span class=p>,</span> <span class=s>&#34;z&#34;</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>func</span><span class=p>)</span> <span class=o>==</span> <span class=n>FAILURE</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>		<span class=k>return</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>	<span class=n>php_printf</span><span class=p>(</span><span class=s>&#34;before callback...</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>	<span class=kt>char</span> <span class=o>*</span><span class=n>func_name</span><span class=p>;</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>zend_is_callable</span><span class=p>(</span><span class=n>func</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>func_name</span> <span class=n>TSRMLS_CC</span><span class=p>))</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>		<span class=n>php_error_docref</span><span class=p>(</span><span class=nb>NULL</span> <span class=n>TSRMLS_CC</span><span class=p>,</span> <span class=n>E_WARNING</span><span class=p>,</span> <span class=s>&#34;Function: &#39;%s&#39; is not callable&#34;</span><span class=p>,</span> <span class=n>func_name</span><span class=p>);</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>		<span class=n>RETURN_FALSE</span><span class=p>;</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>	<span class=n>zval</span> <span class=o>*</span><span class=n>retval</span><span class=p>;</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>	<span class=n>zval</span> <span class=o>**</span><span class=n>arg</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>	<span class=n>zval</span> <span class=o>*</span><span class=n>param</span><span class=p>;</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>	<span class=n>MAKE_STD_ZVAL</span><span class=p>(</span><span class=n>param</span><span class=p>);</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>	<span class=n>ZVAL_STRING</span><span class=p>(</span><span class=n>param</span><span class=p>,</span> <span class=s>&#34;hello liubang&#34;</span><span class=p>,</span> <span class=mi>0</span><span class=p>);</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>	<span class=n>arg</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=o>&amp;</span><span class=n>param</span><span class=p>;</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>	<span class=k>if</span> <span class=p>(</span><span class=n>call_user_function_ex</span><span class=p>(</span><span class=n>EG</span><span class=p>(</span><span class=n>function_table</span><span class=p>),</span> <span class=nb>NULL</span><span class=p>,</span> <span class=n>func</span><span class=p>,</span> <span class=o>&amp;</span><span class=n>retval</span><span class=p>,</span> <span class=mi>1</span><span class=p>,</span> <span class=n>arg</span><span class=p>,</span> <span class=mi>0</span><span class=p>,</span> <span class=nb>NULL</span> <span class=n>TSRMLS_CC</span><span class=p>)</span> <span class=o>!=</span> <span class=n>SUCCESS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>		<span class=n>php_printf</span><span class=p>(</span><span class=s>&#34;callback complated!</span><span class=se>\n</span><span class=s>&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>	<span class=p>}</span>
</span></span><span class=line><span class=ln>22</span><span class=cl>	<span class=n>COPY_PZVAL_TO_ZVAL</span><span class=p>(</span><span class=o>*</span><span class=n>return_value</span><span class=p>,</span> <span class=n>retval</span><span class=p>);</span>
</span></span><span class=line><span class=ln>23</span><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>效果和上边是一样的，所以这里就不再测试了。</p><h2 id=总结>总结<a class="anchor ms-1" href=#总结><i class="fas fa-link"></i></a></h2><p>看到这里，也许你会觉得，这东西到底有什么用呢，是的，单纯地这么来看确实没有用，可是如果你也是一个对开源代码感兴趣的人，也许你也发现了在 php 著名的开源框架<code>swoole</code>中，就有很多地方使用到了类似的技巧，不同的是，<code>swoole</code>中是把所有的回调函数注册到一张表(也就是一个 zval 的数组)中，在请求的恰当阶段再来调用，于是就有了我们看到的类似于事件驱动的效果。所以，有了这些知识，假设你已经掌握了 linux 系统下的 TCP/IP 网络编程，那么你创造一个类似于<code>swoole</code>的产品又有何难。</p></div><div class="modal fade" id=rewardModal tabindex=-1 aria-labelledby=rewardModalLabel aria-hidden=true><div class=modal-dialog><div class="modal-content surface"><div class=modal-header><h5 class=modal-title id=rewardModalLabel><i class="fas fa-fw fa-coffee"></i>打赏</h5><a href=# data-bs-dismiss=modal class="btn btn-sm btn-outline-primary" aria-label=Close><i class="fas fa-times"></i></a></div><div class=modal-body><ul class="nav nav-tabs mb-3" role=tablist><li class="nav-item text-nowrap" role=presentation><a class="nav-link active" id=reward-alipay-tab data-bs-toggle=tab href=#reward-alipay role=tab aria-controls=reward-alipay aria-selected=true><i class="fab fa-fw fa-alipay"></i>支付宝</a></li><li class="nav-item text-nowrap" role=presentation><a class=nav-link id=reward-wechat-tab data-bs-toggle=tab href=#reward-wechat role=tab aria-controls=reward-wechat aria-selected=true><i class="fab fa-fw fa-weixin"></i>微信</a></li></ul><div class=tab-content id=rewardTabContent><div class="tab-pane fade post-reward-content show active" id=reward-alipay role=tabpanel aria-labelledby=reward-alipay-tab><img class="img-fluid post-reward-img" src=https://iliubang.cn/images/reward/alipay.jpg loading=lazy data-viewer-invisible></div><div class="tab-pane fade post-reward-content show" id=reward-wechat role=tabpanel aria-labelledby=reward-wechat-tab><img class="img-fluid post-reward-img" src=https://iliubang.cn/images/reward/wechat.jpg loading=lazy data-viewer-invisible></div></div></div></div></div></div></div><div class=card-footer><div class="post-navs d-flex justify-content-evenly"><div class="post-nav post-next"><a href=https://iliubang.cn/posts/compiler/2017-03-15-%E5%9F%BA%E4%BA%8Ec%E8%AF%AD%E8%A8%80%E7%9A%84%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E5%BC%80%E5%8F%91/>基于c语言的编程语言开发</a>
<i class="fas fa-fw fa-chevron-circle-down" data-fa-transform=rotate-270></i></div></div></div></article><div class="post-copyright mb-3 row card component" id=post-copyright><div class=card-header><h2 class=card-title>版权</h2></div><div class=card-body><a class="d-flex align-items-center flex-column" target=_blank rel="license noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh><span><i class="fab fa-fw fa-2x fa-creative-commons"></i><i class="fab fa-fw fa-2x fa-creative-commons-by"></i><i class="fab fa-fw fa-2x fa-creative-commons-nc"></i><i class="fab fa-fw fa-2x fa-creative-commons-nd"></i></span>
CC BY-NC-ND 4.0</a></div></div><div class="card component row post-comments" id=post-comments><div class=card-header><h2 class=card-title>评论</h2></div><div class=card-body><script src=https://utteranc.es/client.js repo=liubang/blog issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></div></div></div></div><aside class="col-lg-4 sidebar d-flex"><div class="container d-flex flex-column"><div class="card row text-center profile component"><div class=card-body><div class="col-12 d-flex align-items-center justify-content-center"><img class="profile-avatar rounded-circle" alt=liubang src=https://iliubang.cn/images/profile.webp loading=lazy data-viewer-invisible width=1000 height=1000></div><div class="col-12 profile-meta"><div class=profile-name>liubang</div><div class=profile-bio>Whether you are an antelope or a lion, you ought to dash forward without hesitation when the sun rise</div><div class=profile-company><i class="fas fa-fw fa-building"></i>Baidu</div><div class=profile-location><i class="fas fa-fw fa-map-marker-alt"></i>Beijing</div><nav class="social-links nav justify-content-center"><a class="nav-link social-link" href=mailto:it.liubang@gmail.com title=Email><i class="fas fa-fw fa-2x fa-envelope"></i>
</a><a class="nav-link social-link" target=_blank href=https://github.com/liubang title=GitHub rel="noopener noreferrer"><i class="fa-fw fa-2x fab fa-github"></i>
</a><a class="nav-link social-link" target=_blank href=https://weibo.com/2113750192 title=Weibo rel="noopener noreferrer"><i class="fa-fw fa-2x fab fa-weibo"></i>
</a><a class="nav-link social-link" target=_blank href=https://iliubang.cn/index.xml title=RSS rel="noopener noreferrer"><i class="fas fa-fw fa-2x fa-rss"></i></a></nav></div></div></div><div class="post-toc row mb-4 card component" id=postTOC><div class=card-header><h2 class=card-title>目录</h2></div><div class=card-body><nav id=TableOfContents><ul><li><a href=#函数调用>函数调用</a></li><li><a href=#实现自己的-call_user_func-函数>实现自己的 call_user_func 函数</a></li><li><a href=#回调函数>回调函数</a></li><li><a href=#总结>总结</a></li></ul></nav></div></div><section class="recent-posts row card component"><div class=card-header><h2 class=card-title>最近文章</h2></div><div class=card-body><ul class=post-list><li><a href=https://iliubang.cn/posts/cpp/2022-04-20-c++%E4%B8%ADunique_ptr%E7%9A%84%E4%B8%80%E4%BA%9B%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7/>C++中unique_ptr的一些使用技巧</a></li><li><a href=https://iliubang.cn/posts/cpp/2022-04-06-expression-templates/>Expression Templates</a></li><li><a href=https://iliubang.cn/posts/cpp/2022-03-23-c++%E4%B8%AD%E7%9A%84%E5%8A%A8%E6%80%81%E5%A4%9A%E6%80%81%E5%92%8C%E9%9D%99%E6%80%81%E5%A4%9A%E6%80%81/>C++中的动态多态和静态多态</a></li><li><a href=https://iliubang.cn/posts/cpp/2022-03-18-c++17-constexpr_if/>C++17:constexpr If</a></li><li><a href=https://iliubang.cn/posts/cpp/2022-03-15-c++20-designated_initializers/>C++20:Designated Initializers</a></li></ul></div></section><section class="tags-taxonomies row card component"><div class=card-header><h2 class=card-title><a href=https://iliubang.cn/tags>标签</a></h2></div><div class=card-body><div class=py-2><a href=https://iliubang.cn/tags/c++/ class="badge rounded post-taxonomy" title=c++>c++<span class="badge badge-sm text-white bg-accent ms-1">15</span></a><a href=https://iliubang.cn/tags/c/ class="badge rounded post-taxonomy" title=c>
c<span class="badge badge-sm text-white bg-accent ms-1">14</span></a><a href=https://iliubang.cn/tags/php/ class="badge rounded post-taxonomy" title=php>
php<span class="badge badge-sm text-white bg-accent ms-1">8</span></a><a href=https://iliubang.cn/tags/sp/ class="badge rounded post-taxonomy" title=sp>
sp<span class="badge badge-sm text-white bg-accent ms-1">5</span></a><a href=https://iliubang.cn/tags/java/ class="badge rounded post-taxonomy" title=Java>
Java<span class="badge badge-sm text-white bg-accent ms-1">3</span></a><a href=https://iliubang.cn/tags/jni/ class="badge rounded post-taxonomy" title=JNI>
JNI<span class="badge badge-sm text-white bg-accent ms-1">3</span></a><a href=https://iliubang.cn/tags/c++17/ class="badge rounded post-taxonomy" title=c++17>
c++17<span class="badge badge-sm text-white bg-accent ms-1">2</span></a><a href=https://iliubang.cn/tags/compiler/ class="badge rounded post-taxonomy" title=compiler>
compiler<span class="badge badge-sm text-white bg-accent ms-1">2</span></a><a href=https://iliubang.cn/tags/template/ class="badge rounded post-taxonomy" title=template>
template<span class="badge badge-sm text-white bg-accent ms-1">2</span></a><a href=https://iliubang.cn/tags/algorithm/ class="badge rounded post-taxonomy" title=algorithm>
algorithm<span class="badge badge-sm text-white bg-accent ms-1">1</span></a><a href=https://iliubang.cn/tags class="badge rounded post-taxonomy" title=ALL>
ALL
<span class="badge badge-sm text-white bg-accent ms-1">18</span></a></div></div></section></div></aside></div></main><footer class="footer mt-auto py-3 text-center container"><nav class="social-links nav justify-content-center mb-2"><a class="nav-link social-link" href=mailto:it.liubang@gmail.com title=Email><i class="fas fa-fw fa-2x fa-envelope"></i>
</a><a class="nav-link social-link" target=_blank href=https://github.com/liubang title=GitHub rel="noopener noreferrer"><i class="fa-fw fa-2x fab fa-github"></i>
</a><a class="nav-link social-link" target=_blank href=https://weibo.com/2113750192 title=Weibo rel="noopener noreferrer"><i class="fa-fw fa-2x fab fa-weibo"></i>
</a><a class="nav-link social-link" target=_blank href=https://iliubang.cn/index.xml title=RSS rel="noopener noreferrer"><i class="fas fa-fw fa-2x fa-rss"></i></a></nav><div class="copyright mb-2">Copyright © 2016-2022 LiuBang. All Rights Reserved.</div><div class="powered-by mb-2">Powered by <a href=https://gohugo.io target=_blank rel="noopener noreferrer">Hugo</a> and the <a href=https://github.com/razonyang/hugo-theme-bootstrap target=_blank rel="noopener noreferrer">Bootstrap</a> theme.</div></footer><script src=https://iliubang.cn/assets/main/bundle.min.8f94c2fa1124082d9a7ff65edc98c4bac4f60d55aca61e777d6db0677b496240.js integrity="sha256-j5TC+hEkCC2af/Ze3JjEusT2DVWsph53fW2wZ3tJYkA=" crossorigin=anonymous defer></script><script src=https://iliubang.cn/assets/icons/bundle.min.03b7941a392c422ce1f92ac21024a6a320121d4ae3b2768fb4eb63480b4cf3e2.js integrity="sha256-A7eUGjksQizh+SrCECSmoyASHUrjsnaPtOtjSAtM8+I=" crossorigin=anonymous defer></script>
<script>"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("https://iliubang.cn/service-worker.min.js").then(function(e){console.log("Successfully registered service worker",e)}).catch(function(e){console.warn("Error whilst registering service worker",e)})})</script><script src=https://iliubang.cn/assets/viewer/bundle.min.5ad926b46749e67285f66e2fdbc2d7cfb2689e8d9f2fcc2f59c3f51d2a1c4506.js integrity="sha256-WtkmtGdJ5nKF9m4v28LXz7Jono2fL8wvWcP1HSocRQY=" crossorigin=anonymous defer></script><script defer src=https://iliubang.cn/assets/katex/bundle.min.7e6e7bd0e6802486a45fec89ada58495aee2fe47c13244ef388ee649639f8883.js integrity="sha256-fm570OaAJIakX+yJraWEla7i/kfBMkTvOI7mSWOfiIM=" crossorigin=anonymous></script>
<script defer src=https://iliubang.cn/assets/mermaid/bundle.min.e0678d67a61d9ab297dc3f1de9ca8e43614ce49e9e0d310b80787e532fca37a1.js integrity="sha256-4GeNZ6YdmrKX3D8d6cqOQ2FM5J6eDTELgHh+Uy/KN6E=" crossorigin=anonymous></script>
<script async src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-5e89c5f05bb0c6ec"></script></body></html>