<!doctype html><html class=position-relative itemscope itemtype=https://schema.org/WebPage lang=zh-cn data-bs-theme=auto data-palette=blue-gray><head><script src=/assets/init/bundle.min.3aac6fdc59d24956ee10b0a524edba606f184724055d1add5c1c76d19731279f.js integrity="sha256-Oqxv3FnSSVbuELClJO26YG8YRyQFXRrdXBx20ZcxJ58=" crossorigin=anonymous></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>PHP扩展开发之call_user_func原理和回调函数的实现 - liubang's blog</title>
<link rel=icon href=/favicon_hu8740105591289948032.png sizes=16x16 type=image/png><link rel=icon href=/favicon_hu17524450719221119378.png sizes=32x32 type=image/png><link rel=icon href=/favicon_hu6335998499482997850.png sizes=150x150 type=image/png><link rel=apple-touch-icon href=/favicon_hu6806785673370764256.png sizes=180x180 type=image/png><link rel=icon href="https://iliubang.cn/images/icons/icon-192x192.png?version=5675e36f11a529bcbecb4e1fae90c416" sizes=192x192><link rel=mask-icon href=/safari-pinned-tab.svg color=#6f42c1><link rel=icon href="https://iliubang.cn/images/icons/favicon.ico?version=93c96d13551a46e5742ae6da86026661"><meta name=keywords content="c++,java,go,kv,storage"><meta name=description content="函数调用
很多时候，我们需要通过函数名来调用函数，并传递参数，或者把匿名函数作为函数的参数传递，实现回调。当我们在遇到这样的需求的时候，用 php 代码实现起来肯定是非常容易和简单的。但是，当我们在用 c 语言编写 php 扩展的时候，如何来实现这样的功能呢？下面就一起来深入了解 php 内核，看看如何实现。
在 Zend 引擎中，给我们提供了zend_call_function,call_user_function以及call_user_function_ex函数来帮助我们实现函数调用。在zend_API.h文件中，我们可以看到如下函数原型的声明：

ZEND_API int zend_call_function(zend_fcall_info *fci, zend_fcall_info_cache *fci_cache TSRMLS_DC);
ZEND_API int call_user_function(HashTable *function_table, zval **object_pp, zval *function_name, zval *retval_ptr, zend_uint param_count, zval *params[] TSRMLS_DC);
ZEND_API int call_user_function_ex(HashTable *function_table, zval **object_pp, zval *function_name, zval **retval_ptr_ptr, zend_uint param_count, zval **params[], int no_separation, HashTable *symbol_table TSRMLS_DC);
从函数的参数上来看，显然zend_call_function需要的参数很少，而其他两个都需要一堆参数，所以，我们可能会想，达到相同的效果为什么参数上有如此大的区别，于是带着这个疑问我们来解刨zend_fcall_info结构体。同样在zend_API.h中会看到如下结构体的定义：
typedef struct _zend_fcall_info {
        size_t size;
        HashTable *function_table; //函数表
        zval *function_name;	   //函数，可以是函数名，也可以直接是匿名函数本身
        HashTable *symbol_table;   //符号表
        zval **retval_ptr_ptr;	   //返回值
        zend_uint param_count;     //参数个数
        zval ***params; 		   //参数，数组
        zval *object_ptr;		   //调用对象方法时候需要传调用的对象
        zend_bool no_separation;
} zend_fcall_info;
不难发现，原来是把相关字段封装到了结构体中了，所以显得参数数量少，实际上该有的都有。
对于call_user_function中相关参数含义的解释，这里就不强行翻译了，引用官方的一段话，虽然是英文，但是我相信聪明的你也肯定能看懂的！

User functions can be called with the function call_user_function_ex(). It requires a hash value for the function table you want to access, a pointer to an object (if you want to call a method), the function name, return value, number of arguments, argument array, and a flag indicating whether you want to perform zval separation.
Note that you don&rsquo;t have to specify both function_table and object; either will do. If you want to call a method, you have to supply the object that contains this method, in which case call_user_function()automatically sets the function table to this object&rsquo;s function table. Otherwise, you only need to specify function_table and can set object to NULL.
Next is the parameter count as integer and an array containing all necessary parameters. The last argument specifies whether the function should perform zval separation - this should always be set to 0. If set to 1, the function consumes less memory but fails if any of the parameters need separation."><meta name=robots content="index, follow"><meta name=twitter:card content="summary"><meta name=twitter:title content="PHP扩展开发之call_user_func原理和回调函数的实现"><meta name=twitter:description content="函数调用 很多时候，我们需要通过函数名来调用函数，并传递参数，或者把匿名函数作为函数的参数传递，实现回调。当我们在遇到这样的需求的时候，用 php 代码实现起来肯定是非常容易和简单的。但是，当我们在用 c 语言编写 php 扩展的时候，如何来实现这样的功能呢？下面就一起来深入了解 php 内核，看看如何实现。
在 Zend 引擎中，给我们提供了zend_call_function,call_user_function以及call_user_function_ex函数来帮助我们实现函数调用。在zend_API.h文件中，我们可以看到如下函数原型的声明：
ZEND_API int zend_call_function(zend_fcall_info *fci, zend_fcall_info_cache *fci_cache TSRMLS_DC); ZEND_API int call_user_function(HashTable *function_table, zval **object_pp, zval *function_name, zval *retval_ptr, zend_uint param_count, zval *params[] TSRMLS_DC); ZEND_API int call_user_function_ex(HashTable *function_table, zval **object_pp, zval *function_name, zval **retval_ptr_ptr, zend_uint param_count, zval **params[], int no_separation, HashTable *symbol_table TSRMLS_DC); 从函数的参数上来看，显然zend_call_function需要的参数很少，而其他两个都需要一堆参数，所以，我们可能会想，达到相同的效果为什么参数上有如此大的区别，于是带着这个疑问我们来解刨zend_fcall_info结构体。同样在zend_API.h中会看到如下结构体的定义：
typedef struct _zend_fcall_info { size_t size; HashTable *function_table; //函数表 zval *function_name;	//函数，可以是函数名，也可以直接是匿名函数本身 HashTable *symbol_table; //符号表 zval **retval_ptr_ptr;	//返回值 zend_uint param_count; //参数个数 zval ***params; //参数，数组 zval *object_ptr;	//调用对象方法时候需要传调用的对象 zend_bool no_separation; } zend_fcall_info; 不难发现，原来是把相关字段封装到了结构体中了，所以显得参数数量少，实际上该有的都有。
对于call_user_function中相关参数含义的解释，这里就不强行翻译了，引用官方的一段话，虽然是英文，但是我相信聪明的你也肯定能看懂的！
User functions can be called with the function call_user_function_ex(). It requires a hash value for the function table you want to access, a pointer to an object (if you want to call a method), the function name, return value, number of arguments, argument array, and a flag indicating whether you want to perform zval separation. Note that you don’t have to specify both function_table and object; either will do. If you want to call a method, you have to supply the object that contains this method, in which case call_user_function()automatically sets the function table to this object’s function table. Otherwise, you only need to specify function_table and can set object to NULL. Next is the parameter count as integer and an array containing all necessary parameters. The last argument specifies whether the function should perform zval separation - this should always be set to 0. If set to 1, the function consumes less memory but fails if any of the parameters need separation."><meta property="og:url" content="https://iliubang.cn/posts/php/2017-03-09-php%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91%E4%B9%8Bcall-user-func%E5%8E%9F%E7%90%86%E5%92%8C%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%9E%E7%8E%B0/"><meta property="og:site_name" content="liubang's blog"><meta property="og:title" content="PHP扩展开发之call_user_func原理和回调函数的实现"><meta property="og:description" content="函数调用 很多时候，我们需要通过函数名来调用函数，并传递参数，或者把匿名函数作为函数的参数传递，实现回调。当我们在遇到这样的需求的时候，用 php 代码实现起来肯定是非常容易和简单的。但是，当我们在用 c 语言编写 php 扩展的时候，如何来实现这样的功能呢？下面就一起来深入了解 php 内核，看看如何实现。
在 Zend 引擎中，给我们提供了zend_call_function,call_user_function以及call_user_function_ex函数来帮助我们实现函数调用。在zend_API.h文件中，我们可以看到如下函数原型的声明：
ZEND_API int zend_call_function(zend_fcall_info *fci, zend_fcall_info_cache *fci_cache TSRMLS_DC); ZEND_API int call_user_function(HashTable *function_table, zval **object_pp, zval *function_name, zval *retval_ptr, zend_uint param_count, zval *params[] TSRMLS_DC); ZEND_API int call_user_function_ex(HashTable *function_table, zval **object_pp, zval *function_name, zval **retval_ptr_ptr, zend_uint param_count, zval **params[], int no_separation, HashTable *symbol_table TSRMLS_DC); 从函数的参数上来看，显然zend_call_function需要的参数很少，而其他两个都需要一堆参数，所以，我们可能会想，达到相同的效果为什么参数上有如此大的区别，于是带着这个疑问我们来解刨zend_fcall_info结构体。同样在zend_API.h中会看到如下结构体的定义：
typedef struct _zend_fcall_info { size_t size; HashTable *function_table; //函数表 zval *function_name;	//函数，可以是函数名，也可以直接是匿名函数本身 HashTable *symbol_table; //符号表 zval **retval_ptr_ptr;	//返回值 zend_uint param_count; //参数个数 zval ***params; //参数，数组 zval *object_ptr;	//调用对象方法时候需要传调用的对象 zend_bool no_separation; } zend_fcall_info; 不难发现，原来是把相关字段封装到了结构体中了，所以显得参数数量少，实际上该有的都有。
对于call_user_function中相关参数含义的解释，这里就不强行翻译了，引用官方的一段话，虽然是英文，但是我相信聪明的你也肯定能看懂的！
User functions can be called with the function call_user_function_ex(). It requires a hash value for the function table you want to access, a pointer to an object (if you want to call a method), the function name, return value, number of arguments, argument array, and a flag indicating whether you want to perform zval separation. Note that you don’t have to specify both function_table and object; either will do. If you want to call a method, you have to supply the object that contains this method, in which case call_user_function()automatically sets the function table to this object’s function table. Otherwise, you only need to specify function_table and can set object to NULL. Next is the parameter count as integer and an array containing all necessary parameters. The last argument specifies whether the function should perform zval separation - this should always be set to 0. If set to 1, the function consumes less memory but fails if any of the parameters need separation."><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-03-09T00:00:00+00:00"><meta property="article:modified_time" content="2017-03-09T00:00:00+00:00"><meta property="article:tag" content="C"><meta property="article:tag" content="Php"><meta itemprop=name content="PHP扩展开发之call_user_func原理和回调函数的实现"><meta itemprop=description content="函数调用 很多时候，我们需要通过函数名来调用函数，并传递参数，或者把匿名函数作为函数的参数传递，实现回调。当我们在遇到这样的需求的时候，用 php 代码实现起来肯定是非常容易和简单的。但是，当我们在用 c 语言编写 php 扩展的时候，如何来实现这样的功能呢？下面就一起来深入了解 php 内核，看看如何实现。
在 Zend 引擎中，给我们提供了zend_call_function,call_user_function以及call_user_function_ex函数来帮助我们实现函数调用。在zend_API.h文件中，我们可以看到如下函数原型的声明：
ZEND_API int zend_call_function(zend_fcall_info *fci, zend_fcall_info_cache *fci_cache TSRMLS_DC); ZEND_API int call_user_function(HashTable *function_table, zval **object_pp, zval *function_name, zval *retval_ptr, zend_uint param_count, zval *params[] TSRMLS_DC); ZEND_API int call_user_function_ex(HashTable *function_table, zval **object_pp, zval *function_name, zval **retval_ptr_ptr, zend_uint param_count, zval **params[], int no_separation, HashTable *symbol_table TSRMLS_DC); 从函数的参数上来看，显然zend_call_function需要的参数很少，而其他两个都需要一堆参数，所以，我们可能会想，达到相同的效果为什么参数上有如此大的区别，于是带着这个疑问我们来解刨zend_fcall_info结构体。同样在zend_API.h中会看到如下结构体的定义：
typedef struct _zend_fcall_info { size_t size; HashTable *function_table; //函数表 zval *function_name;	//函数，可以是函数名，也可以直接是匿名函数本身 HashTable *symbol_table; //符号表 zval **retval_ptr_ptr;	//返回值 zend_uint param_count; //参数个数 zval ***params; //参数，数组 zval *object_ptr;	//调用对象方法时候需要传调用的对象 zend_bool no_separation; } zend_fcall_info; 不难发现，原来是把相关字段封装到了结构体中了，所以显得参数数量少，实际上该有的都有。
对于call_user_function中相关参数含义的解释，这里就不强行翻译了，引用官方的一段话，虽然是英文，但是我相信聪明的你也肯定能看懂的！
User functions can be called with the function call_user_function_ex(). It requires a hash value for the function table you want to access, a pointer to an object (if you want to call a method), the function name, return value, number of arguments, argument array, and a flag indicating whether you want to perform zval separation. Note that you don’t have to specify both function_table and object; either will do. If you want to call a method, you have to supply the object that contains this method, in which case call_user_function()automatically sets the function table to this object’s function table. Otherwise, you only need to specify function_table and can set object to NULL. Next is the parameter count as integer and an array containing all necessary parameters. The last argument specifies whether the function should perform zval separation - this should always be set to 0. If set to 1, the function consumes less memory but fails if any of the parameters need separation."><meta itemprop=datePublished content="2017-03-09T00:00:00+00:00"><meta itemprop=dateModified content="2017-03-09T00:00:00+00:00"><meta itemprop=wordCount content="699"><meta itemprop=keywords content="C,Php"><meta property="og:image" content="https://iliubang.cn/images/apple-touch-icon.png"><meta name=twitter:image content="https://iliubang.cn/images/apple-touch-icon.png"><meta property="og:image:alt" content="PHP扩展开发之call_user_func原理和回调函数的实现"><meta name=twitter:image:alt content="PHP扩展开发之call_user_func原理和回调函数的实现"><link rel=manifest href=/manifest.json><link data-precache rel=stylesheet href="/assets/main/bundle.min.6e178270a4ff001c8a4de394b4de46a913e45e3897a8bffdd1fdd42a2fec1c18.css" integrity="sha256-bheCcKT/AByKTeOUtN5GqRPkXjiXqL/90f3UKi/sHBg=" crossorigin=anonymous><link data-precache rel=stylesheet href=/assets/katex/bundle.min.0e62515e6b767fdcffc08f3d4ab9197f6849689a486b42ab0c98b5e7732e1f58.css integrity="sha256-DmJRXmt2f9z/wI89SrkZf2hJaJpIa0KrDJi153MuH1g=" crossorigin=anonymous><link data-precache rel=stylesheet href=/assets/viewer/bundle.min.16d2c85c4cae39a98f8cb7a977e95e554b174f91a5484c32605637156f49ca6b.css integrity="sha256-FtLIXEyuOamPjLepd+leVUsXT5GlSEwyYFY3FW9Jyms=" crossorigin=anonymous></head><body><header class="mb-4 sticky-top"><nav class="top-app-bar shadow navbar navbar-expand-xxl"><div class=container><a class="navbar-brand d-flex align-items-center flex-grow-1 flex-xxl-grow-0 justify-content-xxl-start ms-2 ms-xxl-0 mx-auto me-xxl-2" href=https://iliubang.cn/><picture><img class=logo alt=Logo src="https://iliubang.cn/images/apple-touch-icon.png?v=7fdc4e1b5785be32c88d453deb32ca63" loading=lazy width=180 height=180>
</picture>HIGHKYCK</a><div class="offcanvas-xxl offcanvas-end flex-grow-1" data-bs-scroll=true tabindex=-1 id=navbarMenus aria-labelledby=navbarMenusLabel><div class="offcanvas-header px-4 pb-0"><div class="offcanvas-title h5" id=navbarMenusLabel>HIGHKYCK</div><button type=button class="btn-close btn-close-white" data-bs-dismiss=offcanvas data-bs-target=#navbarMenus aria-label=Close></button></div><div class="offcanvas-body p-4 pt-0 p-xxl-0"><hr class=d-xxl-none><ul class="navbar-nav flex-row flex-wrap align-items-center me-auto"><li class="nav-item col-6 col-xxl-auto"><a class="nav-link py-2 px-0 px-xxl-2" href=https://iliubang.cn/archives/><i class="fas fa-fw fa-file-archive"></i>归档</a></li><li class="nav-item col-12 col-xxl-auto dropdown px-0"><a href=# class="nav-link dropdown-toggle" id=navbarDropdownCategories role=button data-bs-toggle=dropdown aria-expanded=false><i class="fas fa-fw fa-folder"></i>分类</a><ul class="dropdown-menu dropdown-menu-end" aria-labelledby=navbarDropdownCategories data-bs-popper=none><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=https://iliubang.cn/categories/programming><i class="fas fa-fw fa-code me-1"></i><div class=dropdown-item-content><p class="dropdown-item-title mb-0">Programing</p></div></a></li><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=https://iliubang.cn/categories/reading><i class="fas fa-fw fa-book-reader me-1"></i><div class=dropdown-item-content><p class="dropdown-item-title mb-0">Reading</p></div></a></li><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=https://iliubang.cn/categories/linux><i class="fab fa-fw fa-linux me-1"></i><div class=dropdown-item-content><p class="dropdown-item-title mb-0">Linux</p></div></a></li><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=https://iliubang.cn/categories><i class="fas fa-fw fa-folder me-1"></i><div class=dropdown-item-content><p class="dropdown-item-title mb-0">所有分类</p></div></a></li></ul></li><li class="nav-item col-12 col-xxl-auto dropdown px-0"><a href=# class="nav-link dropdown-toggle" id=navbarDropdownTags role=button data-bs-toggle=dropdown aria-expanded=false><i class="fas fa-fw fa-tags me-1"></i>标签</a><ul class="dropdown-menu dropdown-menu-end" aria-labelledby=navbarDropdownTags data-bs-popper=none><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=https://iliubang.cn/tags/algorithm><i class="fas fa-fw fa-square-root-alt me-1"></i><div class=dropdown-item-content><p class="dropdown-item-title mb-0">Algorithm</p></div></a></li><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=https://iliubang.cn/tags/c++><i class="fab fa-fw fa-google me-1"></i><div class=dropdown-item-content><p class="dropdown-item-title mb-0">C++</p></div></a></li><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=https://iliubang.cn/tags/go><i class="fab fa-fw fa-google me-1"></i><div class=dropdown-item-content><p class="dropdown-item-title mb-0">Go</p></div></a></li><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=https://iliubang.cn/tags/java><i class="fab fa-fw fa-java me-1"></i><div class=dropdown-item-content><p class="dropdown-item-title mb-0">Java</p></div></a></li><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=https://iliubang.cn/tags/storage><i class="fas fa-fw fa-database me-1"></i><div class=dropdown-item-content><p class="dropdown-item-title mb-0">Storage</p></div></a></li><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=https://iliubang.cn/tags><i class="fas fa-fw fa-tags me-1"></i><div class=dropdown-item-content><p class="dropdown-item-title mb-0">所有标签</p></div></a></li></ul></li><li class="nav-item col-12 col-xxl-auto dropdown px-0"><a href=# class="nav-link dropdown-toggle" id=navbarDropdownSeries role=button data-bs-toggle=dropdown aria-expanded=false><i class="fas fa-fw fa-columns me-1"></i>专栏</a><ul class="dropdown-menu dropdown-menu-end" aria-labelledby=navbarDropdownSeries data-bs-popper=none><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=https://iliubang.cn/leetcode/><div class=dropdown-item-content><p class="dropdown-item-title mb-0">LeetCode</p></div></a></li></ul></li></ul><hr class=d-xxl-none><form class="search-bar ms-auto my-auto" action=/search/ novalidate><div class="input-group align-items-center"><span class="btn btn-search disabled position-absolute left-0 border-0 px-1"><i class="fas fa-fw fa-search fa-lg"></i>
</span><input class="my-1 form-control border-white rounded-5 search-input bg-body" name=q type=search placeholder=搜索 aria-label=Search required>
<span class="search-shortcut position-absolute end-0 top-0 me-2"><kbd class="text-dark bg-white opacity-75 rounded-3 shadow border border-primary py-1 fw-bold">/</kbd></span></div></form><hr class=d-xxl-none><ul class="navbar-nav flex-row flex-wrap align-items-center ms-md-auto"><li class="nav-item py-2 py-xxl-1 col-12 col-xxl-auto"><nav class="social-links nav justify-content-center flex-row"><a class="nav-link social-link col-6 col-xxl-auto p-1" target=_blank href=https://github.com/liubang title=GitHub rel=me><i class="fa-fw fab fa-github"></i>
<span class="ms-1 d-xxl-none">Github</span>
</a><a class="nav-link social-link col-6 col-xxl-auto p-1" target=_blank href=/index.xml title=RSS rel=me><i class="fas fa-fw fa-rss"></i>
<span class="ms-1 d-xxl-none">RSS</span></a></nav></li><li class="nav-item py-2 py-xxl-1 col-12 col-xxl-auto"><div class="vr d-none d-xxl-flex h-100 mx-xxl-2 text-white"></div><hr class="d-xxl-none my-2"></li><li class="nav-item dropdown py-1 py-xxl-1 col-6 col-xxl-auto"><a class="nav-link px-0 px-xxl-1" href=# id=languageDropdown role=button data-bs-toggle=dropdown aria-expanded=false><i class="fas fa-fw fa-globe"></i>
<span class=d-xxl-none>语言</span></a><ul class="language-dropdown-menu dropdown-menu dropdown-menu-end" aria-labelledby=languageDropdown><li><a class=dropdown-item href=/en/>English</a></li><li><a class="dropdown-item active" href=/>简体中文</a></li></ul></li><li class="nav-item py-1 col-12 col-xxl-auto"><div class="vr d-none d-xxl-flex h-100 mx-xxl-2 text-white"></div><hr class="d-xxl-none my-2"></li><li class="nav-item dropdown col-6 col-xxl-auto"><a class="nav-link px-0 py-2 px-xxl-1" href=# id=modeDropdown role=button data-bs-toggle=dropdown aria-expanded=false><i class="mode-icon fas fa-fw fa-adjust" id=modeIcon></i>
<span class=d-xxl-none>模式</span></a><ul class="mode-dropdown-menu dropdown-menu dropdown-menu-end" aria-labelledby=modeDropdown><li class=mode-item data-color-mode=light data-icon=sun><button class=dropdown-item>
<i class="mode-icon fas fa-fw fa-sun"></i> 浅色</button></li><li class=mode-item data-color-mode=dark data-icon=moon><button class=dropdown-item>
<i class="mode-icon fas fa-fw fa-moon"></i> 深色</button></li><li class="mode-item active" data-color-mode=auto data-icon=adjust><button class=dropdown-item>
<i class="mode-icon fas fa-fw fa-adjust"></i> 自动</button></li></ul></li></ul></div></div><div class=d-flex><button class="navbar-toggler order-5 border-0" type=button data-bs-toggle=offcanvas data-bs-target=#navbarMenus aria-controls=navbarMenus aria-expanded=false aria-label="Toggle navigation">
<i class="fas fa-ellipsis-h"></i></button></div></div></nav></header><main class="container has-sidebar" data-kind=page><script data-precache src=/js/main-init.0bc77d87a23c00bf13103713a9283c4a18b7b2c357dc12e3b6973058baecbfe1.js integrity="sha256-C8d9h6I8AL8TEDcTqSg8Shi3ssNX3BLjtpcwWLrsv+E=" crossorigin=anonymous></script><div class="row content"><noscript><div class="alert alert-danger" role=alert>你的浏览器不支持 JavaScript。</div></noscript><div class="content-posts col-xxl-8"><div class=container><nav class="row card component" aria-label=breadcrumb><div class="card-body pb-0"><ol class="hbs-breadcrumb breadcrumb flex-nowrap"><li class="breadcrumb-item text-surface"><a href=/>主页</a></li><li class="breadcrumb-item text-surface"><a href=/posts/>文章</a></li><li class="breadcrumb-item active">PHP扩展开发之call_user_func原理和回调函数的实现</li></ol></div></nav><div class="post-panel-wrapper position-relative d-flex justify-content-center"><div class="d-flex flex-row justify-content-center rounded-5 border post-panel position-fixed px-3 py-1 surface shadow-1"><a class="action btn-reward" role=button data-bs-toggle=modal data-bs-target=#rewardModal title=打赏><i class="fas fa-fw fa-coffee"></i>
</a><a class="action action-toc d-none d-xxl-block" href=#postTOC role=button title=目录><i class="fas fa-fw fa-list-alt"></i>
</a><a class="action action-toc d-block d-xxl-none" href=#post-toc-container role=button title=目录><i class="fas fa-fw fa-list-alt"></i>
</a><a class="action action-copyright" href=#post-copyright role=button aria-label=Copyright title=版权><i class="fas fa-fw fa-copyright"></i>
</a><a class="action action-post-comments" href=#post-comments role=button aria-label=Comments title=评论><i class="fas fa-fw fa-comments"></i>
</a><a id=sidebarToggler class="action action-sidebar-toggler d-none d-xxl-block" role=button title=切换侧边栏><i class="fas fa-fw fa-expand-alt" data-fa-transform=rotate-45></i></a></div></div><article class="row card component mb-4 post"><div class=card-header><h1 class="card-title post-title my-2">PHP扩展开发之call_user_func原理和回调函数的实现</h1></div><div class=card-body><div class="post-meta mb-3"><span class="post-date me-1 mb-1" title="创建于 2017-03-09 00:00:00 +0000 UTC。">March 9, 2017</span><span class="post-reading-time me-1 mb-1">4 分钟阅读</span><a href=/authors/liubang/ class="btn btn-sm btn-secondary mb-1 me-2 py-0 pe-1 post-taxonomy post-taxonomy-sm post-author">
<i class="fas fa-fw fa-user me-1"></i>Liu Bang</a><a href=/categories/programming/ class="btn btn-sm btn-secondary mb-1 me-2 py-0 pe-1 post-taxonomy post-taxonomy-sm post-category">
<i class="fas fa-fw fa-folder me-1"></i>Programming</a><a href=/tags/c/ class="btn btn-sm btn-secondary mb-1 me-2 py-0 pe-1 post-taxonomy post-taxonomy-sm post-tag">C</a><a href=/tags/php/ class="btn btn-sm btn-secondary mb-1 me-2 py-0 pe-1 post-taxonomy post-taxonomy-sm post-tag">Php</a></div><div class="mt-2 mb-3 d-block d-xxl-none"><h2 class="text-surface mb-3">目录</h2><div id=post-toc-container></div><hr class=text-secondary></div><div class="post-content mb-3" data-bs-spy=scroll data-bs-target=#TableOfContents tabindex=0><div id=post-content-body><h2 id=函数调用 data-numberify>函数调用<a class="anchor ms-1" href=#函数调用></a></h2><p>很多时候，我们需要通过函数名来调用函数，并传递参数，或者把匿名函数作为函数的参数传递，实现回调。当我们在遇到这样的需求的时候，用 php 代码实现起来肯定是非常容易和简单的。但是，当我们在用 c 语言编写 php 扩展的时候，如何来实现这样的功能呢？下面就一起来深入了解 php 内核，看看如何实现。</p><p>在 Zend 引擎中，给我们提供了<code>zend_call_function</code>,<code>call_user_function</code>以及<code>call_user_function_ex</code>函数来帮助我们实现函数调用。在<code>zend_API.h</code>文件中，我们可以看到如下函数原型的声明：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>ZEND_API <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>zend_call_function</span>(zend_fcall_info <span style=color:#f92672>*</span>fci, zend_fcall_info_cache <span style=color:#f92672>*</span>fci_cache TSRMLS_DC);
</span></span><span style=display:flex><span>ZEND_API <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>call_user_function</span>(HashTable <span style=color:#f92672>*</span>function_table, zval <span style=color:#f92672>**</span>object_pp, zval <span style=color:#f92672>*</span>function_name, zval <span style=color:#f92672>*</span>retval_ptr, zend_uint param_count, zval <span style=color:#f92672>*</span>params[] TSRMLS_DC);
</span></span><span style=display:flex><span>ZEND_API <span style=color:#66d9ef>int</span> <span style=color:#a6e22e>call_user_function_ex</span>(HashTable <span style=color:#f92672>*</span>function_table, zval <span style=color:#f92672>**</span>object_pp, zval <span style=color:#f92672>*</span>function_name, zval <span style=color:#f92672>**</span>retval_ptr_ptr, zend_uint param_count, zval <span style=color:#f92672>**</span>params[], <span style=color:#66d9ef>int</span> no_separation, HashTable <span style=color:#f92672>*</span>symbol_table TSRMLS_DC);
</span></span></code></pre></div><p>从函数的参数上来看，显然<code>zend_call_function</code>需要的参数很少，而其他两个都需要一堆参数，所以，我们可能会想，达到相同的效果为什么参数上有如此大的区别，于是带着这个疑问我们来解刨<code>zend_fcall_info</code>结构体。同样在<code>zend_API.h</code>中会看到如下结构体的定义：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> _zend_fcall_info {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>size_t</span> size;
</span></span><span style=display:flex><span>        HashTable <span style=color:#f92672>*</span>function_table; <span style=color:#75715e>//函数表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        zval <span style=color:#f92672>*</span>function_name;	   <span style=color:#75715e>//函数，可以是函数名，也可以直接是匿名函数本身
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        HashTable <span style=color:#f92672>*</span>symbol_table;   <span style=color:#75715e>//符号表
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        zval <span style=color:#f92672>**</span>retval_ptr_ptr;	   <span style=color:#75715e>//返回值
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        zend_uint param_count;     <span style=color:#75715e>//参数个数
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        zval <span style=color:#f92672>***</span>params; 		   <span style=color:#75715e>//参数，数组
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        zval <span style=color:#f92672>*</span>object_ptr;		   <span style=color:#75715e>//调用对象方法时候需要传调用的对象
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>        zend_bool no_separation;
</span></span><span style=display:flex><span>} zend_fcall_info;
</span></span></code></pre></div><p>不难发现，原来是把相关字段封装到了结构体中了，所以显得参数数量少，实际上该有的都有。</p><p>对于<code>call_user_function</code>中相关参数含义的解释，这里就不强行翻译了，引用官方的一段话，虽然是英文，但是我相信聪明的你也肯定能看懂的！</p><blockquote><p>User functions can be called with the function call_user_function_ex(). It requires a hash value for the function table you want to access, a pointer to an object (if you want to call a method), the function name, return value, number of arguments, argument array, and a flag indicating whether you want to perform zval separation.
Note that you don&rsquo;t have to specify both function_table and object; either will do. If you want to call a method, you have to supply the object that contains this method, in which case call_user_function()automatically sets the function table to this object&rsquo;s function table. Otherwise, you only need to specify function_table and can set object to NULL.
Next is the parameter count as integer and an array containing all necessary parameters. The last argument specifies whether the function should perform zval separation - this should always be set to 0. If set to 1, the function consumes less memory but fails if any of the parameters need separation.</p></blockquote><h2 id=实现自己的-call_user_func-函数 data-numberify>实现自己的 call_user_func 函数<a class="anchor ms-1" href=#实现自己的-call_user_func-函数></a></h2><p>废话不多说，下面就来动手实现一个自己的<code>call_user_func</code>函数;
这个函数是一个比较特殊的函数，因为他除了第一个参数是一个字符串之外，剩余的参数都是可变参数，而且没有固定的个数，所以想到这里是不是发现又遇到了一些小小的困难。不过没关系，遇到一切问题首先要想到查阅官方文档，于是在<a href=http://php.net/manual/en/internals2.funcs.php target=_blank rel="noopener noreferrer">php 官方文档<i class="fas fa-external-link-square-alt ms-1"></i></a>中找到了答案，在该文档页中，向我们列举了所有的 Type Specifiers:</p><table><thead><tr><th style=text-align:left>Spec</th><th style=text-align:left>Type</th><th style=text-align:left>Locals</th></tr></thead><tbody><tr><td style=text-align:left>a</td><td style=text-align:left>array</td><td style=text-align:left>zval*</td></tr><tr><td style=text-align:left>A</td><td style=text-align:left>array or object</td><td style=text-align:left>zval*</td></tr><tr><td style=text-align:left>b</td><td style=text-align:left>boolean</td><td style=text-align:left>zend_bool</td></tr><tr><td style=text-align:left>C</td><td style=text-align:left>class</td><td style=text-align:left>zend_class_entry*</td></tr><tr><td style=text-align:left>d</td><td style=text-align:left>double</td><td style=text-align:left>double</td></tr><tr><td style=text-align:left>f</td><td style=text-align:left>function</td><td style=text-align:left>zend_fcall_info*, zend_fcall_info_cache*</td></tr><tr><td style=text-align:left>h</td><td style=text-align:left>array</td><td style=text-align:left>HashTable*</td></tr><tr><td style=text-align:left>H</td><td style=text-align:left>array or object</td><td style=text-align:left>HashTable*</td></tr><tr><td style=text-align:left>l</td><td style=text-align:left>long</td><td style=text-align:left>long</td></tr><tr><td style=text-align:left>L</td><td style=text-align:left>long(limits out-of-range LONG_MAX/LONG_MIN)</td><td style=text-align:left>long</td></tr><tr><td style=text-align:left>o</td><td style=text-align:left>object</td><td style=text-align:left>zval*</td></tr><tr><td style=text-align:left>O</td><td style=text-align:left>object(of specified zend_class_entry)</td><td style=text-align:left>zval*, zend_class_entry *</td></tr><tr><td style=text-align:left>p</td><td style=text-align:left>string(a valid path)</td><td style=text-align:left>char*, int</td></tr><tr><td style=text-align:left>r</td><td style=text-align:left>resource</td><td style=text-align:left>zval*</td></tr><tr><td style=text-align:left>s</td><td style=text-align:left>string</td><td style=text-align:left>char*, int</td></tr><tr><td style=text-align:left>z</td><td style=text-align:left>mixed</td><td style=text-align:left>zval*</td></tr><tr><td style=text-align:left>Z</td><td style=text-align:left>mixed</td><td style=text-align:left>zval**</td></tr></tbody></table><p>当我们看到这张表的时候只是了解到了在 php 扩展中参数传递对应关系，以及如何切当使用类型标记符，但是并没有解决我们需要传递不定长参数的问题。别着急，往下看会看到 Advanced Type Specifiers 这样的文字，是的，你没有看错，这玩意还有高级用法：</p><table><thead><tr><th style=text-align:left>Spec</th><th style=text-align:left>Description</th></tr></thead><tbody><tr><td style=text-align:left>*</td><td style=text-align:left>a variable number of argument of the preceeding type, 0 or more</td></tr><tr><td style=text-align:left>+</td><td style=text-align:left>a variable number of argument of the preceeding type, 1 or more</td></tr><tr><td style=text-align:left>$\mid$</td><td style=text-align:left>indicates that the remaining parameters are optional</td></tr><tr><td style=text-align:left>!</td><td style=text-align:left>the preceeding parameter can be of the specified type or null For &lsquo;b&rsquo;, &rsquo;l&rsquo; and &rsquo;d&rsquo;, an extra argument of type zend_bool* must be passed after the corresponding bool*, long* or double* addresses which will be set true if null is recieved.</td></tr></tbody></table><p>*，这不正是我们需要的吗！万事俱备，只欠东风，接下来，实现自己的<code>call_user_func</code>就是顺水推舟的事情了。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#a6e22e>PHP_FUNCTION</span>(demo_call_user_func)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	zend_fcall_info  fci;
</span></span><span style=display:flex><span>	zend_fcall_info_cache fci_cache;
</span></span><span style=display:flex><span>	zval <span style=color:#f92672>*</span>retval_ptr <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>zend_parse_parameters</span>(<span style=color:#a6e22e>ZEND_NUM_ARGS</span>() TSRMLS_CC, <span style=color:#e6db74>&#34;f*&#34;</span>, <span style=color:#f92672>&amp;</span>fci, <span style=color:#f92672>&amp;</span>fci_cache, <span style=color:#f92672>&amp;</span>fci.params, <span style=color:#f92672>&amp;</span>fci.param_count) <span style=color:#f92672>!=</span> SUCCESS) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	fci.retval_ptr_ptr <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>retval_ptr;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>zend_call_function</span>(<span style=color:#f92672>&amp;</span>fci, <span style=color:#f92672>&amp;</span>fci_cache TSRMLS_CC) <span style=color:#f92672>==</span> SUCCESS <span style=color:#f92672>&amp;&amp;</span> fci.retval_ptr_ptr <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>*</span>fci.retval_ptr_ptr) {
</span></span><span style=display:flex><span>		return_value <span style=color:#f92672>=</span> <span style=color:#f92672>*</span>fci.retval_ptr_ptr;
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>zval_copy_ctor</span>(return_value);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>zval_ptr_dtor</span>(<span style=color:#f92672>&amp;</span>fci.retval_ptr_ptr);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (fci.params) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>efree</span>(fci.params);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>看到这里的代码，可能有些人还是一头雾水，不太明白为什么要这么写，至此我需要声明一下，我在写这篇博客的时候假想读者都是对 php 扩展开发有过一定了解的人，至少知道如何用 c 语言写一个输出"hello world"的扩展，知道如何返回值，以及如何创建 php 中的基本数据类型，如何赋值甚至了解 php 扩展中如何开发一个类。所以呢，假如你还没有这些基础怎么办，那也没办法，建议先回去补充知识咯。</p><p>写好扩展，编译安装后我们来测试一下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>say</span>($msg) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>echo</span> $msg, <span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>demo_call_user_func</span>(<span style=color:#e6db74>&#39;say&#39;</span>, <span style=color:#e6db74>&#34;hello world&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>demo_call_user_func</span>(<span style=color:#66d9ef>function</span>($msg) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>echo</span> $msg, <span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>}, <span style=color:#e6db74>&#34;hello liubang&#34;</span>);
</span></span></code></pre></div><p>测试结果很自然的如我们所期待：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>ubuntu@vm-911:~/workspace/c/php-5.6.30/ext/demo$ php test.php
</span></span><span style=display:flex><span>hello world
</span></span><span style=display:flex><span>hello liubang
</span></span></code></pre></div><h2 id=回调函数 data-numberify>回调函数<a class="anchor ms-1" href=#回调函数></a></h2><p>有了上面的铺垫，我想到这里写一个回调函数已经是一件非常简单的事情了，只不过在<code>call_user_func</code>之前或者之后来做一些其他的操作。废话不多说，直接上代码：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#a6e22e>PHP_FUNCTION</span>(demo_callback)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	zend_fcall_info fci;
</span></span><span style=display:flex><span>	zend_fcall_info_cache fci_cache;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>zend_parse_parameters</span>(<span style=color:#a6e22e>ZEND_NUM_ARGS</span>() TSRMLS_CC, <span style=color:#e6db74>&#34;f&#34;</span>, <span style=color:#f92672>&amp;</span>fci, <span style=color:#f92672>&amp;</span>fci_cache) <span style=color:#f92672>==</span> FAILURE) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>php_printf</span>(<span style=color:#e6db74>&#34;this is callback demo...</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>php_printf</span>(<span style=color:#e6db74>&#34;start call callback function</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>	zval <span style=color:#f92672>*</span>retval_ptr <span style=color:#f92672>=</span> NULL;
</span></span><span style=display:flex><span>	fci.retval_ptr_ptr <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>retval_ptr;
</span></span><span style=display:flex><span>	zval <span style=color:#f92672>**</span>arg[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>	zval <span style=color:#f92672>*</span>param;
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MAKE_STD_ZVAL</span>(param);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ZVAL_STRING</span>(param, <span style=color:#e6db74>&#34;hello world&#34;</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	arg[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>param;
</span></span><span style=display:flex><span>	fci.param_count <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>	fci.params <span style=color:#f92672>=</span> arg;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>zend_call_function</span>(<span style=color:#f92672>&amp;</span>fci, <span style=color:#f92672>&amp;</span>fci_cache TSRMLS_CC) <span style=color:#f92672>==</span> SUCCESS <span style=color:#f92672>&amp;&amp;</span> fci.retval_ptr_ptr <span style=color:#f92672>&amp;&amp;</span> <span style=color:#f92672>*</span>fci.retval_ptr_ptr) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>COPY_PZVAL_TO_ZVAL</span>(<span style=color:#f92672>*</span>return_value, <span style=color:#f92672>*</span>fci.retval_ptr_ptr);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>以上代码所对应的 php 代码为：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>demo_callback</span>(<span style=color:#a6e22e>callable</span> $callback) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#34;this is callback demo...</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> $callback(<span style=color:#e6db74>&#34;hello world&#34;</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>下面我们编译安装后测试一下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>demo_callback</span>(<span style=color:#66d9ef>function</span>($msg) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>echo</span> $msg, <span style=color:#a6e22e>PHP_EOL</span>;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>echo</span> <span style=color:#e6db74>&#34;this is in callback function</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>});
</span></span></code></pre></div><p>执行结果如下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>ubuntu@vm-911:~/workspace/c/php-5.6.30/ext/demo$ php test.php
</span></span><span style=display:flex><span>this is callback demo...
</span></span><span style=display:flex><span>start call callback <span style=color:#66d9ef>function</span>
</span></span><span style=display:flex><span>hello world
</span></span><span style=display:flex><span>this is in callback <span style=color:#66d9ef>function</span>
</span></span></code></pre></div><p>下面我再来用<code>call_user_function_ex</code>把回调重新实现一遍，写法基本一样：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#a6e22e>PHP_FUNCTION</span>(demo_callback_o)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	zval <span style=color:#f92672>*</span>func;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>zend_parse_parameters</span>(<span style=color:#a6e22e>ZEND_NUM_ARGS</span>() TSRMLS_CC, <span style=color:#e6db74>&#34;z&#34;</span>, <span style=color:#f92672>&amp;</span>func) <span style=color:#f92672>==</span> FAILURE) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>php_printf</span>(<span style=color:#e6db74>&#34;before callback...</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>char</span> <span style=color:#f92672>*</span>func_name;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span><span style=color:#a6e22e>zend_is_callable</span>(func, <span style=color:#ae81ff>0</span>, <span style=color:#f92672>&amp;</span>func_name TSRMLS_CC)) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>php_error_docref</span>(NULL TSRMLS_CC, E_WARNING, <span style=color:#e6db74>&#34;Function: &#39;%s&#39; is not callable&#34;</span>, func_name);
</span></span><span style=display:flex><span>		RETURN_FALSE;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	zval <span style=color:#f92672>*</span>retval;
</span></span><span style=display:flex><span>	zval <span style=color:#f92672>**</span>arg[<span style=color:#ae81ff>1</span>];
</span></span><span style=display:flex><span>	zval <span style=color:#f92672>*</span>param;
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MAKE_STD_ZVAL</span>(param);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ZVAL_STRING</span>(param, <span style=color:#e6db74>&#34;hello liubang&#34;</span>, <span style=color:#ae81ff>0</span>);
</span></span><span style=display:flex><span>	arg[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>param;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>call_user_function_ex</span>(<span style=color:#a6e22e>EG</span>(function_table), NULL, func, <span style=color:#f92672>&amp;</span>retval, <span style=color:#ae81ff>1</span>, arg, <span style=color:#ae81ff>0</span>, NULL TSRMLS_CC) <span style=color:#f92672>!=</span> SUCCESS) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>php_printf</span>(<span style=color:#e6db74>&#34;callback complated!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>COPY_PZVAL_TO_ZVAL</span>(<span style=color:#f92672>*</span>return_value, retval);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>效果和上边是一样的，所以这里就不再测试了。</p><h2 id=总结 data-numberify>总结<a class="anchor ms-1" href=#总结></a></h2><p>看到这里，也许你会觉得，这东西到底有什么用呢，是的，单纯地这么来看确实没有用，可是如果你也是一个对开源代码感兴趣的人，也许你也发现了在 php 著名的开源框架<code>swoole</code>中，就有很多地方使用到了类似的技巧，不同的是，<code>swoole</code>中是把所有的回调函数注册到一张表(也就是一个 zval 的数组)中，在请求的恰当阶段再来调用，于是就有了我们看到的类似于事件驱动的效果。所以，有了这些知识，假设你已经掌握了 linux 系统下的 TCP/IP 网络编程，那么你创造一个类似于<code>swoole</code>的产品又有何难。</p></div></div><div class="modal fade" id=rewardModal tabindex=-1 aria-labelledby=rewardModalLabel aria-hidden=true><div class=modal-dialog><div class="modal-content surface"><div class=modal-header><h5 class="modal-title text-surface" id=rewardModalLabel><i class="fas fa-fw fa-coffee me-1"></i>打赏</h5><a href=# data-bs-dismiss=modal class=btn-close aria-label=Close></a></div><div class=modal-body><ul class="nav nav-tabs mb-3" role=tablist><li class="nav-item text-nowrap" role=presentation><a class="nav-link active" id=reward-alipay-tab data-bs-toggle=tab href=#reward-alipay role=tab aria-controls=reward-alipay aria-selected=true><i class="fab fa-fw fa-alipay me-1"></i>支付宝</a></li><li class="nav-item text-nowrap" role=presentation><a class=nav-link id=reward-wechat-tab data-bs-toggle=tab href=#reward-wechat role=tab aria-controls=reward-wechat aria-selected=true><i class="fab fa-fw fa-weixin me-1"></i>微信</a></li></ul><div class=tab-content id=rewardTabContent><div class="tab-pane fade post-reward-content text-center show active" id=reward-alipay role=tabpanel aria-labelledby=reward-alipay-tab><img class="img-fluid post-reward-img" src=https://iliubang.cn/images/reward/alipay.jpg loading=lazy data-viewer-invisible></div><div class="tab-pane fade post-reward-content text-center show" id=reward-wechat role=tabpanel aria-labelledby=reward-wechat-tab><img class="img-fluid post-reward-img" src=https://iliubang.cn/images/reward/wechat.jpg loading=lazy data-viewer-invisible></div></div></div></div></div></div></div><div class=card-footer><div class="post-navs d-flex justify-content-evenly"><div class="post-nav post-next"><a href=/posts/compiler/2017-03-15-%E5%9F%BA%E4%BA%8Ec%E8%AF%AD%E8%A8%80%E7%9A%84%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80%E5%BC%80%E5%8F%91/>基于c语言的编程语言开发</a>
<i class="fas fa-fw fa-chevron-down post-next-icon ms-1" data-fa-transform=rotate-270></i></div></div></div></article><div class="post-copyright mb-3 row card component" id=post-copyright><div class=card-header><h2 class="card-title fs-4 my-2 text-surface">版权</h2></div><div class=card-body><a class="d-flex align-items-center flex-column" target=_blank rel="license noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh><span><i class="fab fa-fw fa-2x fa-creative-commons"></i><i class="fab fa-fw fa-2x fa-creative-commons-by"></i><i class="fab fa-fw fa-2x fa-creative-commons-nc"></i><i class="fab fa-fw fa-2x fa-creative-commons-nd"></i></span>
CC BY-NC-ND 4.0</a></div></div><div class="card component row post-comments" id=post-comments><div class=card-header><h2 class="card-title my-2 fs-4 text-surface">评论</h2></div><div class=card-body><script src=https://utteranc.es/client.js repo=liubang/blog issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></div></div></div></div><aside class="col-xxl-4 sidebar d-flex"><div class="container d-flex flex-column"><div class="accordion profile"><div class="accordion-item card row text-center component"><div class="accordion-header card-header border-0" id=profile-header><a class="accordion-button d-lg-none mb-2 shadow-none p-0 bg-transparent text-surface collapsed" role=button data-bs-toggle=collapse href=#profile aria-expanded=false aria-controls=profile>Profile</a></div><div class="card-body collapse accordion-collapse accordion-body d-lg-block" id=profile aria-labelledby=profile-header><div class="col-12 d-flex align-items-center justify-content-center"><picture><img class="profile-avatar rounded-circle" alt=liubang src="https://iliubang.cn/images/profile.webp?v=7fdc4e1b5785be32c88d453deb32ca63" loading=lazy data-viewer-invisible width=484 height=483></picture></div><div class="col-12 profile-meta"><div class="profile-name fw-fold fs-lg">liubang</div><div class=profile-bio>Whether you are an antelope or a lion, you ought to dash forward without hesitation when the sun rise</div><div class=profile-company><i class="fas fa-fw fa-building"></i>Baidu</div><div class=profile-location><i class="fas fa-fw fa-map-marker-alt"></i>China</div><a class="profile-about text-primary" href=/about/><i class="fas fa-fw fa-user"></i>关于</a></div></div></div></div><div class="accordion taxonomies-toggle"><div class="row card component accordion-item"><div class="accordion-header card-header border-0"><a class="accordion-button d-lg-none mb-1 shadow-none p-0 bg-transparent collapsed" role=button data-bs-toggle=collapse href=#taxonomies-toggle aria-expanded=false aria-controls=taxonomies-toggle>Taxonomies</a></div><div class="card-body collapse accordion-collapse accordion-body d-lg-block" id=taxonomies-toggle><ul class="nav nav-pills nav-fill" role=tablist><li class=nav-item role=presentation><button class="nav-link active" id=taxonomyTagsTab data-bs-toggle=tab data-bs-target=#taxonomyTags type=button role=tab aria-controls=taxonomyTags aria-selected=true>
标签</button></li><li class=nav-item role=presentation><button class=nav-link id=taxonomySeriesTab data-bs-toggle=tab data-bs-target=#taxonomySeries type=button role=tab aria-controls=taxonomySeries aria-selected=true>
专栏</button></li><li class=nav-item role=presentation><button class=nav-link id=taxonomyArchivesTab data-bs-toggle=tab data-bs-target=#taxonomyArchives type=button role=tab aria-controls=taxonomyArchives aria-selected=true>
归档</button></li></ul><div class="tab-content mt-3"><div class="tab-pane active" id=taxonomyTags role=tabpanel aria-labelledby=taxonomyTagsTab tabindex=0><a href=/tags/c++/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=C++>C++
<span class="badge badge-sm text-secondary bg-white ms-1">18</span>
</a><a href=/tags/c/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=C>C
<span class="badge badge-sm text-secondary bg-white ms-1">14</span>
</a><a href=/tags/php/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=Php>Php
<span class="badge badge-sm text-secondary bg-white ms-1">8</span>
</a><a href=/tags/sp/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=Sp>Sp
<span class="badge badge-sm text-secondary bg-white ms-1">5</span>
</a><a href=/tags/c++17/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=C++17>C++17
<span class="badge badge-sm text-secondary bg-white ms-1">4</span>
</a><a href=/tags/java/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=Java>Java
<span class="badge badge-sm text-secondary bg-white ms-1">4</span>
</a><a href=/tags/stack/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=Stack>Stack
<span class="badge badge-sm text-secondary bg-white ms-1">4</span>
</a><a href=/tags/c++11/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=C++11>C++11
<span class="badge badge-sm text-secondary bg-white ms-1">3</span>
</a><a href=/tags/dp/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=DP>DP
<span class="badge badge-sm text-secondary bg-white ms-1">3</span>
</a><a href=/tags/jni/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=JNI>JNI
<span class="badge badge-sm text-secondary bg-white ms-1">3</span>
</a><a href=https://iliubang.cn/tags class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=全部>全部
<span class="badge badge-sm text-secondary bg-white ms-1">30</span></a></div><div class=tab-pane id=taxonomySeries role=tabpanel aria-labelledby=taxonomySeriesTab tabindex=0><a href=/series/leetcode/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-series me-2 mb-2" title=LeetCode>LeetCode
<span class="badge badge-sm text-secondary bg-white ms-1">14</span></a></div><div class=tab-pane id=taxonomyArchives role=tabpanel aria-labelledby=taxonomyArchivesTab tabindex=0><a href=/archives/2023/ class="btn btn-sm btn-secondary post-taxonomy ps-3 me-2 mb-2" title=2023>2023 <span class="badge badge-sm text-secondary bg-white ms-1">1</span>
</a><a href=/archives/2022/ class="btn btn-sm btn-secondary post-taxonomy ps-3 me-2 mb-2" title=2022>2022 <span class="badge badge-sm text-secondary bg-white ms-1">13</span>
</a><a href=/archives/2021/ class="btn btn-sm btn-secondary post-taxonomy ps-3 me-2 mb-2" title=2021>2021 <span class="badge badge-sm text-secondary bg-white ms-1">1</span>
</a><a href=/archives/2020/ class="btn btn-sm btn-secondary post-taxonomy ps-3 me-2 mb-2" title=2020>2020 <span class="badge badge-sm text-secondary bg-white ms-1">1</span>
</a><a href=/archives/2019/ class="btn btn-sm btn-secondary post-taxonomy ps-3 me-2 mb-2" title=2019>2019 <span class="badge badge-sm text-secondary bg-white ms-1">4</span>
</a><a href=/archives/2018/ class="btn btn-sm btn-secondary post-taxonomy ps-3 me-2 mb-2" title=2018>2018 <span class="badge badge-sm text-secondary bg-white ms-1">10</span>
</a><a href=/archives/2017/ class="btn btn-sm btn-secondary post-taxonomy ps-3 me-2 mb-2" title=2017>2017 <span class="badge badge-sm text-secondary bg-white ms-1">15</span></a></div></div></div></div></div><div class="accordion posts-toggle"><div class="row card component accordion-item"><div class="accordion-header card-header border-0"><a class="accordion-button d-lg-none mb-1 shadow-none p-0 bg-transparent collapsed" role=button data-bs-toggle=collapse href=#posts-toggle aria-expanded=false aria-controls=posts-toggle>文章</a></div><div class="card-body collapse accordion-collapse accordion-body d-lg-block" id=posts-toggle><ul class="nav nav-pills nav-fill" role=tablist><li class=nav-item role=presentation><button class="nav-link active" id=recent-posts-tab data-bs-toggle=tab data-bs-target=#recent-posts type=button role=tab aria-controls=recent-posts aria-selected=true>
最近文章</button></li></ul><div class="tab-content mt-3"><div class="tab-pane active" id=recent-posts role=tabpanel aria-labelledby=recent-posts-tab tabindex=0><ul class="post-list list-unstyled ms-1"><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/posts/cpp/2023-05-23-%E4%BD%BF%E7%94%A8llvm%E7%9A%84libfuzzer%E8%BF%9B%E8%A1%8Cfuzzy-test/>使用LLVM的libFuzzer进行fuzzy test</a><div class="post-meta mt-2"><span class=post-date>May 23, 2023</span></div></div></div></li><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/posts/rust/2022-11-13-rust%E5%92%8Cc++%E5%AF%B9%E6%AF%94%E4%B9%8B%E6%B3%9B%E5%9E%8B%E5%92%8C%E7%89%B9%E4%BE%8B%E5%8C%96/>Rust和C++: 泛型和特例化</a><div class="post-meta mt-2"><span class=post-date>November 12, 2022</span></div></div></div></li><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/posts/rust/2022-11-01-rust%E5%92%8Cc++%E5%AF%B9%E6%AF%94%E4%B9%8B%E5%8F%AF%E5%8F%98%E6%80%A7%E7%A7%BB%E5%8A%A8%E5%92%8C%E6%89%80%E6%9C%89%E6%9D%83/>Rust和C++: 可变性、移动和所有权</a><div class="post-meta mt-2"><span class=post-date>November 1, 2022</span></div></div></div></li><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/posts/cpp/2022-09-28-%E4%B8%BA%E4%BB%80%E4%B9%88c++%E4%B8%AD%E6%9C%89%E4%BA%86%E5%87%BD%E6%95%B0%E6%8C%87%E9%92%88%E5%8D%B4%E8%BF%98%E9%9C%80%E8%A6%81stdfunction/>为什么c++中有了函数指针却还需要std::function</a><div class="post-meta mt-2"><span class=post-date>September 28, 2022</span></div></div></div></li><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/posts/cpp/2022-05-15-%E4%BD%BF%E7%94%A8stdlist%E7%9A%84splice%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0lru-cache/>使用std::list的splice方法实现LRU Cache</a><div class="post-meta mt-2"><span class=post-date>May 15, 2022</span></div></div></div></li></ul></div></div></div></div></div><div class="accordion post-toc d-none d-lg-block"><div class="accordion-item row mb-4 card component" id=postTOC><div class="card-header accordion-header"><h2 class="card-title fs-4 my-2 text-surface d-none d-lg-block">目录</h2><a class="accordion-button d-lg-none mb-1 collapsed shadow-none p-0 bg-transparent" role=button data-bs-toggle=collapse href=#post-toc aria-expanded=false aria-controls=post-toc>目录</a></div><div class="card-body collapse accordion-collapse accordion-body d-lg-block" id=post-toc><nav id=TableOfContents><ul><li><a href=#函数调用>函数调用</a></li><li><a href=#实现自己的-call_user_func-函数>实现自己的 call_user_func 函数</a></li><li><a href=#回调函数>回调函数</a></li><li><a href=#总结>总结</a></li></ul></nav></div></div></div></div></aside></div></main><footer class="footer mt-auto py-3 text-center container"><div class="offcanvas offcanvas-bottom h-auto" tabindex=-1 id=offcanvasActionsPanel aria-labelledby=offcanvasActionsPanelLabel><div class=offcanvas-header><div class="offcanvas-title h5" id=offcanvasActionsPanelLabel><i class="fas fa-fw fa-th-large me-1"></i>
操作</div><button type=button class="btn-close ms-auto" data-bs-dismiss=offcanvas data-bs-target=offcanvasActionsPanel aria-label=Close></button></div><div class="offcanvas-body mt-2"><div class="actions d-flex overflow-auto align-items-center"><a role=button class="action action-go-back d-flex flex-column align-items-center me-3" href="javascript: window.history.back();"><span class="action-icon mb-2"><i class="fas fa-2x fa-chevron-circle-down" data-fa-transform=rotate-90></i></span> 返回
</a><a role=button class="action action-reload-page d-flex flex-column align-items-center me-3"><span class="action-icon mb-2"><i class="fas fa-2x fa-redo-alt"></i></span> 刷新
</a><a role=button class="action action-copy-url d-flex flex-column align-items-center me-3"><span class="action-icon mb-2"><i class="fas fa-2x fa-link"></i></span> 复制链接</a></div></div></div><div class="row text-center"><div class="col-12 mt-2"><p class=mb-2>liubang's blog</p><p class="text-secondary mb-2"><small>刘邦的博客</small></p><div class="copyright mb-2 text-secondary"><small>Copyright © 2016-2024 LiuBang. All Rights Reserved.</small></div><div class="powered-by mb-2 text-secondary"><small>Build with ❤️ from the <a class=text-primary href=https://gohugo.io target=_blank rel="noopener noreferrer">Hugo</a> and the <a class=text-primary href=https://github.com/razonyang/hugo-theme-bootstrap target=_blank rel="noopener noreferrer">HBS</a> theme.</small></div><nav class="social-links nav justify-content-center mb-2 mt-3"><a class="nav-link social-link p-0 me-1 mb-2" href=mailto:it.liubang@gmail.com title=电子邮箱><i class="fas fa-fw fa-2x fa-envelope" style=color:#0963ac></i>
</a><a class="nav-link social-link p-0 me-1 mb-2" target=_blank href=https://github.com/liubang title=GitHub rel=me><i class="fa-fw fa-2x fab fa-github"></i>
</a><a class="nav-link social-link p-0 me-1 mb-2" target=_blank href="https://wpa.qq.com/msgrd?v=3&amp;uin=1301841042&amp;site=qq&amp;menu=yes" title=QQ rel=me><i class="fa-fw fa-2x fab fa-qq"></i>
</a><a class="nav-link social-link p-0 me-1 mb-2" target=_blank href=https://weibo.com/2113750192 title=微博 rel=me><i class="fa-fw fa-2x fab fa-weibo" style=color:#e1162c></i>
</a><a class="nav-link social-link p-0 me-1 mb-2" target=_blank href=/index.xml title=RSS rel=me><i class="fas fa-fw fa-2x fa-rss" style=color:#ea6221></i></a></nav></div><div class="col-12 col-lg-8 offset-0 offset-lg-1"></div></div></footer><script data-precache src=/assets/main/bundle.min.8cac337db334f5e88a0d3a39ecd178e8c95439cccc154f0409d8084910de52b6.js integrity="sha256-jKwzfbM09eiKDTo57NF46MlUOczMFU8ECdgISRDeUrY=" crossorigin=anonymous async></script><script data-precache src=/assets/icons/bundle.min.1edf0be44ac92fc373eca5ba12ce1f444409c1a5ea989cc1338c8d660a99f81f.js integrity="sha256-Ht8L5ErJL8Nz7KW6Es4fREQJwaXqmJzBM4yNZgqZ+B8=" crossorigin=anonymous defer></script><script data-precache src=/assets/viewer/bundle.min.945567884be417f2aa4a3f7fb0171fc00a214c3c63dd586d110fc7b77d4d6077.js integrity="sha256-lFVniEvkF/KqSj9/sBcfwAohTDxj3VhtEQ/Ht31NYHc=" crossorigin=anonymous defer></script><script data-precache defer src=/assets/katex/bundle.min.ecfaac987a9ad8e8c435500e3a2dc277d9c1bdedc12ea02390b093db3788c0d4.js integrity="sha256-7PqsmHqa2OjENVAOOi3Cd9nBve3BLqAjkLCT2zeIwNQ=" crossorigin=anonymous></script><script data-precache defer src=/assets/mermaid/bundle.min.d16e7a97a0908ae444f9e9f4adb15493b9a77d27e8636078275173704d90bfa4.js integrity="sha256-0W56l6CQiuRE+en0rbFUk7mnfSfoY2B4J1FzcE2Qv6Q=" crossorigin=anonymous></script><script src=/js/sw-register.js defer></script></body></html>