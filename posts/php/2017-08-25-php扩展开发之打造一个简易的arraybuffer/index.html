<!doctype html><html class=position-relative itemscope itemtype=https://schema.org/WebPage lang=zh-cn data-bs-theme=auto data-palette=blue-gray><head><script src=/assets/init/bundle.min.3aac6fdc59d24956ee10b0a524edba606f184724055d1add5c1c76d19731279f.js integrity="sha256-Oqxv3FnSSVbuELClJO26YG8YRyQFXRrdXBx20ZcxJ58=" crossorigin=anonymous></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>PHP扩展开发之打造一个简易的ArrayBuffer - liubang's blog</title>
<link rel=icon href=/favicon_hu8740105591289948032.png sizes=16x16 type=image/png><link rel=icon href=/favicon_hu17524450719221119378.png sizes=32x32 type=image/png><link rel=icon href=/favicon_hu6335998499482997850.png sizes=150x150 type=image/png><link rel=apple-touch-icon href=/favicon_hu6806785673370764256.png sizes=180x180 type=image/png><link rel=icon href="https://iliubang.cn/images/icons/icon-192x192.png?version=5675e36f11a529bcbecb4e1fae90c416" sizes=192x192><link rel=mask-icon href=/safari-pinned-tab.svg color=#6f42c1><link rel=icon href="https://iliubang.cn/images/icons/favicon.ico?version=93c96d13551a46e5742ae6da86026661"><meta name=keywords content="c++,java,go,kv,storage"><meta name=description content="ArrayBuffer 简介
ArrayBuffer 又叫二进制数组，是一个用来表示通用的，固定长度的二进制数据缓冲区。你不能直接操纵 ArrayBuffer 的内容，
而是创建一个表示特定格式的 buffer 的类型化数组对象（也叫做数据视图对象）来对 buffer 的内容进行读写操作。
我最早了解 ArrayBuffer 是从 JavaScript 开始的，具体的用法和 api 可以参考JavaScript 标准库－－ArrayBuffer
那么接下来，我们就给 PHP 扩展一个简单的 ArrayBuffer，顺便巩固一下php 扩展开发之自定义对象的存储。

定义 ArrayBuffer 的数据结构和相关 handlers
ArrayBuffer是一个非常简单的对象，它只需要申明并存储一个buffer和它的长度即可：
typedef struct _buffer_object {
    zend_object std;
    void *buffer;
    size_t length;
} buffer_object;
接下来我们来实现它的create和free handlers，有了前面的基础，这个实现也是及其简单的：
static void linger_array_buffer_free_object_storage(buffer_object *intern TSRMLS_DC)
{
	zend_object_std_dtor(&amp;intern->std TSRMLS_CC);
	linger_efree(intern->buffer);
}

zend_object_value linger_array_buffer_create_object(zend_class_entry *class_type TSRMLS_DC)
{
	zend_object_value retval;
	buffer_object *intern = emalloc(sizeof(buffer_object));
	memset(intern, 0, sizeof(buffer_object));

	zend_object_std_init(&amp;intern->std, class_type TSRMLS_CC);
	object_properties_init(&amp;intern->std, class_type);

	retval.handle = zend_objects_store_put(
			intern,
			(zend_objects_store_dtor_t) zend_objects_destroy_object,
			(zend_objects_free_object_storage_t) linger_array_buffer_free_object_storage,
			NULL
			TSRMLS_CC
			);

	retval.handlers = &amp;linger_array_buffer_handlers;
	return retval;
}
从上面的代码中可以看到，我们并没有在create_object中申请buffer的空间，而这步操作将会在__construct中来实现，因为buffer的长度会作为构造函数的参数传递过来。"><meta name=robots content="index, follow"><meta name=twitter:card content="summary"><meta name=twitter:title content="PHP扩展开发之打造一个简易的ArrayBuffer"><meta name=twitter:description content="ArrayBuffer 简介 ArrayBuffer 又叫二进制数组，是一个用来表示通用的，固定长度的二进制数据缓冲区。你不能直接操纵 ArrayBuffer 的内容， 而是创建一个表示特定格式的 buffer 的类型化数组对象（也叫做数据视图对象）来对 buffer 的内容进行读写操作。
我最早了解 ArrayBuffer 是从 JavaScript 开始的，具体的用法和 api 可以参考JavaScript 标准库－－ArrayBuffer
那么接下来，我们就给 PHP 扩展一个简单的 ArrayBuffer，顺便巩固一下php 扩展开发之自定义对象的存储。
定义 ArrayBuffer 的数据结构和相关 handlers ArrayBuffer是一个非常简单的对象，它只需要申明并存储一个buffer和它的长度即可：
typedef struct _buffer_object { zend_object std; void *buffer; size_t length; } buffer_object; 接下来我们来实现它的create和free handlers，有了前面的基础，这个实现也是及其简单的：
static void linger_array_buffer_free_object_storage(buffer_object *intern TSRMLS_DC) { zend_object_std_dtor(&amp;intern->std TSRMLS_CC); linger_efree(intern->buffer); } zend_object_value linger_array_buffer_create_object(zend_class_entry *class_type TSRMLS_DC) { zend_object_value retval; buffer_object *intern = emalloc(sizeof(buffer_object)); memset(intern, 0, sizeof(buffer_object)); zend_object_std_init(&amp;intern->std, class_type TSRMLS_CC); object_properties_init(&amp;intern->std, class_type); retval.handle = zend_objects_store_put( intern, (zend_objects_store_dtor_t) zend_objects_destroy_object, (zend_objects_free_object_storage_t) linger_array_buffer_free_object_storage, NULL TSRMLS_CC ); retval.handlers = &amp;linger_array_buffer_handlers; return retval; } 从上面的代码中可以看到，我们并没有在create_object中申请buffer的空间，而这步操作将会在__construct中来实现，因为buffer的长度会作为构造函数的参数传递过来。"><meta property="og:url" content="https://iliubang.cn/posts/php/2017-08-25-php%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91%E4%B9%8B%E6%89%93%E9%80%A0%E4%B8%80%E4%B8%AA%E7%AE%80%E6%98%93%E7%9A%84arraybuffer/"><meta property="og:site_name" content="liubang's blog"><meta property="og:title" content="PHP扩展开发之打造一个简易的ArrayBuffer"><meta property="og:description" content="ArrayBuffer 简介 ArrayBuffer 又叫二进制数组，是一个用来表示通用的，固定长度的二进制数据缓冲区。你不能直接操纵 ArrayBuffer 的内容， 而是创建一个表示特定格式的 buffer 的类型化数组对象（也叫做数据视图对象）来对 buffer 的内容进行读写操作。
我最早了解 ArrayBuffer 是从 JavaScript 开始的，具体的用法和 api 可以参考JavaScript 标准库－－ArrayBuffer
那么接下来，我们就给 PHP 扩展一个简单的 ArrayBuffer，顺便巩固一下php 扩展开发之自定义对象的存储。
定义 ArrayBuffer 的数据结构和相关 handlers ArrayBuffer是一个非常简单的对象，它只需要申明并存储一个buffer和它的长度即可：
typedef struct _buffer_object { zend_object std; void *buffer; size_t length; } buffer_object; 接下来我们来实现它的create和free handlers，有了前面的基础，这个实现也是及其简单的：
static void linger_array_buffer_free_object_storage(buffer_object *intern TSRMLS_DC) { zend_object_std_dtor(&amp;intern->std TSRMLS_CC); linger_efree(intern->buffer); } zend_object_value linger_array_buffer_create_object(zend_class_entry *class_type TSRMLS_DC) { zend_object_value retval; buffer_object *intern = emalloc(sizeof(buffer_object)); memset(intern, 0, sizeof(buffer_object)); zend_object_std_init(&amp;intern->std, class_type TSRMLS_CC); object_properties_init(&amp;intern->std, class_type); retval.handle = zend_objects_store_put( intern, (zend_objects_store_dtor_t) zend_objects_destroy_object, (zend_objects_free_object_storage_t) linger_array_buffer_free_object_storage, NULL TSRMLS_CC ); retval.handlers = &amp;linger_array_buffer_handlers; return retval; } 从上面的代码中可以看到，我们并没有在create_object中申请buffer的空间，而这步操作将会在__construct中来实现，因为buffer的长度会作为构造函数的参数传递过来。"><meta property="og:locale" content="zh_cn"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-08-25T00:00:00+00:00"><meta property="article:modified_time" content="2017-08-25T00:00:00+00:00"><meta property="article:tag" content="C"><meta property="article:tag" content="Php"><meta itemprop=name content="PHP扩展开发之打造一个简易的ArrayBuffer"><meta itemprop=description content="ArrayBuffer 简介 ArrayBuffer 又叫二进制数组，是一个用来表示通用的，固定长度的二进制数据缓冲区。你不能直接操纵 ArrayBuffer 的内容， 而是创建一个表示特定格式的 buffer 的类型化数组对象（也叫做数据视图对象）来对 buffer 的内容进行读写操作。
我最早了解 ArrayBuffer 是从 JavaScript 开始的，具体的用法和 api 可以参考JavaScript 标准库－－ArrayBuffer
那么接下来，我们就给 PHP 扩展一个简单的 ArrayBuffer，顺便巩固一下php 扩展开发之自定义对象的存储。
定义 ArrayBuffer 的数据结构和相关 handlers ArrayBuffer是一个非常简单的对象，它只需要申明并存储一个buffer和它的长度即可：
typedef struct _buffer_object { zend_object std; void *buffer; size_t length; } buffer_object; 接下来我们来实现它的create和free handlers，有了前面的基础，这个实现也是及其简单的：
static void linger_array_buffer_free_object_storage(buffer_object *intern TSRMLS_DC) { zend_object_std_dtor(&amp;intern->std TSRMLS_CC); linger_efree(intern->buffer); } zend_object_value linger_array_buffer_create_object(zend_class_entry *class_type TSRMLS_DC) { zend_object_value retval; buffer_object *intern = emalloc(sizeof(buffer_object)); memset(intern, 0, sizeof(buffer_object)); zend_object_std_init(&amp;intern->std, class_type TSRMLS_CC); object_properties_init(&amp;intern->std, class_type); retval.handle = zend_objects_store_put( intern, (zend_objects_store_dtor_t) zend_objects_destroy_object, (zend_objects_free_object_storage_t) linger_array_buffer_free_object_storage, NULL TSRMLS_CC ); retval.handlers = &amp;linger_array_buffer_handlers; return retval; } 从上面的代码中可以看到，我们并没有在create_object中申请buffer的空间，而这步操作将会在__construct中来实现，因为buffer的长度会作为构造函数的参数传递过来。"><meta itemprop=datePublished content="2017-08-25T00:00:00+00:00"><meta itemprop=dateModified content="2017-08-25T00:00:00+00:00"><meta itemprop=wordCount content="1243"><meta itemprop=keywords content="C,Php"><meta property="og:image" content="https://iliubang.cn/images/apple-touch-icon.png"><meta name=twitter:image content="https://iliubang.cn/images/apple-touch-icon.png"><meta property="og:image:alt" content="PHP扩展开发之打造一个简易的ArrayBuffer"><meta name=twitter:image:alt content="PHP扩展开发之打造一个简易的ArrayBuffer"><link rel=manifest href=/manifest.json><link data-precache rel=stylesheet href="/assets/main/bundle.min.6e178270a4ff001c8a4de394b4de46a913e45e3897a8bffdd1fdd42a2fec1c18.css" integrity="sha256-bheCcKT/AByKTeOUtN5GqRPkXjiXqL/90f3UKi/sHBg=" crossorigin=anonymous><link data-precache rel=stylesheet href=/assets/katex/bundle.min.0e62515e6b767fdcffc08f3d4ab9197f6849689a486b42ab0c98b5e7732e1f58.css integrity="sha256-DmJRXmt2f9z/wI89SrkZf2hJaJpIa0KrDJi153MuH1g=" crossorigin=anonymous><link data-precache rel=stylesheet href=/assets/viewer/bundle.min.16d2c85c4cae39a98f8cb7a977e95e554b174f91a5484c32605637156f49ca6b.css integrity="sha256-FtLIXEyuOamPjLepd+leVUsXT5GlSEwyYFY3FW9Jyms=" crossorigin=anonymous></head><body><header class="mb-4 sticky-top"><nav class="top-app-bar shadow navbar navbar-expand-xxl"><div class=container><a class="navbar-brand d-flex align-items-center flex-grow-1 flex-xxl-grow-0 justify-content-xxl-start ms-2 ms-xxl-0 mx-auto me-xxl-2" href=https://iliubang.cn/><picture><img class=logo alt=Logo src="https://iliubang.cn/images/apple-touch-icon.png?v=7fdc4e1b5785be32c88d453deb32ca63" loading=lazy width=180 height=180>
</picture>HIGHKYCK</a><div class="offcanvas-xxl offcanvas-end flex-grow-1" data-bs-scroll=true tabindex=-1 id=navbarMenus aria-labelledby=navbarMenusLabel><div class="offcanvas-header px-4 pb-0"><div class="offcanvas-title h5" id=navbarMenusLabel>HIGHKYCK</div><button type=button class="btn-close btn-close-white" data-bs-dismiss=offcanvas data-bs-target=#navbarMenus aria-label=Close></button></div><div class="offcanvas-body p-4 pt-0 p-xxl-0"><hr class=d-xxl-none><ul class="navbar-nav flex-row flex-wrap align-items-center me-auto"><li class="nav-item col-6 col-xxl-auto"><a class="nav-link py-2 px-0 px-xxl-2" href=https://iliubang.cn/archives/><i class="fas fa-fw fa-file-archive"></i>归档</a></li><li class="nav-item col-12 col-xxl-auto dropdown px-0"><a href=# class="nav-link dropdown-toggle" id=navbarDropdownCategories role=button data-bs-toggle=dropdown aria-expanded=false><i class="fas fa-fw fa-folder"></i>分类</a><ul class="dropdown-menu dropdown-menu-end" aria-labelledby=navbarDropdownCategories data-bs-popper=none><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=https://iliubang.cn/categories/programming><i class="fas fa-fw fa-code me-1"></i><div class=dropdown-item-content><p class="dropdown-item-title mb-0">Programing</p></div></a></li><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=https://iliubang.cn/categories/reading><i class="fas fa-fw fa-book-reader me-1"></i><div class=dropdown-item-content><p class="dropdown-item-title mb-0">Reading</p></div></a></li><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=https://iliubang.cn/categories/linux><i class="fab fa-fw fa-linux me-1"></i><div class=dropdown-item-content><p class="dropdown-item-title mb-0">Linux</p></div></a></li><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=https://iliubang.cn/categories><i class="fas fa-fw fa-folder me-1"></i><div class=dropdown-item-content><p class="dropdown-item-title mb-0">所有分类</p></div></a></li></ul></li><li class="nav-item col-12 col-xxl-auto dropdown px-0"><a href=# class="nav-link dropdown-toggle" id=navbarDropdownTags role=button data-bs-toggle=dropdown aria-expanded=false><i class="fas fa-fw fa-tags me-1"></i>标签</a><ul class="dropdown-menu dropdown-menu-end" aria-labelledby=navbarDropdownTags data-bs-popper=none><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=https://iliubang.cn/tags/algorithm><i class="fas fa-fw fa-square-root-alt me-1"></i><div class=dropdown-item-content><p class="dropdown-item-title mb-0">Algorithm</p></div></a></li><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=https://iliubang.cn/tags/c++><i class="fab fa-fw fa-google me-1"></i><div class=dropdown-item-content><p class="dropdown-item-title mb-0">C++</p></div></a></li><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=https://iliubang.cn/tags/go><i class="fab fa-fw fa-google me-1"></i><div class=dropdown-item-content><p class="dropdown-item-title mb-0">Go</p></div></a></li><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=https://iliubang.cn/tags/java><i class="fab fa-fw fa-java me-1"></i><div class=dropdown-item-content><p class="dropdown-item-title mb-0">Java</p></div></a></li><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=https://iliubang.cn/tags/storage><i class="fas fa-fw fa-database me-1"></i><div class=dropdown-item-content><p class="dropdown-item-title mb-0">Storage</p></div></a></li><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=https://iliubang.cn/tags><i class="fas fa-fw fa-tags me-1"></i><div class=dropdown-item-content><p class="dropdown-item-title mb-0">所有标签</p></div></a></li></ul></li><li class="nav-item col-12 col-xxl-auto dropdown px-0"><a href=# class="nav-link dropdown-toggle" id=navbarDropdownSeries role=button data-bs-toggle=dropdown aria-expanded=false><i class="fas fa-fw fa-columns me-1"></i>专栏</a><ul class="dropdown-menu dropdown-menu-end" aria-labelledby=navbarDropdownSeries data-bs-popper=none><li><a class="dropdown-item d-flex align-items-center text-wrap text-xxl-nowrap" href=https://iliubang.cn/leetcode/><div class=dropdown-item-content><p class="dropdown-item-title mb-0">LeetCode</p></div></a></li></ul></li></ul><hr class=d-xxl-none><form class="search-bar ms-auto my-auto" action=/search/ novalidate><div class="input-group align-items-center"><span class="btn btn-search disabled position-absolute left-0 border-0 px-1"><i class="fas fa-fw fa-search fa-lg"></i>
</span><input class="my-1 form-control border-white rounded-5 search-input bg-body" name=q type=search placeholder=搜索 aria-label=Search required>
<span class="search-shortcut position-absolute end-0 top-0 me-2"><kbd class="text-dark bg-white opacity-75 rounded-3 shadow border border-primary py-1 fw-bold">/</kbd></span></div></form><hr class=d-xxl-none><ul class="navbar-nav flex-row flex-wrap align-items-center ms-md-auto"><li class="nav-item py-2 py-xxl-1 col-12 col-xxl-auto"><nav class="social-links nav justify-content-center flex-row"><a class="nav-link social-link col-6 col-xxl-auto p-1" target=_blank href=https://github.com/liubang title=GitHub rel=me><i class="fa-fw fab fa-github"></i>
<span class="ms-1 d-xxl-none">Github</span>
</a><a class="nav-link social-link col-6 col-xxl-auto p-1" target=_blank href=/index.xml title=RSS rel=me><i class="fas fa-fw fa-rss"></i>
<span class="ms-1 d-xxl-none">RSS</span></a></nav></li><li class="nav-item py-2 py-xxl-1 col-12 col-xxl-auto"><div class="vr d-none d-xxl-flex h-100 mx-xxl-2 text-white"></div><hr class="d-xxl-none my-2"></li><li class="nav-item dropdown py-1 py-xxl-1 col-6 col-xxl-auto"><a class="nav-link px-0 px-xxl-1" href=# id=languageDropdown role=button data-bs-toggle=dropdown aria-expanded=false><i class="fas fa-fw fa-globe"></i>
<span class=d-xxl-none>语言</span></a><ul class="language-dropdown-menu dropdown-menu dropdown-menu-end" aria-labelledby=languageDropdown><li><a class=dropdown-item href=/en/>English</a></li><li><a class="dropdown-item active" href=/>简体中文</a></li></ul></li><li class="nav-item py-1 col-12 col-xxl-auto"><div class="vr d-none d-xxl-flex h-100 mx-xxl-2 text-white"></div><hr class="d-xxl-none my-2"></li><li class="nav-item dropdown col-6 col-xxl-auto"><a class="nav-link px-0 py-2 px-xxl-1" href=# id=modeDropdown role=button data-bs-toggle=dropdown aria-expanded=false><i class="mode-icon fas fa-fw fa-adjust" id=modeIcon></i>
<span class=d-xxl-none>模式</span></a><ul class="mode-dropdown-menu dropdown-menu dropdown-menu-end" aria-labelledby=modeDropdown><li class=mode-item data-color-mode=light data-icon=sun><button class=dropdown-item>
<i class="mode-icon fas fa-fw fa-sun"></i> 浅色</button></li><li class=mode-item data-color-mode=dark data-icon=moon><button class=dropdown-item>
<i class="mode-icon fas fa-fw fa-moon"></i> 深色</button></li><li class="mode-item active" data-color-mode=auto data-icon=adjust><button class=dropdown-item>
<i class="mode-icon fas fa-fw fa-adjust"></i> 自动</button></li></ul></li></ul></div></div><div class=d-flex><button class="navbar-toggler order-5 border-0" type=button data-bs-toggle=offcanvas data-bs-target=#navbarMenus aria-controls=navbarMenus aria-expanded=false aria-label="Toggle navigation">
<i class="fas fa-ellipsis-h"></i></button></div></div></nav></header><main class="container has-sidebar" data-kind=page><script data-precache src=/js/main-init.0bc77d87a23c00bf13103713a9283c4a18b7b2c357dc12e3b6973058baecbfe1.js integrity="sha256-C8d9h6I8AL8TEDcTqSg8Shi3ssNX3BLjtpcwWLrsv+E=" crossorigin=anonymous></script><div class="row content"><noscript><div class="alert alert-danger" role=alert>你的浏览器不支持 JavaScript。</div></noscript><div class="content-posts col-xxl-8"><div class=container><nav class="row card component" aria-label=breadcrumb><div class="card-body pb-0"><ol class="hbs-breadcrumb breadcrumb flex-nowrap"><li class="breadcrumb-item text-surface"><a href=/>主页</a></li><li class="breadcrumb-item text-surface"><a href=/posts/>文章</a></li><li class="breadcrumb-item active">PHP扩展开发之打造一个简易的ArrayBuffer</li></ol></div></nav><div class="post-panel-wrapper position-relative d-flex justify-content-center"><div class="d-flex flex-row justify-content-center rounded-5 border post-panel position-fixed px-3 py-1 surface shadow-1"><a class="action btn-reward" role=button data-bs-toggle=modal data-bs-target=#rewardModal title=打赏><i class="fas fa-fw fa-coffee"></i>
</a><a class="action action-toc d-none d-xxl-block" href=#postTOC role=button title=目录><i class="fas fa-fw fa-list-alt"></i>
</a><a class="action action-toc d-block d-xxl-none" href=#post-toc-container role=button title=目录><i class="fas fa-fw fa-list-alt"></i>
</a><a class="action action-copyright" href=#post-copyright role=button aria-label=Copyright title=版权><i class="fas fa-fw fa-copyright"></i>
</a><a class="action action-post-comments" href=#post-comments role=button aria-label=Comments title=评论><i class="fas fa-fw fa-comments"></i>
</a><a id=sidebarToggler class="action action-sidebar-toggler d-none d-xxl-block" role=button title=切换侧边栏><i class="fas fa-fw fa-expand-alt" data-fa-transform=rotate-45></i></a></div></div><article class="row card component mb-4 post"><div class=card-header><h1 class="card-title post-title my-2">PHP扩展开发之打造一个简易的ArrayBuffer</h1></div><div class=card-body><div class="post-meta mb-3"><span class="post-date me-1 mb-1" title="创建于 2017-08-25 00:00:00 +0000 UTC。">August 25, 2017</span><span class="post-reading-time me-1 mb-1">6 分钟阅读</span><a href=/authors/liubang/ class="btn btn-sm btn-secondary mb-1 me-2 py-0 pe-1 post-taxonomy post-taxonomy-sm post-author">
<i class="fas fa-fw fa-user me-1"></i>Liu Bang</a><a href=/categories/programming/ class="btn btn-sm btn-secondary mb-1 me-2 py-0 pe-1 post-taxonomy post-taxonomy-sm post-category">
<i class="fas fa-fw fa-folder me-1"></i>Programming</a><a href=/tags/c/ class="btn btn-sm btn-secondary mb-1 me-2 py-0 pe-1 post-taxonomy post-taxonomy-sm post-tag">C</a><a href=/tags/php/ class="btn btn-sm btn-secondary mb-1 me-2 py-0 pe-1 post-taxonomy post-taxonomy-sm post-tag">Php</a></div><div class="mt-2 mb-3 d-block d-xxl-none"><h2 class="text-surface mb-3">目录</h2><div id=post-toc-container></div><hr class=text-secondary></div><div class="post-content mb-3" data-bs-spy=scroll data-bs-target=#TableOfContents tabindex=0><div id=post-content-body><h2 id=arraybuffer-简介 data-numberify>ArrayBuffer 简介<a class="anchor ms-1" href=#arraybuffer-简介></a></h2><p>ArrayBuffer 又叫二进制数组，是一个用来表示通用的，固定长度的二进制数据缓冲区。你不能直接操纵 ArrayBuffer 的内容，
而是创建一个表示特定格式的 buffer 的类型化数组对象（也叫做数据视图对象）来对 buffer 的内容进行读写操作。</p><p>我最早了解 ArrayBuffer 是从 JavaScript 开始的，具体的用法和 api 可以参考<a href=https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/ArrayBuffer target=_blank rel="noopener noreferrer">JavaScript 标准库－－ArrayBuffer<i class="fas fa-external-link-square-alt ms-1"></i></a></p><p>那么接下来，我们就给 PHP 扩展一个简单的 ArrayBuffer，顺便巩固一下<a href=https://iliubang.github.io/c/2017/08/24/php%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91%E4%B9%8B%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%AD%98%E5%82%A8/ target=_blank rel="noopener noreferrer">php 扩展开发之自定义对象的存储<i class="fas fa-external-link-square-alt ms-1"></i></a>。</p><h2 id=定义-arraybuffer-的数据结构和相关-handlers data-numberify>定义 ArrayBuffer 的数据结构和相关 handlers<a class="anchor ms-1" href=#定义-arraybuffer-的数据结构和相关-handlers></a></h2><p><code>ArrayBuffer</code>是一个非常简单的对象，它只需要申明并存储一个<code>buffer</code>和它的长度即可：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> _buffer_object {
</span></span><span style=display:flex><span>    zend_object std;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>void</span> <span style=color:#f92672>*</span>buffer;
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>size_t</span> length;
</span></span><span style=display:flex><span>} buffer_object;
</span></span></code></pre></div><p>接下来我们来实现它的<code>create</code>和<code>free</code> handlers，有了前面的基础，这个实现也是及其简单的：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>linger_array_buffer_free_object_storage</span>(buffer_object <span style=color:#f92672>*</span>intern TSRMLS_DC)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>zend_object_std_dtor</span>(<span style=color:#f92672>&amp;</span>intern<span style=color:#f92672>-&gt;</span>std TSRMLS_CC);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>linger_efree</span>(intern<span style=color:#f92672>-&gt;</span>buffer);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>zend_object_value <span style=color:#a6e22e>linger_array_buffer_create_object</span>(zend_class_entry <span style=color:#f92672>*</span>class_type TSRMLS_DC)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	zend_object_value retval;
</span></span><span style=display:flex><span>	buffer_object <span style=color:#f92672>*</span>intern <span style=color:#f92672>=</span> <span style=color:#a6e22e>emalloc</span>(<span style=color:#66d9ef>sizeof</span>(buffer_object));
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>memset</span>(intern, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(buffer_object));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>zend_object_std_init</span>(<span style=color:#f92672>&amp;</span>intern<span style=color:#f92672>-&gt;</span>std, class_type TSRMLS_CC);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>object_properties_init</span>(<span style=color:#f92672>&amp;</span>intern<span style=color:#f92672>-&gt;</span>std, class_type);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	retval.handle <span style=color:#f92672>=</span> <span style=color:#a6e22e>zend_objects_store_put</span>(
</span></span><span style=display:flex><span>			intern,
</span></span><span style=display:flex><span>			(<span style=color:#66d9ef>zend_objects_store_dtor_t</span>) zend_objects_destroy_object,
</span></span><span style=display:flex><span>			(<span style=color:#66d9ef>zend_objects_free_object_storage_t</span>) linger_array_buffer_free_object_storage,
</span></span><span style=display:flex><span>			NULL
</span></span><span style=display:flex><span>			TSRMLS_CC
</span></span><span style=display:flex><span>			);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	retval.handlers <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>linger_array_buffer_handlers;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> retval;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>从上面的代码中可以看到，我们并没有在<code>create_object</code>中申请<code>buffer</code>的空间，而这步操作将会在<code>__construct</code>中来实现，因为<code>buffer</code>的长度会作为构造函数的参数传递过来。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/* ArrayBuffer arginfo */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>ZEND_BEGIN_ARG_INFO_EX</span>(arginfo_buffer_ctor, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ZEND_ARG_INFO</span>(<span style=color:#ae81ff>0</span>, length)
</span></span><span style=display:flex><span><span style=color:#a6e22e>ZEND_END_ARG_INFO</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PHP_METHOD</span>(linger_ArrayBuffer, __construct)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	buffer_object <span style=color:#f92672>*</span>intern;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>long</span> length;
</span></span><span style=display:flex><span>	zend_error_handling error_handling;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>zend_replace_error_handling</span>(EH_THROW, NULL, <span style=color:#f92672>&amp;</span>error_handling TSRMLS_CC);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>zend_parse_parameters</span>(<span style=color:#a6e22e>ZEND_NUM_ARGS</span>() TSRMLS_CC, <span style=color:#e6db74>&#34;l&#34;</span>, <span style=color:#f92672>&amp;</span>length) <span style=color:#f92672>==</span> FAILURE) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>zend_restore_error_handling</span>(<span style=color:#f92672>&amp;</span>error_handling TSRMLS_CC);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>zend_restore_error_handling</span>(<span style=color:#f92672>&amp;</span>error_handling TSRMLS_CC);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (length <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>zend_throw_exception</span>(NULL, <span style=color:#e6db74>&#34;Buffer length must be positive&#34;</span>, <span style=color:#ae81ff>0</span> TSRMLS_CC);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	intern <span style=color:#f92672>=</span> <span style=color:#a6e22e>zend_object_store_get_object</span>(<span style=color:#a6e22e>getThis</span>() TSRMLS_CC);
</span></span><span style=display:flex><span>	intern<span style=color:#f92672>-&gt;</span>buffer <span style=color:#f92672>=</span> <span style=color:#a6e22e>emalloc</span>(length);
</span></span><span style=display:flex><span>	intern<span style=color:#f92672>-&gt;</span>length <span style=color:#f92672>=</span> length;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>memset</span>(intern<span style=color:#f92672>-&gt;</span>buffer, <span style=color:#ae81ff>0</span>, length);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>由于现在写的是物件导向风格的程式码，所以我们不再直接抛出<code>error</code>，而是通过<code>zend_throw_exception</code>抛<code>exception</code>，
它需要传递一个异常类的<code>class entry</code>，异常信息和错误码作为参数，如果异常类的<code>class entry</code>为<code>NULL</code>的话，就会
使用默认的<code>Exception</code>类抛出。</p><p>对于<code>__construct</code>这样的方法尤其需要注意，当发生错误的时候抛出异常能够避免一个对象被部分构造。这就是上述代码
替换掉错误处理模式的原因。通常情况下，<code>zend_parse_parameters</code>在解析非法参数的情况下只会抛出一个<code>warning</code>，通过
将错误模式设置为<code>EH_NORMAL</code>可以自动将警告转换成异常抛出。</p><p>使用<code>zend_replace_error_handling</code>函数可以改变错误处理模式。它的第一个参数为错误模式：<code>EH_NORMAL</code>、<code>EH_SUPPRESS</code>、<code>EH_THROW</code>，第二个参数为异常类的<code>class entry</code>，如果为<code>NULL</code>，则使用
默认的<code>Exception</code>作为异常类抛出，最后一个参数是一个指向<code>zend_error_handling</code>结构的指针，用以备份之前的<code>error mode</code>。</p><p>除了<code>create handler</code>之外，我们还需要处理克隆操作。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> zend_object_value <span style=color:#a6e22e>linger_array_buffer_clone</span>(zval <span style=color:#f92672>*</span>object TSRMLS_DC)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	buffer_object <span style=color:#f92672>*</span>old_object <span style=color:#f92672>=</span> <span style=color:#a6e22e>zend_object_store_get_object</span>(object TSRMLS_CC);
</span></span><span style=display:flex><span>	zend_object_value new_object_val <span style=color:#f92672>=</span> <span style=color:#a6e22e>linger_array_buffer_create_object</span>(<span style=color:#a6e22e>Z_OBJCE_P</span>(object) TSRMLS_CC);
</span></span><span style=display:flex><span>	buffer_object <span style=color:#f92672>*</span>new_object <span style=color:#f92672>=</span> <span style=color:#a6e22e>zend_object_store_get_object_by_handle</span>(new_object_val.handle TSRMLS_CC);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>zend_objects_clone_members</span>(<span style=color:#f92672>&amp;</span>new_object<span style=color:#f92672>-&gt;</span>std, new_object_val, <span style=color:#f92672>&amp;</span>old_object<span style=color:#f92672>-&gt;</span>std, <span style=color:#a6e22e>Z_OBJ_HANDLE_P</span>(object) TSRMLS_CC);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	new_object<span style=color:#f92672>-&gt;</span>buffer <span style=color:#f92672>=</span> old_object<span style=color:#f92672>-&gt;</span>buffer;
</span></span><span style=display:flex><span>	new_object<span style=color:#f92672>-&gt;</span>length <span style=color:#f92672>=</span> old_object<span style=color:#f92672>-&gt;</span>length;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (old_object<span style=color:#f92672>-&gt;</span>buffer) {
</span></span><span style=display:flex><span>		new_object<span style=color:#f92672>-&gt;</span>buffer <span style=color:#f92672>=</span> <span style=color:#a6e22e>emalloc</span>(old_object<span style=color:#f92672>-&gt;</span>length);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>memcpy</span>(new_object<span style=color:#f92672>-&gt;</span>buffer, old_object<span style=color:#f92672>-&gt;</span>buffer, old_object<span style=color:#f92672>-&gt;</span>length);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>memcpy</span>(new_object<span style=color:#f92672>-&gt;</span>buffer, old_object<span style=color:#f92672>-&gt;</span>buffer, old_object<span style=color:#f92672>-&gt;</span>length);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> new_object_val;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>最后在<code>MINIT</code>中注册 ArrayBuffer 类：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#a6e22e>PHP_MINIT_FUNCTION</span>(linger_array_buffer)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	zend_class_entry ce;
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>INIT_CLASS_ENTRY</span>(ce, <span style=color:#e6db74>&#34;Linger</span><span style=color:#ae81ff>\\</span><span style=color:#e6db74>ArrayBuffer&#34;</span>, linger_array_buffer_methods);
</span></span><span style=display:flex><span>	linger_array_buffer_ce <span style=color:#f92672>=</span> <span style=color:#a6e22e>zend_register_internal_class</span>(<span style=color:#f92672>&amp;</span>ce TSRMLS_CC);
</span></span><span style=display:flex><span>	linger_array_buffer_ce<span style=color:#f92672>-&gt;</span>create_object <span style=color:#f92672>=</span> linger_array_buffer_create_object;
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>memcpy</span>(<span style=color:#f92672>&amp;</span>linger_array_buffer_handlers, <span style=color:#a6e22e>zend_get_std_object_handlers</span>(), <span style=color:#66d9ef>sizeof</span>(zend_object_handlers));
</span></span><span style=display:flex><span>	linger_array_buffer_handlers.clone_obj <span style=color:#f92672>=</span> linger_array_buffer_clone;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> SUCCESS;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=buffer-view data-numberify>buffer view<a class="anchor ms-1" href=#buffer-view></a></h2><p>下面我们来打造数据视图类。我们将要在同一个示例中实现 8 中不同的数据视图类，分别叫做<code>Int8Array</code>，<code>UInt8Array</code>，
<code>Int16Array</code>，<code>UInt16Array</code>，<code>Int32Array</code>，<code>UInt32Array</code>，<code>FloatArray</code>，<code>DoubleArray</code>。首先我们在<code>MINIT</code>中
注册这些类：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#75715e>/* ArrayBufferView class entry and handlers */</span>
</span></span><span style=display:flex><span>zend_class_entry <span style=color:#f92672>*</span>int8_array_ce;
</span></span><span style=display:flex><span>zend_class_entry <span style=color:#f92672>*</span>uint8_array_ce;
</span></span><span style=display:flex><span>zend_class_entry <span style=color:#f92672>*</span>int16_array_ce;
</span></span><span style=display:flex><span>zend_class_entry <span style=color:#f92672>*</span>uint16_array_ce;
</span></span><span style=display:flex><span>zend_class_entry <span style=color:#f92672>*</span>int32_array_ce;
</span></span><span style=display:flex><span>zend_class_entry <span style=color:#f92672>*</span>uint32_array_ce;
</span></span><span style=display:flex><span>zend_class_entry <span style=color:#f92672>*</span>float_array_ce;
</span></span><span style=display:flex><span>zend_class_entry <span style=color:#f92672>*</span>double_array_ce;
</span></span><span style=display:flex><span>zend_object_handlers linger_array_buffer_view_handlers;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PHP_MINIT_FUNCTION</span>(linger_array_buffer)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	zend_class_entry ce;
</span></span><span style=display:flex><span>	<span style=color:#75715e>// ArrayBuffer class register
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	...
</span></span><span style=display:flex><span><span style=color:#75715e>#define REGISTER_ARRAY_BUFFER_VIEW_CLASS(class_name, type)		                 \
</span></span></span><span style=display:flex><span><span style=color:#75715e>	do {														                 \
</span></span></span><span style=display:flex><span><span style=color:#75715e>		INIT_CLASS_ENTRY(ce, #class_name, linger_array_buffer_view_methods);     \
</span></span></span><span style=display:flex><span><span style=color:#75715e>		type##_array_ce = zend_register_internal_class(&amp;ce TSRMLS_CC);           \
</span></span></span><span style=display:flex><span><span style=color:#75715e>		type##_array_ce-&gt;create_object = linger_array_buffer_view_create_object; \
</span></span></span><span style=display:flex><span><span style=color:#75715e>		zend_class_implements(type##_array_ce TSRMLS_CC, 1, zend_ce_arrayaccess);\
</span></span></span><span style=display:flex><span><span style=color:#75715e>	} while (0)
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>REGISTER_ARRAY_BUFFER_VIEW_CLASS</span>(Linger<span style=color:#960050;background-color:#1e0010>\\</span>ArrayBufferView<span style=color:#960050;background-color:#1e0010>\\</span>Int8Array, int8);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>REGISTER_ARRAY_BUFFER_VIEW_CLASS</span>(Linger<span style=color:#960050;background-color:#1e0010>\\</span>ArrayBufferView<span style=color:#960050;background-color:#1e0010>\\</span>UInt8Array, uint8);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>REGISTER_ARRAY_BUFFER_VIEW_CLASS</span>(Linger<span style=color:#960050;background-color:#1e0010>\\</span>ArrayBufferView<span style=color:#960050;background-color:#1e0010>\\</span>Int16Array, int16);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>REGISTER_ARRAY_BUFFER_VIEW_CLASS</span>(Linger<span style=color:#960050;background-color:#1e0010>\\</span>ArrayBufferView<span style=color:#960050;background-color:#1e0010>\\</span>UInt16Array, uint16);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>REGISTER_ARRAY_BUFFER_VIEW_CLASS</span>(Linger<span style=color:#960050;background-color:#1e0010>\\</span>ArrayBufferView<span style=color:#960050;background-color:#1e0010>\\</span>Int32Array, int32);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>REGISTER_ARRAY_BUFFER_VIEW_CLASS</span>(Linger<span style=color:#960050;background-color:#1e0010>\\</span>ArrayBufferView<span style=color:#960050;background-color:#1e0010>\\</span>UInt32Array, uint32);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>REGISTER_ARRAY_BUFFER_VIEW_CLASS</span>(Linger<span style=color:#960050;background-color:#1e0010>\\</span>ArrayBufferView<span style=color:#960050;background-color:#1e0010>\\</span>FloatArray, <span style=color:#66d9ef>float</span>);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>REGISTER_ARRAY_BUFFER_VIEW_CLASS</span>(Linger<span style=color:#960050;background-color:#1e0010>\\</span>ArrayBufferView<span style=color:#960050;background-color:#1e0010>\\</span>DoubleArray, <span style=color:#66d9ef>double</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>memcpy</span>(<span style=color:#f92672>&amp;</span>linger_array_buffer_view_handlers, <span style=color:#a6e22e>zend_get_std_object_handlers</span>(), <span style=color:#66d9ef>sizeof</span>(zend_object_handlers));
</span></span><span style=display:flex><span>	linger_array_buffer_view_handlers.clone_obj <span style=color:#f92672>=</span> linger_array_buffer_view_clone;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> SUCCESS;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>为了避免书写大量重复类似的代码，我们定义了一个宏来简化书写，注意，在 macro 中<code>#</code>表示将参数作为字符串传递，而<code>##</code>表示连接操作。</p><p>接下来我们来申明<code>linger_array_buffer_view_methods</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>const</span> zend_function_entry linger_array_buffer_view_methods[] <span style=color:#f92672>=</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PHP_ME_MAPPING</span>(__construct, linger_array_buffer_view_ctor, arginfo_buffer_view_ctor, ZEND_ACC_PUBLIC <span style=color:#f92672>|</span> ZEND_ACC_CTOR)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PHP_ME_MAPPING</span>(offsetGet, linger_array_buffer_view_offset_get, arginfo_buffer_view_offset, ZEND_ACC_PUBLIC)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PHP_ME_MAPPING</span>(offsetSet, linger_array_buffer_view_offset_set, arginfo_buffer_view_offset_set, ZEND_ACC_PUBLIC)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PHP_ME_MAPPING</span>(offsetExists, linger_array_buffer_view_offset_exists, arginfo_buffer_view_offset, ZEND_ACC_PUBLIC)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>PHP_ME_MAPPING</span>(offsetUnset, linger_array_buffer_view_offset_unset, arginfo_buffer_view_offset, ZEND_ACC_PUBLIC)
</span></span><span style=display:flex><span>	PHP_FE_END
</span></span><span style=display:flex><span>};
</span></span></code></pre></div><p>这里用到了一个很新鲜的玩意儿，<code>PHP_ME_MAPPING</code>。通常我们在定义<code>zend_function_entry</code>的时候都是使用<code>PHP_ME</code>宏，那么
<code>PHP_ME</code>和<code>PHP_ME_MAPPING</code>的区别是什么呢，下面我们来举例说明：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#a6e22e>PHP_ME</span>(linger_ArrayBuffer_View, offsetGet, arginfo_buffer_view_offset, ZEND_ACC_PUBLIC)
</span></span><span style=display:flex><span><span style=color:#75715e>/* 会映射到 */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PHP_METHOD</span>(linger_ArrayBuffer_View, offsetGet) {...}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PHP_ME_MAPPING</span>(offsetGet, linger_array_buffer_offset_get, arginfo_buffer_view_offset, ZEND_ACC_PUBLIC)
</span></span><span style=display:flex><span><span style=color:#75715e>/* 会映射到 */</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PHP_FUNCTION</span>(linger_array_buffer_offset_get) {...}
</span></span></code></pre></div><p>至此，也许你也应该意识到了<code>PHP_FUNCTION</code>和<code>PHP_METHOD</code>其实什么都没有做，他们只是定义了一些函数的名字和参数而已。
这就是为什么你可以把一个<code>function</code>注册成<code>method</code>，你也可以定义一个方法的时候使用一个名字，而注册的时候使用另一个名字。
这对于支持物件导向接口和程式 API 都是非常有用的。</p><p>而回到我们的代码中，这里之所以选择使用<code>PHP_ME_MAPPING</code>是因为我们没有一个确切的<code>ArrayBufferView</code>类，而是一组公用方法的类。</p><p>接下来我们来思考<code>buffer view</code>的数据结构该如何组织：首先需要能够区分不同的视图类，例如一些标记字段，其次它还需要存储一个
<code>zval</code>类型的数据来记录它所操作的<code>ArrayBuffer</code>对象，最后需要一个成员能够作为不同的类型用来访问<code>ArrayBuffer</code>中的<code>buffer</code>。
此外它还需要记录当前的<code>offset</code>和<code>length</code>，因为我们在创建数据视图的时候不一定会使用到整个<code>ArrayBuffer</code>中的<code>buffer</code>，例如：
<code>new linger\ArrayBuffer\Int32Array($buffer, 8, 10)</code>，将会创建一个数据视图，从<code>ArrayBuffer</code>的偏移<code>sizeof(int32_t) * 8</code>bytes 的位置开始，
总共包含 24 和元素。</p><p>下面是<code>Array Buffer View</code>的数据结构：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>enum</span> _buffer_view_type {
</span></span><span style=display:flex><span>	buffer_view_int8,
</span></span><span style=display:flex><span>	buffer_view_uint8,
</span></span><span style=display:flex><span>	buffer_view_int16,
</span></span><span style=display:flex><span>	buffer_view_uint16,
</span></span><span style=display:flex><span>	buffer_view_int32,
</span></span><span style=display:flex><span>	buffer_view_uint32,
</span></span><span style=display:flex><span>	buffer_view_float,
</span></span><span style=display:flex><span>	buffer_view_double,
</span></span><span style=display:flex><span>} buffer_view_type;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>typedef</span> <span style=color:#66d9ef>struct</span> _buffer_view_object {
</span></span><span style=display:flex><span>	zend_object std;
</span></span><span style=display:flex><span>	zval <span style=color:#f92672>*</span>buffer_zval;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>union</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>int8_t</span>    <span style=color:#f92672>*</span>as_int8;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>uint8_t</span>   <span style=color:#f92672>*</span>as_uint8;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>int16_t</span>   <span style=color:#f92672>*</span>as_int16;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>uint16_t</span>  <span style=color:#f92672>*</span>as_uint16;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>int32_t</span>   <span style=color:#f92672>*</span>as_int32;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>uint32_t</span>  <span style=color:#f92672>*</span>as_uint32;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>float</span>     <span style=color:#f92672>*</span>as_float;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>double</span>    <span style=color:#f92672>*</span>as_double;
</span></span><span style=display:flex><span>	} buf;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>size_t</span> offset;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>size_t</span> length;
</span></span><span style=display:flex><span>	buffer_view_type type;
</span></span><span style=display:flex><span>} buffer_view_object;
</span></span></code></pre></div><p>与<code>ArrayBuffer</code>类似，下面是<code>free</code>和<code>create_object</code>handler 的定义，由于很简单，只给出代码，不再做详细的分析：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> <span style=color:#66d9ef>void</span> <span style=color:#a6e22e>linger_array_buffer_view_free_object_storage</span>(buffer_view_object <span style=color:#f92672>*</span>intern TSRMLS_DC)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>zend_object_std_dtor</span>(<span style=color:#f92672>&amp;</span>intern<span style=color:#f92672>-&gt;</span>std TSRMLS_CC);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (intern<span style=color:#f92672>-&gt;</span>buffer_zval) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>zval_ptr_dtor</span>(<span style=color:#f92672>&amp;</span>intern<span style=color:#f92672>-&gt;</span>buffer_zval);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>linger_efree</span>(intern);
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>zend_object_value <span style=color:#a6e22e>linger_array_buffer_view_create_object</span>(zend_class_entry <span style=color:#f92672>*</span>class_type TSRMLS_CC)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	zend_object_value retval;
</span></span><span style=display:flex><span>	buffer_view_object <span style=color:#f92672>*</span>intern <span style=color:#f92672>=</span> <span style=color:#a6e22e>emalloc</span>(<span style=color:#66d9ef>sizeof</span>(buffer_view_object));
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>memset</span>(intern, <span style=color:#ae81ff>0</span>, <span style=color:#66d9ef>sizeof</span>(buffer_view_object));
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>zend_object_std_init</span>(<span style=color:#f92672>&amp;</span>intern<span style=color:#f92672>-&gt;</span>std, class_type TSRMLS_CC);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>object_properties_init</span>(<span style=color:#f92672>&amp;</span>intern<span style=color:#f92672>-&gt;</span>std, class_type);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		zend_class_entry <span style=color:#f92672>*</span>base_class_type <span style=color:#f92672>=</span> class_type;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>while</span> (base_class_type<span style=color:#f92672>-&gt;</span>parent) {
</span></span><span style=display:flex><span>			base_class_type <span style=color:#f92672>=</span> base_class_type<span style=color:#f92672>-&gt;</span>parent;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (base_class_type <span style=color:#f92672>==</span> int8_array_ce) {
</span></span><span style=display:flex><span>			intern<span style=color:#f92672>-&gt;</span>type <span style=color:#f92672>=</span> buffer_view_int8;
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (base_class_type <span style=color:#f92672>==</span> uint8_array_ce) {
</span></span><span style=display:flex><span>			intern<span style=color:#f92672>-&gt;</span>type <span style=color:#f92672>=</span> buffer_view_uint8;
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (base_class_type <span style=color:#f92672>==</span> int16_array_ce) {
</span></span><span style=display:flex><span>			intern<span style=color:#f92672>-&gt;</span>type <span style=color:#f92672>=</span> buffer_view_int16;
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (base_class_type <span style=color:#f92672>==</span> uint16_array_ce) {
</span></span><span style=display:flex><span>			intern<span style=color:#f92672>-&gt;</span>type <span style=color:#f92672>=</span> buffer_view_uint16;
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (base_class_type <span style=color:#f92672>==</span> int32_array_ce) {
</span></span><span style=display:flex><span>			intern<span style=color:#f92672>-&gt;</span>type <span style=color:#f92672>=</span> buffer_view_int32;
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (base_class_type <span style=color:#f92672>==</span> uint32_array_ce) {
</span></span><span style=display:flex><span>			intern<span style=color:#f92672>-&gt;</span>type <span style=color:#f92672>=</span> buffer_view_uint32;
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (base_class_type <span style=color:#f92672>==</span> float_array_ce) {
</span></span><span style=display:flex><span>			intern<span style=color:#f92672>-&gt;</span>type <span style=color:#f92672>=</span> buffer_view_float;
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (base_class_type <span style=color:#f92672>==</span> double_array_ce) {
</span></span><span style=display:flex><span>			intern<span style=color:#f92672>-&gt;</span>type <span style=color:#f92672>=</span> buffer_view_double;
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>zend_error</span>(E_ERROR, <span style=color:#e6db74>&#34;Buffer view does not have a valid base class&#34;</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	retval.handle <span style=color:#f92672>=</span> <span style=color:#a6e22e>zend_objects_store_put</span>(
</span></span><span style=display:flex><span>			intern,
</span></span><span style=display:flex><span>			(<span style=color:#66d9ef>zend_objects_store_dtor_t</span>) zend_objects_destroy_object,
</span></span><span style=display:flex><span>			(<span style=color:#66d9ef>zend_objects_free_object_storage_t</span>) linger_array_buffer_view_free_object_storage,
</span></span><span style=display:flex><span>			NULL
</span></span><span style=display:flex><span>			TSRMLS_CC
</span></span><span style=display:flex><span>			);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	retval.handlers <span style=color:#f92672>=</span> <span style=color:#f92672>&amp;</span>linger_array_buffer_view_handlers;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> retval;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>但是上述代码还需要特别说明的是，在<code>create_object</code>handler 中我们额外的使用迭代来获取<code>buffer view</code>的基类，这是很有必要的，
因为很视图类有可能会是一个派生类。</p><p>然后就是<code>clone</code>handler 的实现：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>static</span> zend_object_value <span style=color:#a6e22e>linger_array_buffer_view_clone</span>(zval <span style=color:#f92672>*</span>object TSRMLS_DC)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	buffer_view_object <span style=color:#f92672>*</span>old_object <span style=color:#f92672>=</span> <span style=color:#a6e22e>zend_object_store_get_object</span>(object TSRMLS_CC);
</span></span><span style=display:flex><span>	zend_object_value new_object_val <span style=color:#f92672>=</span> <span style=color:#a6e22e>linger_array_buffer_view_create_object</span>(<span style=color:#a6e22e>Z_OBJCE_P</span>(object) TSRMLS_CC);
</span></span><span style=display:flex><span>	buffer_view_object <span style=color:#f92672>*</span>new_object <span style=color:#f92672>=</span> <span style=color:#a6e22e>zend_object_store_get_object_by_handle</span>(new_object_val.handle TSRMLS_CC);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>zend_objects_clone_members</span>(<span style=color:#f92672>&amp;</span>new_object<span style=color:#f92672>-&gt;</span>std, new_object_val, <span style=color:#f92672>&amp;</span>old_object<span style=color:#f92672>-&gt;</span>std, <span style=color:#a6e22e>Z_OBJ_HANDLE_P</span>(object) TSRMLS_CC);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	new_object<span style=color:#f92672>-&gt;</span>buffer_zval <span style=color:#f92672>=</span> old_object<span style=color:#f92672>-&gt;</span>buffer_zval;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (new_object<span style=color:#f92672>-&gt;</span>buffer_zval) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Z_ADDREF_P</span>(new_object<span style=color:#f92672>-&gt;</span>buffer_zval);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	new_object<span style=color:#f92672>-&gt;</span>buf.as_int8 <span style=color:#f92672>=</span> old_object<span style=color:#f92672>-&gt;</span>buf.as_int8;
</span></span><span style=display:flex><span>	new_object<span style=color:#f92672>-&gt;</span>offset <span style=color:#f92672>=</span> old_object<span style=color:#f92672>-&gt;</span>offset;
</span></span><span style=display:flex><span>	new_object<span style=color:#f92672>-&gt;</span>length <span style=color:#f92672>=</span> old_object<span style=color:#f92672>-&gt;</span>length;
</span></span><span style=display:flex><span>	new_object<span style=color:#f92672>-&gt;</span>type <span style=color:#f92672>=</span> old_object<span style=color:#f92672>-&gt;</span>type;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> new_object_val;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>接下来我们来实现视图类的构造函数，代码平淡无奇：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#a6e22e>PHP_FUNCTION</span>(linger_array_buffer_view_ctor)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	zval <span style=color:#f92672>*</span>buffer_zval;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>long</span> offset <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>, length <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>;
</span></span><span style=display:flex><span>	buffer_object <span style=color:#f92672>*</span>buffer_intern;
</span></span><span style=display:flex><span>	buffer_view_object <span style=color:#f92672>*</span>view_intern;
</span></span><span style=display:flex><span>	zend_error_handling error_handling;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>zend_replace_error_handling</span>(EH_THROW, NULL, <span style=color:#f92672>&amp;</span>error_handling TSRMLS_CC);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>zend_parse_parameters</span>(<span style=color:#a6e22e>ZEND_NUM_ARGS</span>() TSRMLS_CC, <span style=color:#e6db74>&#34;o|ll&#34;</span>, <span style=color:#f92672>&amp;</span>buffer_zval, linger_array_buffer_ce, <span style=color:#f92672>&amp;</span>offset, <span style=color:#f92672>&amp;</span>length) <span style=color:#f92672>==</span> FAILURE) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>zend_restore_error_handling</span>(<span style=color:#f92672>&amp;</span>error_handling TSRMLS_CC);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>zend_restore_error_handling</span>(<span style=color:#f92672>&amp;</span>error_handling TSRMLS_CC);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	view_intern <span style=color:#f92672>=</span> <span style=color:#a6e22e>zend_object_store_get_object</span>(<span style=color:#a6e22e>getThis</span>() TSRMLS_CC);
</span></span><span style=display:flex><span>	buffer_intern <span style=color:#f92672>=</span> <span style=color:#a6e22e>zend_object_store_get_object</span>(buffer_zval TSRMLS_CC);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (offset <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>zend_throw_exception</span>(NULL, <span style=color:#e6db74>&#34;Offset must be non-negative&#34;</span>, <span style=color:#ae81ff>0</span> TSRMLS_CC);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (offset <span style=color:#f92672>&gt;=</span> buffer_intern<span style=color:#f92672>-&gt;</span>length) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>zend_throw_exception</span>(NULL, <span style=color:#e6db74>&#34;Offset has to be smaller than the buffer length&#34;</span>, <span style=color:#ae81ff>0</span> TSRMLS_CC);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (length <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>zend_throw_excpetion</span>(NULL, <span style=color:#e6db74>&#34;Length must be positive or zero&#34;</span>, <span style=color:#ae81ff>0</span> TSRMLS_CC);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	view_intern<span style=color:#f92672>-&gt;</span>offset <span style=color:#f92672>=</span> offset;
</span></span><span style=display:flex><span>	view_intern<span style=color:#f92672>-&gt;</span>buffer_zval <span style=color:#f92672>=</span> buffer_zval;
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Z_ADDREF_P</span>(buffer_zval);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	{
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>size_t</span> bytes_per_element <span style=color:#f92672>=</span> <span style=color:#a6e22e>linger_buffer_view_get_bytes_per_element</span>(view_intern);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>size_t</span> max_length <span style=color:#f92672>=</span> (buffer_intern<span style=color:#f92672>-&gt;</span>length <span style=color:#f92672>-</span> offset) <span style=color:#f92672>/</span> bytes_per_element;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (length <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span>) {
</span></span><span style=display:flex><span>			view_intern<span style=color:#f92672>-&gt;</span>length <span style=color:#f92672>=</span> max_length;
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (length <span style=color:#f92672>&gt;</span> max_length) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>zend_throw_exception</span>(NULL, <span style=color:#e6db74>&#34;Length is large than the buffer&#34;</span>, <span style=color:#ae81ff>0</span> TSRMLS_CC);
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			view_intern<span style=color:#f92672>-&gt;</span>length <span style=color:#f92672>=</span> length;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	view_intern<span style=color:#f92672>-&gt;</span>buf.as_int8 <span style=color:#f92672>=</span> buffer_intern<span style=color:#f92672>-&gt;</span>buffer;
</span></span><span style=display:flex><span>	view_intern<span style=color:#f92672>-&gt;</span>buf.as_int8 <span style=color:#f92672>+=</span> offset;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>构造函数中使用到了一个<code>buffer_view_get_bytes_per_element</code>，它是用来返回每种视图类型的基本类型占用多少字节的空间：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>size_t</span> <span style=color:#a6e22e>linger_buffer_view_get_bytes_per_element</span>(buffer_view_object <span style=color:#f92672>*</span>intern)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>switch</span> (intern<span style=color:#f92672>-&gt;</span>type) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> buffer_view_int8:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> buffer_view_uint8:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>1</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> buffer_view_int16:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> buffer_view_uint16:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>2</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> buffer_view_int32:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> buffer_view_uint32:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> buffer_view_float:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>4</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> buffer_view_double:
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span> <span style=color:#ae81ff>8</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>zend_error_noreturn</span>(E_ERROR, <span style=color:#e6db74>&#34;Invalid buffer view type&#34;</span>);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在这里，需要特别说明的是，<code>ArrayBuffer</code>和<code>ArrayBufferView</code>的联系是通过<code>union{}buf</code>这个联合体存储，这里的用法是非常巧妙的，
由于联合体的特性，它在一个共有的空间内每次至多只存储一种数据类型，而其中存放的又是某种类型的指针（其实就是一个数组）,在构
造视图类的时候，我们将视图结构体中的 buf 的起始位置指向<code>ArrayBuffer</code>中的<code>buffer</code>的起始位置，然后在进行插入和取出的时候，充
分利用 c 语言数组和指针的特性，很巧妙的对内存区块进行读写，从而达到目的。</p><p>到此，一切准备工作已经完成了，我们可以开始写真正的视图操作函数。</p><p>首先实现<code>offset set</code>操作:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#66d9ef>void</span> <span style=color:#a6e22e>linger_buffer_view_offset_set</span>(buffer_view_object <span style=color:#f92672>*</span>intern, <span style=color:#66d9ef>long</span> offset, zval <span style=color:#f92672>*</span>value)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (intern<span style=color:#f92672>-&gt;</span>type <span style=color:#f92672>==</span> buffer_view_float <span style=color:#f92672>||</span> intern<span style=color:#f92672>-&gt;</span>type <span style=color:#f92672>==</span> buffer_view_double) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Z_ADDREF_P</span>(value);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>convert_to_double_ex</span>(<span style=color:#f92672>&amp;</span>value);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> (intern<span style=color:#f92672>-&gt;</span>type <span style=color:#f92672>==</span> buffer_view_float) {
</span></span><span style=display:flex><span>			intern<span style=color:#f92672>-&gt;</span>buf.as_float[offset] <span style=color:#f92672>=</span> <span style=color:#a6e22e>Z_DAVL_P</span>(value);
</span></span><span style=display:flex><span>		} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>			intern<span style=color:#f92672>-&gt;</span>buf.as_double[offset] <span style=color:#f92672>=</span> <span style=color:#a6e22e>Z_DAVL_P</span>(value);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>zval_ptr_dtor</span>(<span style=color:#f92672>&amp;</span>value);
</span></span><span style=display:flex><span>	} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Z_ADDREF_P</span>(value);
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>convert_to_long_ex</span>(<span style=color:#f92672>&amp;</span>value);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>switch</span> (intern<span style=color:#f92672>-&gt;</span>type) {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>case</span> buffer_view_int8:
</span></span><span style=display:flex><span>				intern<span style=color:#f92672>-&gt;</span>buf.as_int8[offset] <span style=color:#f92672>=</span> <span style=color:#a6e22e>Z_LVAL_P</span>(value);
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>case</span> buffer_view_uint8:
</span></span><span style=display:flex><span>				intern<span style=color:#f92672>-&gt;</span>buf.as_uint8[offset] <span style=color:#f92672>=</span> <span style=color:#a6e22e>Z_LVAL_P</span>(value);
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>case</span> buffer_view_int16:
</span></span><span style=display:flex><span>				intern<span style=color:#f92672>-&gt;</span>buf.as_int16[offset] <span style=color:#f92672>=</span> <span style=color:#a6e22e>Z_LVAL_P</span>(value);
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>case</span> buffer_view_uint16:
</span></span><span style=display:flex><span>				intern<span style=color:#f92672>-&gt;</span>buf.as_uint16[offset] <span style=color:#f92672>=</span> <span style=color:#a6e22e>Z_LVAL_P</span>(value);
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>case</span> buffer_view_int32:
</span></span><span style=display:flex><span>				intern<span style=color:#f92672>-&gt;</span>buf.as_int32[offset] <span style=color:#f92672>=</span> <span style=color:#a6e22e>Z_LVAL_P</span>(value);
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>case</span> buffer_view_uint32:
</span></span><span style=display:flex><span>				intern<span style=color:#f92672>-&gt;</span>buf.as_uint32[offset] <span style=color:#f92672>=</span> <span style=color:#a6e22e>Z_LVAL_P</span>(value);
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>zend_error</span>(E_ERROR, <span style=color:#e6db74>&#34;Invalid buffer view type&#34;</span>);
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>zval_ptr_dtor</span>(<span style=color:#f92672>&amp;</span>value);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PHP_FUNCTION</span>(linger_array_buffer_view_offset_set)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	buffer_view_object <span style=color:#f92672>*</span>intern;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>long</span> offset;
</span></span><span style=display:flex><span>	zval <span style=color:#f92672>*</span>value;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>zend_parse_parameters</span>(<span style=color:#a6e22e>ZEND_NUM_ARGS</span>() TSRMLS_CC, <span style=color:#e6db74>&#34;lz&#34;</span>, <span style=color:#f92672>&amp;</span>offset, <span style=color:#f92672>&amp;</span>value) <span style=color:#f92672>==</span> FAILURE) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	intern <span style=color:#f92672>=</span> <span style=color:#a6e22e>zend_object_store_get_object</span>(<span style=color:#a6e22e>getThis</span>() TSRMLS_CC);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (offset <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> offset <span style=color:#f92672>&gt;=</span> intern<span style=color:#f92672>-&gt;</span>length) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>zend_throw_excpetion</span>(NULL, <span style=color:#e6db74>&#34;Offset is outside the buffer range&#34;</span>, <span style=color:#ae81ff>0</span> TSRMLS_CC);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>linger_buffer_view_offset_set</span>(intern, offset, value);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	RETURN_TRUE;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>代码平淡无奇，这里就不做过多的解释，同样很简单的来实现<code>offset get</code>操作：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=display:flex><span>zval <span style=color:#f92672>*</span><span style=color:#a6e22e>linger_buffer_view_offset_get</span>(buffer_view_object <span style=color:#f92672>*</span>intern, <span style=color:#66d9ef>size_t</span> offset)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	zval <span style=color:#f92672>*</span>retval;
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>MAKE_STD_ZVAL</span>(retval);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>switch</span> (intern<span style=color:#f92672>-&gt;</span>type) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> buffer_view_int8:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ZVAL_LONG</span>(retval, intern<span style=color:#f92672>-&gt;</span>buf.as_int8[offset]);
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> buffer_view_uint8:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ZVAL_LONG</span>(retval, intern<span style=color:#f92672>-&gt;</span>buf.as_uint8[offset]);
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> buffer_view_int16:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ZVAL_LONG</span>(retval, intern<span style=color:#f92672>-&gt;</span>buf.as_int16[offset]);
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> buffer_view_uint16:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ZVAL_LONG</span>(retval, intern<span style=color:#f92672>-&gt;</span>buf.as_uint16[offset]);
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> buffer_view_int32:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ZVAL_LONG</span>(retval, intern<span style=color:#f92672>-&gt;</span>buf.as_int32[offset]);
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> buffer_view_uint32: {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>uint32_t</span> value <span style=color:#f92672>=</span> intern<span style=color:#f92672>-&gt;</span>buf.as_uint32[offset];
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>if</span> (value <span style=color:#f92672>&lt;=</span> LONG_MAX) {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>ZVAL_LONG</span>(retval, value);
</span></span><span style=display:flex><span>			} <span style=color:#66d9ef>else</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>ZVAL_DOUBLE</span>(retval, value);
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> buffer_view_float:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ZVAL_DOUBLE</span>(retval, intern<span style=color:#f92672>-&gt;</span>buf.as_float[offset]);
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>case</span> buffer_view_double:
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>ZVAL_DOUBLE</span>(retval, intern<span style=color:#f92672>-&gt;</span>buf.as_double[offset]);
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>break</span>;
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>default</span><span style=color:#f92672>:</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>zend_error_noreturn</span>(E_ERROR, <span style=color:#e6db74>&#34;Invalid buffer view type&#34;</span>);
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> retval;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>PHP_FUNCTION</span>(linger_array_buffer_view_offset_get)
</span></span><span style=display:flex><span>{
</span></span><span style=display:flex><span>	buffer_view_object <span style=color:#f92672>*</span>intern;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>long</span> offset;
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>zend_parse_parameters</span>(<span style=color:#a6e22e>ZEND_NUM_ARGS</span>() TSRMLS_CC, <span style=color:#e6db74>&#34;l&#34;</span>, <span style=color:#f92672>&amp;</span>offset) <span style=color:#f92672>==</span> FAILURE) {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	intern <span style=color:#f92672>=</span> <span style=color:#a6e22e>zend_object_store_get_object</span>(<span style=color:#a6e22e>getThis</span>() TSRMLS_CC);
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> (offset <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>||</span> offset <span style=color:#f92672>&gt;=</span> intern<span style=color:#f92672>-&gt;</span>length) {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>zend_throw_exception</span>(NULL, <span style=color:#e6db74>&#34;Offset is outside the buffer range&#34;</span>, <span style=color:#ae81ff>0</span> TSRMLS_CC);
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span>;
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	zval <span style=color:#f92672>*</span>retval;
</span></span><span style=display:flex><span>	retval <span style=color:#f92672>=</span> <span style=color:#a6e22e>linger_buffer_view_offset_get</span>(intern, offset);
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>RETURN_ZVAL</span>(retval, <span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>1</span>);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>对于剩下的<code>offsetExists</code>和<code>offsetUnset</code>这里就不再赘述了。而且这里只实现了数据的基本存取操作，并没有实现<code>Iterator</code>接口，不支持<code>foreach</code>操作，
不过会在后续的文章中实现，今天的完整代码可到 github 上查看：<a href=https://github.com/iliubang/php_ArrayBuffer_extension.git target=_blank rel="noopener noreferrer">https://github.com/iliubang/php_ArrayBuffer_extension.git<i class="fas fa-external-link-square-alt ms-1"></i></a></p><p>编译后写个测试脚本：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-php data-lang=php><span style=display:flex><span><span style=color:#f92672>&lt;?</span><span style=color:#a6e22e>php</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$buffer <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>linger\ArrayBuffer</span>(<span style=color:#ae81ff>256</span>);
</span></span><span style=display:flex><span><span style=color:#a6e22e>var_dump</span>($buffer);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$int32 <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>linger\ArrayBufferView\Int32Array</span>($buffer);
</span></span><span style=display:flex><span><span style=color:#a6e22e>var_dump</span>($int32);
</span></span><span style=display:flex><span>$uint8 <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>linger\ArrayBufferView\UInt8Array</span>($buffer);
</span></span><span style=display:flex><span><span style=color:#a6e22e>var_dump</span>($uint8);
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> ($i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; $i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>255</span>; $i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    $uint8[$i] <span style=color:#f92672>=</span> $i;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> ($i <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; $i <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>255</span>; $i<span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>echo</span> $int32[$i], <span style=color:#e6db74>&#34;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>&#34;</span>;
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>同样的代码可以用 js 测试一下：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>buffer</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>ArrayBuffer</span>(<span style=color:#ae81ff>256</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>uint8</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Uint8Array</span>(<span style=color:#a6e22e>buffer</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>int32</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Int32Array</span>(<span style=color:#a6e22e>buffer</span>);
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>255</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>uint8</span>[<span style=color:#a6e22e>i</span>] <span style=color:#f92672>=</span> <span style=color:#a6e22e>i</span>;
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> (<span style=color:#a6e22e>i</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>255</span>; <span style=color:#a6e22e>i</span><span style=color:#f92672>++</span>) {
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>int32</span>[<span style=color:#a6e22e>i</span>]);
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>结果是一致的。</p></div></div><div class="modal fade" id=rewardModal tabindex=-1 aria-labelledby=rewardModalLabel aria-hidden=true><div class=modal-dialog><div class="modal-content surface"><div class=modal-header><h5 class="modal-title text-surface" id=rewardModalLabel><i class="fas fa-fw fa-coffee me-1"></i>打赏</h5><a href=# data-bs-dismiss=modal class=btn-close aria-label=Close></a></div><div class=modal-body><ul class="nav nav-tabs mb-3" role=tablist><li class="nav-item text-nowrap" role=presentation><a class="nav-link active" id=reward-alipay-tab data-bs-toggle=tab href=#reward-alipay role=tab aria-controls=reward-alipay aria-selected=true><i class="fab fa-fw fa-alipay me-1"></i>支付宝</a></li><li class="nav-item text-nowrap" role=presentation><a class=nav-link id=reward-wechat-tab data-bs-toggle=tab href=#reward-wechat role=tab aria-controls=reward-wechat aria-selected=true><i class="fab fa-fw fa-weixin me-1"></i>微信</a></li></ul><div class=tab-content id=rewardTabContent><div class="tab-pane fade post-reward-content text-center show active" id=reward-alipay role=tabpanel aria-labelledby=reward-alipay-tab><img class="img-fluid post-reward-img" src=https://iliubang.cn/images/reward/alipay.jpg loading=lazy data-viewer-invisible></div><div class="tab-pane fade post-reward-content text-center show" id=reward-wechat role=tabpanel aria-labelledby=reward-wechat-tab><img class="img-fluid post-reward-img" src=https://iliubang.cn/images/reward/wechat.jpg loading=lazy data-viewer-invisible></div></div></div></div></div></div></div><div class=card-footer><div class="post-navs d-flex justify-content-evenly"><div class="post-nav post-prev"><i class="fas fa-fw fa-chevron-down post-prev-icon me-1" data-fa-transform=rotate-90></i>
<a href=/posts/php/2017-08-24-php%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91%E4%B9%8B%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%AD%98%E5%82%A8/>PHP扩展开发之自定义对象的存储</a></div><div class="post-nav post-next"><a href=/posts/php/2017-08-27-php%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91%E4%B9%8B%E5%AF%B9%E8%B1%A1%E5%A4%84%E7%90%86%E5%99%A8/>PHP扩展开发之对象处理器(Object Handlers)</a>
<i class="fas fa-fw fa-chevron-down post-next-icon ms-1" data-fa-transform=rotate-270></i></div></div></div></article><div class="post-copyright mb-3 row card component" id=post-copyright><div class=card-header><h2 class="card-title fs-4 my-2 text-surface">版权</h2></div><div class=card-body><a class="d-flex align-items-center flex-column" target=_blank rel="license noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh><span><i class="fab fa-fw fa-2x fa-creative-commons"></i><i class="fab fa-fw fa-2x fa-creative-commons-by"></i><i class="fab fa-fw fa-2x fa-creative-commons-nc"></i><i class="fab fa-fw fa-2x fa-creative-commons-nd"></i></span>
CC BY-NC-ND 4.0</a></div></div><div class="card component row post-comments" id=post-comments><div class=card-header><h2 class="card-title my-2 fs-4 text-surface">评论</h2></div><div class=card-body><script src=https://utteranc.es/client.js repo=liubang/blog issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></div></div></div></div><aside class="col-xxl-4 sidebar d-flex"><div class="container d-flex flex-column"><div class="accordion profile"><div class="accordion-item card row text-center component"><div class="accordion-header card-header border-0" id=profile-header><a class="accordion-button d-lg-none mb-2 shadow-none p-0 bg-transparent text-surface collapsed" role=button data-bs-toggle=collapse href=#profile aria-expanded=false aria-controls=profile>Profile</a></div><div class="card-body collapse accordion-collapse accordion-body d-lg-block" id=profile aria-labelledby=profile-header><div class="col-12 d-flex align-items-center justify-content-center"><picture><img class="profile-avatar rounded-circle" alt=liubang src="https://iliubang.cn/images/profile.webp?v=7fdc4e1b5785be32c88d453deb32ca63" loading=lazy data-viewer-invisible width=484 height=483></picture></div><div class="col-12 profile-meta"><div class="profile-name fw-fold fs-lg">liubang</div><div class=profile-bio>Whether you are an antelope or a lion, you ought to dash forward without hesitation when the sun rise</div><div class=profile-company><i class="fas fa-fw fa-building"></i>Baidu</div><div class=profile-location><i class="fas fa-fw fa-map-marker-alt"></i>China</div><a class="profile-about text-primary" href=/about/><i class="fas fa-fw fa-user"></i>关于</a></div></div></div></div><div class="accordion taxonomies-toggle"><div class="row card component accordion-item"><div class="accordion-header card-header border-0"><a class="accordion-button d-lg-none mb-1 shadow-none p-0 bg-transparent collapsed" role=button data-bs-toggle=collapse href=#taxonomies-toggle aria-expanded=false aria-controls=taxonomies-toggle>Taxonomies</a></div><div class="card-body collapse accordion-collapse accordion-body d-lg-block" id=taxonomies-toggle><ul class="nav nav-pills nav-fill" role=tablist><li class=nav-item role=presentation><button class="nav-link active" id=taxonomyTagsTab data-bs-toggle=tab data-bs-target=#taxonomyTags type=button role=tab aria-controls=taxonomyTags aria-selected=true>
标签</button></li><li class=nav-item role=presentation><button class=nav-link id=taxonomySeriesTab data-bs-toggle=tab data-bs-target=#taxonomySeries type=button role=tab aria-controls=taxonomySeries aria-selected=true>
专栏</button></li><li class=nav-item role=presentation><button class=nav-link id=taxonomyArchivesTab data-bs-toggle=tab data-bs-target=#taxonomyArchives type=button role=tab aria-controls=taxonomyArchives aria-selected=true>
归档</button></li></ul><div class="tab-content mt-3"><div class="tab-pane active" id=taxonomyTags role=tabpanel aria-labelledby=taxonomyTagsTab tabindex=0><a href=/tags/c++/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=C++>C++
<span class="badge badge-sm text-secondary bg-white ms-1">18</span>
</a><a href=/tags/c/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=C>C
<span class="badge badge-sm text-secondary bg-white ms-1">14</span>
</a><a href=/tags/php/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=Php>Php
<span class="badge badge-sm text-secondary bg-white ms-1">8</span>
</a><a href=/tags/sp/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=Sp>Sp
<span class="badge badge-sm text-secondary bg-white ms-1">5</span>
</a><a href=/tags/c++17/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=C++17>C++17
<span class="badge badge-sm text-secondary bg-white ms-1">4</span>
</a><a href=/tags/java/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=Java>Java
<span class="badge badge-sm text-secondary bg-white ms-1">4</span>
</a><a href=/tags/stack/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=Stack>Stack
<span class="badge badge-sm text-secondary bg-white ms-1">4</span>
</a><a href=/tags/c++11/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=C++11>C++11
<span class="badge badge-sm text-secondary bg-white ms-1">3</span>
</a><a href=/tags/dp/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=DP>DP
<span class="badge badge-sm text-secondary bg-white ms-1">3</span>
</a><a href=/tags/jni/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=JNI>JNI
<span class="badge badge-sm text-secondary bg-white ms-1">3</span>
</a><a href=https://iliubang.cn/tags class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=全部>全部
<span class="badge badge-sm text-secondary bg-white ms-1">30</span></a></div><div class=tab-pane id=taxonomySeries role=tabpanel aria-labelledby=taxonomySeriesTab tabindex=0><a href=/series/leetcode/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-series me-2 mb-2" title=LeetCode>LeetCode
<span class="badge badge-sm text-secondary bg-white ms-1">14</span></a></div><div class=tab-pane id=taxonomyArchives role=tabpanel aria-labelledby=taxonomyArchivesTab tabindex=0><a href=/archives/2023/ class="btn btn-sm btn-secondary post-taxonomy ps-3 me-2 mb-2" title=2023>2023 <span class="badge badge-sm text-secondary bg-white ms-1">1</span>
</a><a href=/archives/2022/ class="btn btn-sm btn-secondary post-taxonomy ps-3 me-2 mb-2" title=2022>2022 <span class="badge badge-sm text-secondary bg-white ms-1">13</span>
</a><a href=/archives/2021/ class="btn btn-sm btn-secondary post-taxonomy ps-3 me-2 mb-2" title=2021>2021 <span class="badge badge-sm text-secondary bg-white ms-1">1</span>
</a><a href=/archives/2020/ class="btn btn-sm btn-secondary post-taxonomy ps-3 me-2 mb-2" title=2020>2020 <span class="badge badge-sm text-secondary bg-white ms-1">1</span>
</a><a href=/archives/2019/ class="btn btn-sm btn-secondary post-taxonomy ps-3 me-2 mb-2" title=2019>2019 <span class="badge badge-sm text-secondary bg-white ms-1">4</span>
</a><a href=/archives/2018/ class="btn btn-sm btn-secondary post-taxonomy ps-3 me-2 mb-2" title=2018>2018 <span class="badge badge-sm text-secondary bg-white ms-1">10</span>
</a><a href=/archives/2017/ class="btn btn-sm btn-secondary post-taxonomy ps-3 me-2 mb-2" title=2017>2017 <span class="badge badge-sm text-secondary bg-white ms-1">15</span></a></div></div></div></div></div><div class="accordion posts-toggle"><div class="row card component accordion-item"><div class="accordion-header card-header border-0"><a class="accordion-button d-lg-none mb-1 shadow-none p-0 bg-transparent collapsed" role=button data-bs-toggle=collapse href=#posts-toggle aria-expanded=false aria-controls=posts-toggle>文章</a></div><div class="card-body collapse accordion-collapse accordion-body d-lg-block" id=posts-toggle><ul class="nav nav-pills nav-fill" role=tablist><li class=nav-item role=presentation><button class="nav-link active" id=recent-posts-tab data-bs-toggle=tab data-bs-target=#recent-posts type=button role=tab aria-controls=recent-posts aria-selected=true>
最近文章</button></li></ul><div class="tab-content mt-3"><div class="tab-pane active" id=recent-posts role=tabpanel aria-labelledby=recent-posts-tab tabindex=0><ul class="post-list list-unstyled ms-1"><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/posts/cpp/2023-05-23-%E4%BD%BF%E7%94%A8llvm%E7%9A%84libfuzzer%E8%BF%9B%E8%A1%8Cfuzzy-test/>使用LLVM的libFuzzer进行fuzzy test</a><div class="post-meta mt-2"><span class=post-date>May 23, 2023</span></div></div></div></li><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/posts/rust/2022-11-13-rust%E5%92%8Cc++%E5%AF%B9%E6%AF%94%E4%B9%8B%E6%B3%9B%E5%9E%8B%E5%92%8C%E7%89%B9%E4%BE%8B%E5%8C%96/>Rust和C++: 泛型和特例化</a><div class="post-meta mt-2"><span class=post-date>November 12, 2022</span></div></div></div></li><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/posts/rust/2022-11-01-rust%E5%92%8Cc++%E5%AF%B9%E6%AF%94%E4%B9%8B%E5%8F%AF%E5%8F%98%E6%80%A7%E7%A7%BB%E5%8A%A8%E5%92%8C%E6%89%80%E6%9C%89%E6%9D%83/>Rust和C++: 可变性、移动和所有权</a><div class="post-meta mt-2"><span class=post-date>November 1, 2022</span></div></div></div></li><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/posts/cpp/2022-09-28-%E4%B8%BA%E4%BB%80%E4%B9%88c++%E4%B8%AD%E6%9C%89%E4%BA%86%E5%87%BD%E6%95%B0%E6%8C%87%E9%92%88%E5%8D%B4%E8%BF%98%E9%9C%80%E8%A6%81stdfunction/>为什么c++中有了函数指针却还需要std::function</a><div class="post-meta mt-2"><span class=post-date>September 28, 2022</span></div></div></div></li><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=/posts/cpp/2022-05-15-%E4%BD%BF%E7%94%A8stdlist%E7%9A%84splice%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0lru-cache/>使用std::list的splice方法实现LRU Cache</a><div class="post-meta mt-2"><span class=post-date>May 15, 2022</span></div></div></div></li></ul></div></div></div></div></div><div class="accordion post-toc d-none d-lg-block"><div class="accordion-item row mb-4 card component" id=postTOC><div class="card-header accordion-header"><h2 class="card-title fs-4 my-2 text-surface d-none d-lg-block">目录</h2><a class="accordion-button d-lg-none mb-1 collapsed shadow-none p-0 bg-transparent" role=button data-bs-toggle=collapse href=#post-toc aria-expanded=false aria-controls=post-toc>目录</a></div><div class="card-body collapse accordion-collapse accordion-body d-lg-block" id=post-toc><nav id=TableOfContents><ul><li><a href=#arraybuffer-简介>ArrayBuffer 简介</a></li><li><a href=#定义-arraybuffer-的数据结构和相关-handlers>定义 ArrayBuffer 的数据结构和相关 handlers</a></li><li><a href=#buffer-view>buffer view</a></li></ul></nav></div></div></div></div></aside></div></main><footer class="footer mt-auto py-3 text-center container"><div class="offcanvas offcanvas-bottom h-auto" tabindex=-1 id=offcanvasActionsPanel aria-labelledby=offcanvasActionsPanelLabel><div class=offcanvas-header><div class="offcanvas-title h5" id=offcanvasActionsPanelLabel><i class="fas fa-fw fa-th-large me-1"></i>
操作</div><button type=button class="btn-close ms-auto" data-bs-dismiss=offcanvas data-bs-target=offcanvasActionsPanel aria-label=Close></button></div><div class="offcanvas-body mt-2"><div class="actions d-flex overflow-auto align-items-center"><a role=button class="action action-go-back d-flex flex-column align-items-center me-3" href="javascript: window.history.back();"><span class="action-icon mb-2"><i class="fas fa-2x fa-chevron-circle-down" data-fa-transform=rotate-90></i></span> 返回
</a><a role=button class="action action-reload-page d-flex flex-column align-items-center me-3"><span class="action-icon mb-2"><i class="fas fa-2x fa-redo-alt"></i></span> 刷新
</a><a role=button class="action action-copy-url d-flex flex-column align-items-center me-3"><span class="action-icon mb-2"><i class="fas fa-2x fa-link"></i></span> 复制链接</a></div></div></div><div class="row text-center"><div class="col-12 mt-2"><p class=mb-2>liubang's blog</p><p class="text-secondary mb-2"><small>刘邦的博客</small></p><div class="copyright mb-2 text-secondary"><small>Copyright © 2016-2024 LiuBang. All Rights Reserved.</small></div><div class="powered-by mb-2 text-secondary"><small>Build with ❤️ from the <a class=text-primary href=https://gohugo.io target=_blank rel="noopener noreferrer">Hugo</a> and the <a class=text-primary href=https://github.com/razonyang/hugo-theme-bootstrap target=_blank rel="noopener noreferrer">HBS</a> theme.</small></div><nav class="social-links nav justify-content-center mb-2 mt-3"><a class="nav-link social-link p-0 me-1 mb-2" href=mailto:it.liubang@gmail.com title=电子邮箱><i class="fas fa-fw fa-2x fa-envelope" style=color:#0963ac></i>
</a><a class="nav-link social-link p-0 me-1 mb-2" target=_blank href=https://github.com/liubang title=GitHub rel=me><i class="fa-fw fa-2x fab fa-github"></i>
</a><a class="nav-link social-link p-0 me-1 mb-2" target=_blank href="https://wpa.qq.com/msgrd?v=3&amp;uin=1301841042&amp;site=qq&amp;menu=yes" title=QQ rel=me><i class="fa-fw fa-2x fab fa-qq"></i>
</a><a class="nav-link social-link p-0 me-1 mb-2" target=_blank href=https://weibo.com/2113750192 title=微博 rel=me><i class="fa-fw fa-2x fab fa-weibo" style=color:#e1162c></i>
</a><a class="nav-link social-link p-0 me-1 mb-2" target=_blank href=/index.xml title=RSS rel=me><i class="fas fa-fw fa-2x fa-rss" style=color:#ea6221></i></a></nav></div><div class="col-12 col-lg-8 offset-0 offset-lg-1"></div></div></footer><script data-precache src=/assets/main/bundle.min.8cac337db334f5e88a0d3a39ecd178e8c95439cccc154f0409d8084910de52b6.js integrity="sha256-jKwzfbM09eiKDTo57NF46MlUOczMFU8ECdgISRDeUrY=" crossorigin=anonymous async></script><script data-precache src=/assets/icons/bundle.min.1edf0be44ac92fc373eca5ba12ce1f444409c1a5ea989cc1338c8d660a99f81f.js integrity="sha256-Ht8L5ErJL8Nz7KW6Es4fREQJwaXqmJzBM4yNZgqZ+B8=" crossorigin=anonymous defer></script><script data-precache src=/assets/viewer/bundle.min.945567884be417f2aa4a3f7fb0171fc00a214c3c63dd586d110fc7b77d4d6077.js integrity="sha256-lFVniEvkF/KqSj9/sBcfwAohTDxj3VhtEQ/Ht31NYHc=" crossorigin=anonymous defer></script><script data-precache defer src=/assets/katex/bundle.min.ecfaac987a9ad8e8c435500e3a2dc277d9c1bdedc12ea02390b093db3788c0d4.js integrity="sha256-7PqsmHqa2OjENVAOOi3Cd9nBve3BLqAjkLCT2zeIwNQ=" crossorigin=anonymous></script><script data-precache defer src=/assets/mermaid/bundle.min.d16e7a97a0908ae444f9e9f4adb15493b9a77d27e8636078275173704d90bfa4.js integrity="sha256-0W56l6CQiuRE+en0rbFUk7mnfSfoY2B4J1FzcE2Qv6Q=" crossorigin=anonymous></script><script src=/js/sw-register.js defer></script></body></html>