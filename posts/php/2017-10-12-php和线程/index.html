<!doctype html><html class=position-relative itemscope itemtype=http://schema.org/WebPage lang=zh-cn data-bs-theme=auto data-palette=blue-gray><head><script src=https://iliubang.cn/assets/init/bundle.min.db17fe65e9598d7c8f1358915d79f57498deecbe945690ee0242f5890626acd7.js integrity="sha256-2xf+ZelZjXyPE1iRXXn1dJje7L6UVpDuAkL1iQYmrNc=" crossorigin=anonymous></script><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>PHP和线程 - liubang's blog</title><link rel=icon href=https://iliubang.cn/favicon_huc1d2ba7c7d6d5aa3e01f2f328b911c53_11507_16x16_resize_box_3.png sizes=16x16 type=image/png><link rel=icon href=https://iliubang.cn/favicon_huc1d2ba7c7d6d5aa3e01f2f328b911c53_11507_32x32_resize_box_3.png sizes=32x32 type=image/png><link rel=apple-touch-icon href=https://iliubang.cn/favicon_huc1d2ba7c7d6d5aa3e01f2f328b911c53_11507_180x180_resize_box_3.png sizes=180x180 type=image/png><link rel=icon href=https://iliubang.cn/favicon_huc1d2ba7c7d6d5aa3e01f2f328b911c53_11507_150x150_resize_box_3.png sizes=150x150 type=image/png><link rel=icon href="https://iliubang.cn/images/icons/icon-192x192.png?version=5675e36f11a529bcbecb4e1fae90c416" sizes=192x192><link rel=mask-icon href=https://iliubang.cn/safari-pinned-tab.svg color=#6f42c1><link rel=icon href="https://iliubang.cn/images/icons/favicon.ico?version=93c96d13551a46e5742ae6da86026661"><meta name=keywords content><meta name=description content="原文地址http://blog.jpauli.tech/2017/01/12/threads-and-php.html 前言# PHP 和线程，单凭这"><meta name=robots content="index, follow"><meta name=twitter:card content="summary"><meta name=twitter:title content="PHP和线程"><meta name=twitter:description content="原文地址http://blog.jpauli.tech/2017/01/12/threads-and-php.html 前言# PHP 和线程，单凭这"><meta property="og:title" content="PHP和线程"><meta property="og:description" content="原文地址http://blog.jpauli.tech/2017/01/12/threads-and-php.html 前言# PHP 和线程，单凭这"><meta property="og:type" content="article"><meta property="og:url" content="https://iliubang.cn/posts/php/2017-10-12-php%E5%92%8C%E7%BA%BF%E7%A8%8B/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2017-10-12T00:00:00+00:00"><meta property="article:modified_time" content="2017-10-12T00:00:00+00:00"><meta itemprop=name content="PHP和线程"><meta itemprop=description content="原文地址http://blog.jpauli.tech/2017/01/12/threads-and-php.html 前言# PHP 和线程，单凭这"><meta itemprop=datePublished content="2017-10-12T00:00:00+00:00"><meta itemprop=dateModified content="2017-10-12T00:00:00+00:00"><meta itemprop=wordCount content="8204"><meta itemprop=keywords content="c,php,"><meta property="og:image" content="https://iliubang.cn/images/apple-touch-icon.png"><meta name=twitter:image content="https://iliubang.cn/images/apple-touch-icon.png"><link rel=manifest href=https://iliubang.cn/manifest.json><link data-precache rel=stylesheet href="https://iliubang.cn/assets/main/bundle.min.8ac973b385981e6e37f05a6cec0ba3ce115a304ea16d1e8a9c478873e325a693.css" integrity="sha256-islzs4WYHm438Fps7AujzhFaME6hbR6KnEeIc+MlppM=" crossorigin=anonymous><link data-precache rel=stylesheet href=https://iliubang.cn/assets/katex/bundle.min.c7738aed5534d96f5c4eb1790af05b44a2ca1cc7d0cb6d5de1dcf95595d3f91a.css integrity="sha256-x3OK7VU02W9cTrF5CvBbRKLKHMfQy21d4dz5VZXT+Ro=" crossorigin=anonymous><link data-precache rel=stylesheet href=https://iliubang.cn/assets/viewer/bundle.min.6d0fc65b8b058ac563091dc5c36f61afba5dd705058680aa24f1d5a3bcf0064d.css integrity="sha256-bQ/GW4sFisVjCR3Fw29hr7pd1wUFhoCqJPHVo7zwBk0=" crossorigin=anonymous></head><body><header><nav class="top-app-bar shadow navbar navbar-expand-lg fixed-top"><div class=container><a class="navbar-brand d-flex align-items-center flex-grow-1 flex-lg-grow-0 text-lg-start ms-2 ms-lg-0 mx-auto me-lg-2" href=https://iliubang.cn><picture><img class=logo alt=Logo src=https://iliubang.cn/images/apple-touch-icon.png loading=lazy width=180 height=180>
</picture>HIGHKYCK</a>
<button class="navbar-toggler order-5" type=button data-bs-toggle=offcanvas data-bs-target=#navbarMenus aria-controls=navbarMenus aria-expanded=false aria-label="Toggle navigation">
<i class="fas fa-ellipsis-h"></i></button><div class="offcanvas-lg offcanvas-end flex-grow-1" data-bs-scroll=true tabindex=-1 id=navbarMenus aria-labelledby=navbarMenusLabel><div class="offcanvas-header px-4 pb-0"><h5 class=offcanvas-title id=navbarMenusLabel>liubang's blog</h5><button type=button class="btn-close btn-close-white" data-bs-dismiss=offcanvas data-bs-target=#navbarMenus aria-label=Close></button></div><div class="offcanvas-body p-4 pt-0 p-lg-0"><hr class=d-lg-none><ul class="navbar-nav flex-row flex-wrap align-items-center me-auto"><li class="nav-item col-6 col-lg-auto"><a class="nav-link py-2 px-0 px-lg-2" href=https://iliubang.cn/archives/><i class="fas fa-fw fa-file-archive"></i>归档</a></li><li class="nav-item col-6 col-lg-auto dropdown px-0"><a href=# class="nav-link dropdown-toggle" id=navbarDropdownCategories role=button data-bs-toggle=dropdown aria-expanded=false><i class="fas fa-fw fa-folder"></i>分类</a><ul class="dropdown-menu dropdown-menu-end" aria-labelledby=navbarDropdownCategories data-bs-popper=none><li><a class="dropdown-item text-wrap text-lg-nowrap" href=https://iliubang.cn/categories/programming><i class="fas fa-fw fa-code me-1"></i>Programing</a></li><li><a class="dropdown-item text-wrap text-lg-nowrap" href=https://iliubang.cn/categories/reading><i class="fas fa-fw fa-book-reader me-1"></i>Reading</a></li><li><a class="dropdown-item text-wrap text-lg-nowrap" href=https://iliubang.cn/categories/linux><i class="fab fa-fw fa-linux me-1"></i>Linux</a></li><li><a class="dropdown-item text-wrap text-lg-nowrap" href=https://iliubang.cn/categories><i class="fas fa-fw fa-folder me-1"></i>所有分类</a></li></ul></li><li class="nav-item col-6 col-lg-auto dropdown px-0"><a href=# class="nav-link dropdown-toggle" id=navbarDropdownTags role=button data-bs-toggle=dropdown aria-expanded=false><i class="fas fa-fw fa-tags me-1"></i>标签</a><ul class="dropdown-menu dropdown-menu-end" aria-labelledby=navbarDropdownTags data-bs-popper=none><li><a class="dropdown-item text-wrap text-lg-nowrap" href=https://iliubang.cn/tags/algorithm><i class="fas fa-fw fa-square-root-alt me-1"></i>Algorithm</a></li><li><a class="dropdown-item text-wrap text-lg-nowrap" href=https://iliubang.cn/tags/c++><i class="fab fa-fw fa-google me-1"></i>C++</a></li><li><a class="dropdown-item text-wrap text-lg-nowrap" href=https://iliubang.cn/tags/go><i class="fab fa-fw fa-google me-1"></i>Go</a></li><li><a class="dropdown-item text-wrap text-lg-nowrap" href=https://iliubang.cn/tags/java><i class="fab fa-fw fa-java me-1"></i>Java</a></li><li><a class="dropdown-item text-wrap text-lg-nowrap" href=https://iliubang.cn/tags/storage><i class="fas fa-fw fa-database me-1"></i>Storage</a></li><li><a class="dropdown-item text-wrap text-lg-nowrap" href=https://iliubang.cn/tags><i class="fas fa-fw fa-tags me-1"></i>所有标签</a></li></ul></li><li class="nav-item col-6 col-lg-auto dropdown px-0"><a href=# class="nav-link dropdown-toggle" id=navbarDropdownSeries role=button data-bs-toggle=dropdown aria-expanded=false><i class="fas fa-fw fa-columns me-1"></i>专栏</a><ul class="dropdown-menu dropdown-menu-end" aria-labelledby=navbarDropdownSeries data-bs-popper=none><li><a class="dropdown-item text-wrap text-lg-nowrap" href=https://iliubang.cn/leetcode/>LeetCode</a></li></ul></li></ul><hr class=d-lg-none><form class="search-bar ms-auto my-1" action=https://iliubang.cn/search/ novalidate><div class="input-group input-group-sm align-items-center"><span class="btn btn-search disabled position-absolute left-0 border-0"><i class="fas fa-fw fa-search fa-lg"></i></span>
<input class="py-2 form-control rounded search-input" name=q type=search aria-label=Search required></div></form><hr class=d-lg-none><ul class="navbar-nav flex-row flex-wrap align-items-center ms-md-auto"><li class="nav-item py-2 py-lg-1 col-12 col-lg-auto"><nav class="social-links nav justify-content-center flex-row"><a class="nav-link social-link col-6 col-lg-auto p-1" target=_blank href=https://github.com/liubang title=GitHub rel="noopener noreferrer"><i class="fa-fw fab fa-github"></i>
<span class="ms-1 d-lg-none">Github</span></a>
<a class="nav-link social-link col-6 col-lg-auto p-1" target=_blank href=https://iliubang.cn/index.xml title=RSS rel="noopener noreferrer"><i class="fas fa-fw fa-rss"></i>
<span class="ms-1 d-lg-none">RSS</span></a></nav></li><li class="nav-item py-2 py-lg-1 col-12 col-lg-auto"><div class="vr d-none d-lg-flex h-100 mx-lg-2 text-white"></div><hr class="d-lg-none my-2"></li><li class="nav-item dropdown py-1 py-lg-1 col-6 col-lg-auto"><a class="nav-link px-0 px-lg-1" href=# id=languageDropdown role=button data-bs-toggle=dropdown aria-expanded=false><i class="fas fa-fw fa-globe"></i>
<span class=d-lg-none>语言</span></a><ul class="dropdown-menu dropdown-menu-end" aria-labelledby=languageDropdown><li><a class=dropdown-item href=https://iliubang.cn/en/>English</a></li><li><a class="dropdown-item active" href=https://iliubang.cn/>简体中文</a></li></ul></li><li class="nav-item py-1 col-12 col-lg-auto"><div class="vr d-none d-lg-flex h-100 mx-lg-2 text-white"></div><hr class="d-lg-none my-2"></li><li class="nav-item dropdown col-6 col-lg-auto"><a class="nav-link px-0 py-2 px-lg-1" href=# id=modeDropdown role=button data-bs-toggle=dropdown aria-expanded=false><i class="mode-icon fas fa-fw fa-adjust" id=modeIcon></i>
<span class=d-lg-none>模式</span></a><ul class="dropdown-menu dropdown-menu-end" aria-labelledby=modeDropdown><li class=mode-item data-color-mode=light data-icon=sun><button class=dropdown-item>
<i class="mode-icon fas fa-fw fa-sun"></i> Light</button></li><li class=mode-item data-color-mode=dark data-icon=moon><button class=dropdown-item>
<i class="mode-icon fas fa-fw fa-moon"></i> Dark</button></li><li class="mode-item active" data-color-mode=auto data-icon=adjust><button class=dropdown-item>
<i class="mode-icon fas fa-fw fa-adjust"></i> Auto</button></li></ul></li></ul></div></div></div></nav></header><main class=container><div class="row content"><noscript><div class="alert alert-danger" role=alert>你的浏览器不支持 JavaScript。</div></noscript><div class=col-lg-8><div class=container><nav class="row card component" aria-label=breadcrumb><div class="card-body pb-0"><ol class=breadcrumb><li class="breadcrumb-item text-surface"><a href=https://iliubang.cn/>主页</a></li><li class="breadcrumb-item text-surface"><a href=https://iliubang.cn/posts/>文章</a></li><li class="breadcrumb-item active">PHP和线程</li></ol></div></nav><div class="post-panel-wrapper position-sticky"><div class="d-flex flex-column component rounded post-panel position-absolute border"><a class="action action-panel-toggler" role=button title="Panel toggler"><i class="fas fa-fw fa-chevron-circle-down"></i></a>
<a id=sidebarToggler class="action d-none d-lg-block" role=button title="Sidebar toggler"><i class="fas fa-fw fa-expand-alt" data-fa-transform=rotate-45></i></a>
<a class="action btn-reward" role=button data-bs-toggle=modal data-bs-target=#rewardModal title=打赏><i class="fas fa-fw fa-coffee"></i></a>
<a class=action href=#post-copyright role=button aria-label=Copyright title=Copyright><i class="fas fa-fw fa-copyright"></i></a>
<a class=action href=#post-comments role=button aria-label=Comments title=Comments><i class="fas fa-fw fa-comments"></i></a>
<a class=action href=#postTOC aria-controls="Table of contents" role=button title="Table of contents"><i class="fas fa-fw fa-list-alt"></i></a></div></div><article class="row card component mb-4 post"><div class=card-header><h1 class="card-title post-title my-2">PHP和线程</h1></div><div class=card-body><div class="post-meta mb-3"><span class="post-date me-1 mb-1" title="创建于 2017-10-12 00:00:00 +0000 UTC。">2017-10-12</span><span class="post-reading-time me-1 mb-1">17 分钟阅读</span><a href=https://iliubang.cn/categories/programming/ class="btn btn-sm btn-secondary mb-1 me-2 py-0 pe-1 post-taxonomy post-category">
<i class="fas fa-fw fa-folder me-1"></i>Programming</a><a href=https://iliubang.cn/tags/c/ class="btn btn-sm btn-secondary mb-1 me-2 py-0 pe-1 post-taxonomy post-tag">C</a><a href=https://iliubang.cn/tags/php/ class="btn btn-sm btn-secondary mb-1 me-2 py-0 pe-1 post-taxonomy post-tag">Php</a></div><div id=postTOC class="mt-2 mb-4 d-block d-lg-none"><h2 class="text-surface mb-3">目录</h2><div id=post-toc-container></div></div><div class="post-content mb-3" data-bs-spy=scroll data-bs-target=#TableOfContents tabindex=0><div id=post-content-body><p>原文地址<a href=http://blog.jpauli.tech/2017/01/12/threads-and-php.html target=_blank rel="noopener noreferrer">http://blog.jpauli.tech/2017/01/12/threads-and-php.html<i class="fas fa-external-link-square-alt ms-1"></i></a></p><h2 id=前言 data-numberify>前言<a class="anchor ms-1 d-none" href=#前言>#</a></h2><p>PHP 和线程，单凭这简短的几个字，就足以写一本书。像往常一样，我们不会这么做，但是会给出一定程度上跟这个话题相关的信息与细节。让我们从一些人在谈论这个话题时通常感到的困惑开始，PHP 不是一种线程语言，
PHP 的内核没有使用线程，而且 PHP 天生也不允许用户层代码通过任何方式使用多线程作为并发机制。</p><p>因此 PHP 跟其他一些技术有很大的区别，例如 Java。Java 不仅自身使用了大量的线程，它还允许用户通过编程来是用线程。然而，PHP 不适用线程是有它的原因的。</p><p>PHP 内核没有使用线程，主要是为了简化开发。当你读到下一节的时候，你就会了解到线程并不是一个能使任何程序都能更快运行的魔法技术。是不是听起来很像是在推销不是吗？但是我们不是推销，而是谈论技术，而且
我们很清楚我们在说什么。因此 PHP 引擎目前没有使用多线程，也许将来会使用。但是使用多线程在编程上会引发很多问题，例如程序运行结果不是你所期待的等等。主要的困难是跨平坦的多线程编程，其次就是资源共享和
锁的管理，再次就是并不是所有的程序都能够被转化成多线程程序。PHP 的设计主要在 2000 前后，在那个时候，多线程编程并不是很广泛和成熟，PHP 引擎开发工程师决定创造一个完全没有线程的单片机引擎（当然他们也没有
足够的能力去驾驭一个稳定的跨平台的多线程引擎）。</p><p>PHP 用户层代码也不允许使用线程，因为那不是 PHP 期待你的代码运行的方式。PHP 是一个"发送并忘记(fire-and-forget)&ldquo;型的语言，你应该尽可能快的处理完请求，然后释放，然后接着处理下一个请求。PHP 被设计作为一种
胶水语言：你不用处理可能使用到线程的复杂任务，而是访问快速而且已经准备好的资源，将它们粘合到一起，然后再返回给用户。通过 PHP，无论什么可能花费比通常时间多的时间的任务，都不能用 PHP 来处理。这就是为什么
在 PHP 中我们通常使用基于消息队列的系统(Gearman, AMQP, ActiveMQ 等等)来异步处理一些耗时任务。正如 Unix 看待事物的方式：“开发小而完备的工具，然后将他们连接在一起”。因此 PHP 的设计不是允许大规模的并行，而是
其他专门的技术&ndash;是用正确的工具来解决特定的问题。</p><h2 id=线程的简介 data-numberify>线程的简介<a class="anchor ms-1 d-none" href=#线程的简介>#</a></h2><p>让我们来快速的介绍下线程。注意，我们不会阐述太多细节的东西，对于你想深入了解关于线程的任何细节，都可以在相关书籍和站点上找到。</p><p>线程是进程中的轻量的事务处理单元，注意，一个进程可以产生多个线程，一个线程必须有且只能属于一个进程。进程是操作系统中的基本工作处理单元。在多 CPU 的机器上，不同的 CPU 将会平行工作，这样对于计算能力的提升会
有很大的好处。如果进程 A 和 B 都准备被执行，而且两个 CPU（或者两个 CPU 核心）也都有空闲的负载，那么进程 A 和 B 将会同时被执行。因此，计算机将能高效的在一个单位时间内同时进行多个运算，我们称之为“并行”(parallelism)。</p><p>进程</p><p><picture><img class="img-fluid mx-auto d-block" alt=进程 src=https://iliubang.cn/images/2017-10-13/up.png loading=lazy width=210 height=244></picture></p><p>线程</p><p><picture><img class="img-fluid mx-auto d-block" alt=线程 src=https://iliubang.cn/images/2017-10-13/thread_structure.png loading=lazy width=185 height=268></picture></p><p>进程和线程的关系
<picture><img class="img-fluid mx-auto d-block" alt=进程和线程的关系 src=https://iliubang.cn/images/2017-10-13/process_thread.gif loading=lazy width=616 height=415></picture></p><p>线程不是进程，线程是进程中的执行单元。也就是说，一个进程可以将它的工作划分成多个小的任务，使他们同时执行。例如：进程 A 和进程 B 都能够创造线程，分别为 A1,A2,B1,B2，如果计算机有多个 CPU（例如 8 个），那么 A1, A2, B1, B2 将会在同一个时帧运行。</p><blockquote><p>使用线程，程序员可以决定将进程任务划分成多个小的任务，使得他们能同时执行</p></blockquote><p>线程的执行跟进程几乎完全一样：他们都拥有一个状态，内核线程调度程序通过这个状态来管理它们。</p><p><picture><img class="img-fluid mx-auto d-block" alt src=https://iliubang.cn/images/2017-10-13/threads_lifetime.gif loading=lazy width=600 height=296></picture></p><p>线程比进程更加轻量级，线程只需要一个栈和一些寄存器，而进程则需要更多的条件(内核虚拟机，堆，一些信号信息，一些文件描述符信息，一些锁信息等等)。</p><p>进程的内存是由内核和内存管理单元管理，而线程的内存是由程序员自己和一些线程库来管理。</p><h2 id=线程的内存布局 data-numberify>线程的内存布局<a class="anchor ms-1 d-none" href=#线程的内存布局>#</a></h2><p>正如我们了解的，线程拥有独立的栈，也就是说，线程访问有个函数中声明的变量时，他们访问的是他们持有的该变量的拷贝。但是我们不能用同样描述来说明进程的堆：堆在线程间是共享的，通常存放全局变量和文件描述符。
这样做有利也有弊。如果你只是读取一个全局的内存，你只需要在一个恰当的时机读取（例如在线程 X 之后，线程 Y 之前），如果你想要去写，那么你必须保证多个线程不能在同一时刻去写同一个内存空间：这样会破坏那个内存区域
让记忆体处于不可预知的状态；这种情况我们就称之为“竞争条件”，同时这也是线程编程背后所面临的主要挑战。</p><p>对于并发访问情况的发生，你需要在你的代码中加入一些诸如可重入性和同步机制的编程技术，可重入性用来防止并发，而同步则主要是保证并发按照可预测的方式进行。</p><p>拥有了一个很大的共享内存，就有必要去同步公共空间的访问，常用的技术有信号(semaphores)灯和互斥器(mutexes)。它们都是基于锁的概念，如果一个资源被锁定，同时有一个线程尝试访问，那么这个线程就会被阻塞，直到共享资源可以被访问。
这就是为什么使用线程并不一定就意味着你的程序能跑的更快。如果你不能有效的划分任务，或者不能有效的管理锁，程序将会比不用线程的单进程执行任务耗费更多的时间：因为线程总是在相互等待。</p><p>如果你没有熟练使用过线程的话，使用起来确实很复杂。你需要花很多时间去练习，而且会面临很多问题，如果你漏掉了一点点细节，那么你的整个程序可能在你面前崩溃掉。调试线程程序比调试非线程程序要困难的多，假如我们正在讨论的是成百上千个线程运行到进程中的真实用例，那么你将会很快迷失自己，陷入困难之中。</p><p>由于前面所述的那种共享内存的方式不是我们想要的，于是出现了 Thread Local Storage(TLS)。TLS 的主要原理是全局数据被线程持有，而且不能共享给其他线程，它们是一个代表全局状态的内存区域，但是对于线程而言是私有的。
要实现 LTS，在线程被创建的时候，就要申请一些进程堆内存，线程库提供一个 key，将该 key 关联到这块存储区域。每次访问这块属于特殊线程的区域，都需要使用这个特定的 key 来解锁才行。线程被销毁的时候，需要同时释放这块堆内存。</p><h2 id=thread-libraries data-numberify>Thread libraries<a class="anchor ms-1 d-none" href=#thread-libraries>#</a></h2><p>正如你的猜想，操作线程需要操作系统内核的帮助。在 90 年代中期，线程出现在操作系统中，又过了很长的时间，才逐渐成熟。但是依然存在跨平台的问题，尤其是 windows 和 unix 这两大对立阵营，他们采用了不同的线程模型和不同的线程库。如今，类 unix 系统中使用的是<strong>pthread</strong>（也同时存在一些其他的 thread libraries）。Pthread 代表的是"Posix threads&rdquo;，这是一个可以追溯到 1995 年的 POSIX 规范的实现。因此，如果你想在你的程序中使用线程，你需要通过 gcc 的<code>-lpthread</code>开关开连接 libpthread 到你的程序。同时 libpthread 是一个用 c 语言编写的开源程式库，它有自己独立的版本控制和管理。</p><p>所以，通常情况下，在类 unix 系统中，我们使用<strong>pthread</strong>来进行多线程编程。需要注意的是，pthread 允许并发，但是是否平行，这个取决于操作系统和计算机本身。并发是多个线程运行在同一个 CPU 执行序，平行是多个线程在同一时刻运行在不同的 CPU 上。</p><p>并发：</p><p><picture><img class="img-fluid mx-auto d-block" alt=并发 src=https://iliubang.cn/images/2017-10-13/threads_concurrency.png loading=lazy width=400 height=133></picture></p><p>平行：</p><p><picture><img class="img-fluid mx-auto d-block" alt=平行 src=https://iliubang.cn/images/2017-10-13/threads_parallelism.png loading=lazy width=400 height=135></picture></p><h2 id=php-和多线程 data-numberify>PHP 和多线程<a class="anchor ms-1 d-none" href=#php-和多线程>#</a></h2><p>让我们先回顾一下：</p><ul><li>PHP 不是一个多线程的语言：PHP 引擎不是通过管理线程来实现其并发机制。</li><li>PHP 不提供用户端操作线程的的方法：你不能通过原生 PHP 语言来直接操作线程。有一个由 PHP 核心开发人员 Joe Watkins 开发的 PHP 扩展：ext/pthread 提供了操作线程的方法，虽然这是一个非常棒的扩展库，但是我个人还是不推荐如此使用 PHP，毕竟对于多线程编程，PHP 并不是合适的语言，比如我就会选择 C 或者 Java。</li></ul><p>那么，谈论 PHP 和多线程有什么意义呢？</p><h2 id=php-是如何处理请求的 data-numberify>PHP 是如何处理请求的<a class="anchor ms-1 d-none" href=#php-是如何处理请求的>#</a></h2><p>这里说的其实是 PHP 是如何处理 HTTP 请求的。为了在同一时间内服务多个客户端，一个 web 伺服器程式需要一些并发（或者平行）机制。你不能因为响应一个客户端而阻塞其他所有的请求不是吗？如此以来，伺服器程式通常的做法是使用多进程，或多线程去响应客户端。从历史的角度来看，在 unix 上，使用的是多进程模型。因为进程是 unix 的基础，从 unix 诞生的时候起，进程就诞生了，而且拥有创建、销毁、和同步的能力。在 unix 环境中，多个 PHP 服务多个客户端，但是每一个 PHP 在一个独立的进程中运行。</p><p>如果你还记得前言中介绍的，在这种情况下，PHP 代码中不需要做任何额外的事情：进程间是彼此隔离的，进程 A 处理请求 A 中的数据，不会影响到进程 B 处理请求 B 中的数据，而这正是我们想要的。</p><p>使用这种模型的包括<code>php-fpm</code>和 Apache 的<code>mpm_prefork</code>，通常，在 98%的情形下你是用的是二者中的其中一种架构。但是，到了 windows 环境下或者在那些使用线程的 unix 系统中，事情将会变得复杂。windows 毫无质疑地是一个很优秀的操作系统，但是它有一个弊端就是它的代码不是公开的。不过幸运的是关于它内部引擎是如何工作的原理能够在互联网和一些书籍上找到，而且微软工程师也分享了很多关于 windows 核心的相关知识。在处理并发和平行的问题上，windows
选择了不同于 unix 的道路。windows 高度依赖线程，事实上，在 windows 上创建一个进程的代价是很大的以至于你通常不会这么做。在 windows 系统中，你每时每刻都在使用线程。windows 中的线程也比 unix 中强大很多。因此当你在 windows 上运行 PHP 的时候，伺服器程序（例如 IIS，Apache，FooBarBaz）会使用多线程处理不同的客户端，而不是进程。也就是说，在这样的环境下，PHP 将会运行在线程中，而且 PHP 要额外的小心线程的规则：它必须是线程安全的。</p><p>PHP 必须是线程安全的，也就是说它必须能够控制不是由它自身创建的并发性，而且必须能够。聪明的你也许已经想到了，要解决这个问题，PHP 就要寻找一种方法，能够防止其自身访问自己的全局变量。</p><p>于是就有了一个叫做<strong>Zend Thread Safety</strong>(ZTS)的模块，用以实现线程安全性。</p><h2 id=zend-thread-safety-的内部细节 data-numberify>Zend Thread Safety 的内部细节<a class="anchor ms-1 d-none" href=#zend-thread-safety-的内部细节>#</a></h2><p>开启 ZTS 可以通过使用<code>--enable-maintainer-zts</code>编译开关。通常情况下，你不需要打开此开关，除非是运行在 windows 系统中，或者是你需要使用一些扩展需要引擎是线程安全的时候。检查是否开启 ZTS 可以有很多方式，例如使用命令行<code>php -v</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl>liubang@venux:~$ /opt/app/php-7.1/bin/php -v
</span></span><span class=line><span class=cl>PHP 7.1.7 <span class=o>(</span>cli<span class=o>)</span> <span class=o>(</span>built: Jul <span class=m>11</span> <span class=m>2017</span> 10:00:35<span class=o>)</span> <span class=o>(</span> NTS <span class=o>)</span>
</span></span><span class=line><span class=cl>Copyright <span class=o>(</span>c<span class=o>)</span> 1997-2017 The PHP Group
</span></span></code></pre></div><p>你也可以使用<code>phpinfo()</code>来查看。在 PHP 中也可以使用检查<code>PHP_ZTS</code>常量来判断是否启用</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-php data-lang=php><span class=line><span class=cl><span class=k>if</span> <span class=p>(</span><span class=nx>PHP_ZTS</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>		<span class=k>echo</span> <span class=s2>&#34;OK&#34;</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>在 ZTS 模式下，PHP 内核都是线程安全的，除非你使用了非线程安全的扩展。官方 PHP 扩展都是线程安全的，但是对于一些第三方的扩展，谁能保证呢？</p><h2 id=使用和设计可重入函数 data-numberify>使用和设计可重入函数<a class="anchor ms-1 d-none" href=#使用和设计可重入函数>#</a></h2><p>当设计一个 PHP 扩展的时候，使用可重入函数。可重入函数是指函数不依赖任何全局状态来工作。简单来说，可重入函数的正确定义是一个函数可以在这个函数执行的任何时刻中断它。如果一个函数被平行调用于多个线程中，如果他们
使用了全局的变量或状态，那么显然它不是可重入函数。一些传统的 libc 函数不是可重入函数，因为他们诞生于一个没有线程的年代。因此一些 libc 发布了可重入版本，通常是在函数加上<code>_r</code>后缀。同时，最新的 C11 标准也给线程提供
了很大的空间，C11 libc 将修改函数后缀为<code>_s</code>.</p><p>处于跨平台的考虑，PHP 自身也提供了这些可重入函数，<a href=https://github.com/php/php-src/blob/PHP-7.1/main/reentrancy.c target=_blank rel="noopener noreferrer">可以访问源码来查看 PHP 提供的可重入函数列表<i class="fas fa-external-link-square-alt ms-1"></i></a>。</p><h2 id=不要连接非线程安全的程式库 data-numberify>不要连接非线程安全的程式库<a class="anchor ms-1 d-none" href=#不要连接非线程安全的程式库>#</a></h2><p>线程编程是关于整个进程镜像共享的，而进程镜像中包括一些连接的程式库。如果你的扩展连接了非线程安全的库，那么你将要采取一些措施来避免这些库访问全局资源。有些事在 C 语言和多线程语言中很常见，但是却很容易被人忘记。</p><h2 id=使用-zts data-numberify>使用 ZTS<a class="anchor ms-1 d-none" href=#使用-zts>#</a></h2><p>当我们开发 PHP 内核或者编写 PHP 扩展的时候，我们一定要区分两种全局变量。一种是普通的 C 语言全局变量, 叫做"true globals"，对于这种变量我们不必在多线程中做一些额外的工作，只需要正常的读取就好了，因为这种全局变量在线程创建之前就已经被
创建和初始化了。而执行这些操作的方法在内核中叫做<strong>module init</strong>，在很多 PHP 扩展里，我们都能看到形如以下的代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>int</span> <span class=n>val</span><span class=p>;</span> <span class=cm>/* true global */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>PHP_MINIT</span><span class=p>(</span><span class=n>wow_ext</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>somthong</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>val</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>php 扩展有很多 hook，通过 PHP 文件来触发。这个叫做<code>MINIT()</code>的 hook 是用来初始化 PHP 的，执行到这一步时，PHP 开始启动，我们可以在这里安全的读写 true globals，就像例子中那样。此外还有一个非常重要的 hook，叫做<code>RINIT()</code>，
即请求初始化，每一个 PHP 扩展的<code>RINIT()</code>hook 在每一个新的请求处理时都会被触发，也就是说<code>RINIT()</code>在一个扩展中能够被调用很多次。在<code>RINIT()</code>中，PHP 已经处于线程当中，所以此时的代码必须是线程安全的。无论是 C 语言的全局变量，还是线程全局变量，他们都是全局变量，都需要通过 ZTS 层来防止线程不安全的发生。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>PHP_RINIT</span><span class=p>(</span><span class=n>wow_ext</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>something</span><span class=p>())</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>WOW_G</span><span class=p>(</span><span class=n>val</span><span class=p>)</span> <span class=o>=</span> <span class=mi>3</span><span class=p>;</span> <span class=cm>/* writing to a thread global */</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>我们通过宏<code>WOW_G()</code>来访问线程全局变量，下面我们来探讨下这个宏背后到底发生了什么。</p><h2 id=宏的必要 data-numberify>宏的必要<a class="anchor ms-1 d-none" href=#宏的必要>#</a></h2><p>记住，当 PHP 在多线程的环境中式运行时，所有面向请求的全局资源都必须对其访问做限制。但是当 PHP 在非线程环境下运行时，这种限制就是没有必要的，因为每个进程都有它自己的存储空间，没有共享的部分。因此访问面向请求的
全局变量的操作是区分环境的，也就是说我们需要寻找一种不区分环境的统一的表现形式来访问这些全局变量。我们使用宏就是为了解决这个问题。上面的<code>WOW_G()</code>宏会区分不同的多任务引擎，而且如果你改变了条件，需要重新编译
你的扩展，这就是为什么 PHP 扩展不兼容 ZTS mode 和 non-ZTS mode：因为它不是二进制兼容的。</p><p><code>WOW_G()</code>宏在多进程模式下</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#ifdef ZTS
</span></span></span><span class=line><span class=cl><span class=cp>#define WOW_G(v) wow_globals.v
</span></span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span></code></pre></div><p>而在多线程环境中</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#ifdef ZTS
</span></span></span><span class=line><span class=cl><span class=cp>#define WOW_G(v) wow_globals.v
</span></span></span><span class=line><span class=cl><span class=cp>#else
</span></span></span><span class=line><span class=cl><span class=cp>#define WOW_G(v) (((wow_globals *) (*((void ***) tsrm_get_ls_cache())))[((wow_globals_id)-1)]-&gt;v)
</span></span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span></code></pre></div><p>ZTS 模式是不是看上去很复杂。在多进程环境中，使用的是 NZTS(Non Zend Thread Safe)，使用全局变量会被命名为<code>wow_globals</code>。这是一个存放全局变量的结构体，你可以通过使用<code>WOW_G</code>宏来访问其中的成员。<code>WOW_G(foo)</code>代表<code>wow_globals.foo</code>。很显然，你需要去声明这样的变量，然后在启动的时候将其初始化。而这一切也可以通过宏来操作：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>ZEND_BEGIN_MODULE_GLOBALS</span><span class=p>(</span><span class=n>wow</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>foo</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=n>ZEND_END_MODULE_GLOBALS</span><span class=p>(</span><span class=n>wow</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>ZEND_DECLARE_MODULE_GLOBALS</span><span class=p>(</span><span class=n>wow</span><span class=p>)</span>
</span></span></code></pre></div><p>这些宏将被展开为：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define ZEND_BEGIN_MODULE_GLOBALS(module_name) typedef struct _zend_##module_name##_globals {
</span></span></span><span class=line><span class=cl><span class=cp>#define ZEND_END_MODULE_GLOBALS(module_name) } zend_##module_name##_globals;
</span></span></span><span class=line><span class=cl><span class=cp>#define ZEND_DECLARE_MODULE_GLOBALS(module_name) zend_##module_name##_globals module_name##_globals;
</span></span></span></code></pre></div><p>上面就是在多进程模式下的实现，是不是很简单。</p><p>但是在多线程模式下，也就是使用了 ZTS，将不会再有 C 语言中的全局变量声明，但是宏的表现形式确是一致的：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define ZEND_BEGIN_MODULE_GLOBALS(module_name) typedef struct _zend_##module_name##_globals {
</span></span></span><span class=line><span class=cl><span class=cp>#define ZEND_END_MODULE_GLOBALS(module_name) } zend_##module_name##_globals;
</span></span></span><span class=line><span class=cl><span class=cp>#define ZEND_DECLARE_MODULE_GLOBALS(module_name) ts_rsrc_id module_name##_globals_id;
</span></span></span></code></pre></div><p>在 ZTS 和 NZTS 模式下申明全局变量看上去差异不大，但是访问的时候却有很大的差别，在 ZTS 模式下，通过调用<code>tsrm_get_ls_cache()</code>函数。该函数调用<strong>Thread Local Storage(TLS)</strong>，然后返回一个跟当前线程绑定的内存区域。正如
你所看到的那样，这个内存区域是非常复杂的，就凭最开始的一个<code>(void ***)case</code>类型装换，就能让我们嗅到它背后复杂的气息。</p><h2 id=tsrm-layer data-numberify>TSRM layer<a class="anchor ms-1 d-none" href=#tsrm-layer>#</a></h2><p>ZTS 是通过一个叫做 TSRM 的层实现的。Thread Safe Resource Manager layer 仅仅是一些普通的 C 代码而已！它主要位于 PHP 源码中的 TSRM 目录中。即使我们将会描述它的细节，但是阅读一下源码也是一件很有意义的事情。</p><p>TSRM 并不完美，它从 PHP5(2004)开始才大体设计完成。它可以操作一些底层的线程库：Gnu Portable Thread, Posix Threads, State Threads, Win32 Threads or BeThreads。如果你想使用 TSRM，需要在编译的时候加上<code>--with-tsrm-xxx</code>参数。在深入分析 TSRM 的时候我们只讲解 pthreads 的实现。</p><h2 id=tsrm-boot data-numberify>TSRM boot<a class="anchor ms-1 d-none" href=#tsrm-boot>#</a></h2><p>在 PHP 启动的时候，执行 module initialization 时，PHP 会迅速调用<code>tsrm_start()</code>。由于 PHP 现在还不知道有多少个线程需要建立线程安全保护，因此它初始化线程表的时候只存入 1 个元素。这个表随后会通过使用<code>malloc</code>增加元素。
这个启动操作中同样很重要的一步是同时创建 TLS 键和需要被同步的 TLS 互斥锁。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=n>pthread_key_t</span> <span class=n>tls_key</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>TSRM_API</span> <span class=kt>int</span> <span class=nf>tsrm_startup</span><span class=p>(</span><span class=kt>int</span> <span class=n>expected_threads</span><span class=p>,</span> <span class=kt>int</span> <span class=n>expected_resources</span><span class=p>,</span> <span class=kt>int</span> <span class=n>debug_level</span><span class=p>,</span> <span class=kt>char</span> <span class=o>*</span><span class=n>debug_filename</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>pthread_key_create</span><span class=p>(</span> <span class=o>&amp;</span><span class=n>tls_key</span><span class=p>,</span> <span class=mi>0</span> <span class=p>);</span> <span class=cm>/* Create the key */</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>tsrm_error_file</span> <span class=o>=</span> <span class=n>stderr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>tsrm_error_set</span><span class=p>(</span><span class=n>debug_level</span><span class=p>,</span> <span class=n>debug_filename</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>tsrm_tls_table_size</span> <span class=o>=</span> <span class=n>expected_threads</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>tsrm_tls_table</span> <span class=o>=</span> <span class=p>(</span><span class=n>tsrm_tls_entry</span> <span class=o>**</span><span class=p>)</span> <span class=n>calloc</span><span class=p>(</span><span class=n>tsrm_tls_table_size</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>tsrm_tls_entry</span> <span class=o>*</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>tsrm_tls_table</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>TSRM_ERROR</span><span class=p>((</span><span class=n>TSRM_ERROR_LEVEL_ERROR</span><span class=p>,</span> <span class=s>&#34;Unable to allocate TLS table&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>id_count</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>resource_types_table_size</span> <span class=o>=</span> <span class=n>expected_resources</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>resource_types_table</span> <span class=o>=</span> <span class=p>(</span><span class=n>tsrm_resource_type</span> <span class=o>*</span><span class=p>)</span> <span class=n>calloc</span><span class=p>(</span><span class=n>resource_types_table_size</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>tsrm_resource_type</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>resource_types_table</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>TSRM_ERROR</span><span class=p>((</span><span class=n>TSRM_ERROR_LEVEL_ERROR</span><span class=p>,</span> <span class=s>&#34;Unable to allocate resource types table&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>        <span class=n>free</span><span class=p>(</span><span class=n>tsrm_tls_table</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=n>tsrm_tls_table</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>tsmm_mutex</span> <span class=o>=</span> <span class=n>tsrm_mutex_alloc</span><span class=p>();</span> <span class=cm>/* Allocate a mutex */</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=cp>#define MUTEX_T pthread_mutex_t *
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=n>TSRM_API</span> <span class=n>MUTEX_T</span> <span class=nf>tsrm_mutex_alloc</span><span class=p>(</span><span class=kt>void</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>MUTEX_T</span> <span class=n>mutexp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>mutexp</span> <span class=o>=</span> <span class=p>(</span><span class=n>pthread_mutex_t</span> <span class=o>*</span><span class=p>)</span><span class=n>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=n>pthread_mutex_t</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=n>pthread_mutex_init</span><span class=p>(</span><span class=n>mutexp</span><span class=p>,</span><span class=nb>NULL</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>mutexp</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=tsrm-resources data-numberify>TSRM Resources<a class="anchor ms-1 d-none" href=#tsrm-resources>#</a></h2><p>至此，TSRM 已经启动了，是时候向其中添加新资源了。一个 TSRM 资源，其实就是一个存放许多全局变量集合的内存区域，通常是给 PHP 扩展专用的，而且必须被当前特定的线程所持有，或者被限制访问。接着，这个内存区域有一个大小，而且需要有初始化(constructor)和销毁(destructor)操作。通常初始化就是用 0 将其填充，而销毁则不需要做任何事情。这样被称作 TSRM Resource 的内存区域，会被 TSRM layer 赋予一个唯一的 resource ID，调用者需要保存这样的一个 ID，以便在后续的调用中返还给 TSRM。</p><p>下面是 TSRM 创建一个新的 resource 的实现：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>typedef</span> <span class=k>struct</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>size_t</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>ts_allocate_ctor</span> <span class=n>ctor</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>ts_allocate_dtor</span> <span class=n>dtor</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>done</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span> <span class=n>tsrm_resource_type</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>TSRM_API</span> <span class=n>ts_rsrc_id</span> <span class=nf>ts_allocate_id</span><span class=p>(</span><span class=n>ts_rsrc_id</span> <span class=o>*</span><span class=n>rsrc_id</span><span class=p>,</span> <span class=n>size_t</span> <span class=n>size</span><span class=p>,</span> <span class=n>ts_allocate_ctor</span> <span class=n>ctor</span><span class=p>,</span> <span class=n>ts_allocate_dtor</span> <span class=n>dtor</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>tsrm_mutex_lock</span><span class=p>(</span><span class=n>tsmm_mutex</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* obtain a resource id */</span>
</span></span><span class=line><span class=cl>    <span class=o>*</span><span class=n>rsrc_id</span> <span class=o>=</span> <span class=n>id_count</span><span class=o>++</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* store the new resource type in the resource sizes table */</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>resource_types_table_size</span> <span class=o>&lt;</span> <span class=n>id_count</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>resource_types_table</span> <span class=o>=</span> <span class=p>(</span><span class=n>tsrm_resource_type</span> <span class=o>*</span><span class=p>)</span> <span class=n>realloc</span><span class=p>(</span><span class=n>resource_types_table</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=n>tsrm_resource_type</span><span class=p>)</span><span class=o>*</span><span class=n>id_count</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>resource_types_table</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>tsrm_mutex_unlock</span><span class=p>(</span><span class=n>tsmm_mutex</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=n>TSRM_ERROR</span><span class=p>((</span><span class=n>TSRM_ERROR_LEVEL_ERROR</span><span class=p>,</span> <span class=s>&#34;Unable to allocate storage for resource&#34;</span><span class=p>));</span>
</span></span><span class=line><span class=cl>            <span class=o>*</span><span class=n>rsrc_id</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=k>return</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=n>resource_types_table_size</span> <span class=o>=</span> <span class=n>id_count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>resource_types_table</span><span class=p>[(</span><span class=o>*</span><span class=n>rsrc_id</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>].</span><span class=n>size</span> <span class=o>=</span> <span class=n>size</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>resource_types_table</span><span class=p>[(</span><span class=o>*</span><span class=n>rsrc_id</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>].</span><span class=n>ctor</span> <span class=o>=</span> <span class=n>ctor</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>resource_types_table</span><span class=p>[(</span><span class=o>*</span><span class=n>rsrc_id</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>].</span><span class=n>dtor</span> <span class=o>=</span> <span class=n>dtor</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>resource_types_table</span><span class=p>[(</span><span class=o>*</span><span class=n>rsrc_id</span><span class=p>)</span><span class=o>-</span><span class=mi>1</span><span class=p>].</span><span class=n>done</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* enlarge the arrays for the already active threads */</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>tsrm_tls_table_size</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>tsrm_tls_entry</span> <span class=o>*</span><span class=n>p</span> <span class=o>=</span> <span class=n>tsrm_tls_table</span><span class=p>[</span><span class=n>i</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>while</span> <span class=p>(</span><span class=n>p</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>count</span> <span class=o>&lt;</span> <span class=n>id_count</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=kt>int</span> <span class=n>j</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>                <span class=n>p</span><span class=o>-&gt;</span><span class=n>storage</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=n>realloc</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>storage</span><span class=p>,</span> <span class=k>sizeof</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=o>*</span><span class=n>id_count</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                <span class=k>for</span> <span class=p>(</span><span class=n>j</span><span class=o>=</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>count</span><span class=p>;</span> <span class=n>j</span><span class=o>&lt;</span><span class=n>id_count</span><span class=p>;</span> <span class=n>j</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                    <span class=n>p</span><span class=o>-&gt;</span><span class=n>storage</span><span class=p>[</span><span class=n>j</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=n>malloc</span><span class=p>(</span><span class=n>resource_types_table</span><span class=p>[</span><span class=n>j</span><span class=p>].</span><span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>                    <span class=k>if</span> <span class=p>(</span><span class=n>resource_types_table</span><span class=p>[</span><span class=n>j</span><span class=p>].</span><span class=n>ctor</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                        <span class=n>resource_types_table</span><span class=p>[</span><span class=n>j</span><span class=p>].</span><span class=n>ctor</span><span class=p>(</span><span class=n>p</span><span class=o>-&gt;</span><span class=n>storage</span><span class=p>[</span><span class=n>j</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>                    <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>                <span class=n>p</span><span class=o>-&gt;</span><span class=n>count</span> <span class=o>=</span> <span class=n>id_count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>            <span class=n>p</span> <span class=o>=</span> <span class=n>p</span><span class=o>-&gt;</span><span class=n>next</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=n>tsrm_mutex_unlock</span><span class=p>(</span><span class=n>tsmm_mutex</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=o>*</span><span class=n>rsrc_id</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>从上述代码中可以看到，这个函数需要一个互斥锁。如果它被一个子线程调用，那么它将会持有锁，其他线程将不能在同一时刻操作 global thread storage。新的 resource 被添加到了一个动态的<code>resource_types_table[]</code>数组里，然
后会生成一个唯一的标识<code>rsrc_id</code>，随着资源的不断增加，这个标识的值也会增长。</p><h2 id=在请求开始的时候 data-numberify>在请求开始的时候<a class="anchor ms-1 d-none" href=#在请求开始的时候>#</a></h2><p>现在我们已经准备好开始处理请求了。切记，每个请求都是在特定的线程中被处理的。那么当一个请求到来的时候会发生什么呢？在每个请求最最最开始的时候，<code>ts_resource_ex()</code>函数会被调用。这个函数会读取当前的线程 id，接着
尝试去获取由当前线程创建的资源，也就是专属于当前线程的用来存放全局变量的内存区域。如果没有获取到（说明是一个新的线程）那么它将会像 PHP 启动的时候那样，调用<code>allocate_new_resource()</code>函数来为当前线程创建一个新的资源。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>allocate_new_resource</span><span class=p>(</span><span class=n>tsrm_tls_entry</span> <span class=o>**</span><span class=n>thread_resources_ptr</span><span class=p>,</span> <span class=n>THREAD_T</span> <span class=n>thread_id</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>TSRM_ERROR</span><span class=p>((</span><span class=n>TSRM_ERROR_LEVEL_CORE</span><span class=p>,</span> <span class=s>&#34;Creating data structures for thread %x&#34;</span><span class=p>,</span> <span class=n>thread_id</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=o>*</span><span class=n>thread_resources_ptr</span><span class=p>)</span> <span class=o>=</span> <span class=p>(</span><span class=n>tsrm_tls_entry</span> <span class=o>*</span><span class=p>)</span> <span class=n>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=n>tsrm_tls_entry</span><span class=p>));</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=o>*</span><span class=n>thread_resources_ptr</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>storage</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>id_count</span> <span class=o>&gt;</span> <span class=mi>0</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=p>(</span><span class=o>*</span><span class=n>thread_resources_ptr</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>storage</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>**</span><span class=p>)</span> <span class=n>malloc</span><span class=p>(</span><span class=k>sizeof</span><span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span><span class=o>*</span><span class=n>id_count</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=o>*</span><span class=n>thread_resources_ptr</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>count</span> <span class=o>=</span> <span class=n>id_count</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=o>*</span><span class=n>thread_resources_ptr</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>thread_id</span> <span class=o>=</span> <span class=n>thread_id</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>(</span><span class=o>*</span><span class=n>thread_resources_ptr</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>next</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=cm>/* Set thread local storage to this new thread resources structure */</span>
</span></span><span class=line><span class=cl>    <span class=n>tsrm_tls_set</span><span class=p>(</span><span class=o>*</span><span class=n>thread_resources_ptr</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>tsrm_new_thread_begin_handler</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>tsrm_new_thread_begin_handler</span><span class=p>(</span><span class=n>thread_id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span><span class=o>&lt;</span><span class=n>id_count</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=n>resource_types_table</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>done</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=o>*</span><span class=n>thread_resources_ptr</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>storage</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=nb>NULL</span><span class=p>;</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span> <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=p>(</span><span class=o>*</span><span class=n>thread_resources_ptr</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>storage</span><span class=p>[</span><span class=n>i</span><span class=p>]</span> <span class=o>=</span> <span class=p>(</span><span class=kt>void</span> <span class=o>*</span><span class=p>)</span> <span class=n>malloc</span><span class=p>(</span><span class=n>resource_types_table</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>size</span><span class=p>);</span>
</span></span><span class=line><span class=cl>            <span class=k>if</span> <span class=p>(</span><span class=n>resource_types_table</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>ctor</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=n>resource_types_table</span><span class=p>[</span><span class=n>i</span><span class=p>].</span><span class=n>ctor</span><span class=p>((</span><span class=o>*</span><span class=n>thread_resources_ptr</span><span class=p>)</span><span class=o>-&gt;</span><span class=n>storage</span><span class=p>[</span><span class=n>i</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>            <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>tsrm_new_thread_end_handler</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>tsrm_new_thread_end_handler</span><span class=p>(</span><span class=n>thread_id</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>tsrm_mutex_unlock</span><span class=p>(</span><span class=n>tsmm_mutex</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=扩展中的-local-storage-缓存 data-numberify>扩展中的 Local Storage 缓存<a class="anchor ms-1 d-none" href=#扩展中的-local-storage-缓存>#</a></h2><p>在 PHP7 中，每一个扩展都会声明一个 local storage 缓存。也就是说每一个扩展需要在每一个新的线程启动的时候读取该线程的 local storage，而不是在每次访问全局变量的时候迭代 storage 列表。要完成这样的魔法，还需要额外的操作。首先你需要编译 PHP 的时候加上<code>DZEND_ENABLE_STATIC_TSRMLS_CACHE=1</code>参数，然后你应该用<code>ZEND_TSRMLS_CACHE_DEFINE()</code>宏来声明你的全局变量：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define ZEND_TSRMLS_CACHE_DEFINE(); __thread void *_tsrm_ls_cache = ((void *)0);
</span></span></span></code></pre></div><p>如你所见，这里声明了一个 C 语言的全局变量，但是使用了**__thread**这个特殊的声明。这是用来告知编译器，该变量是线程特有的变量。接着你需要使用<code>ZEND_TSRMLS_CACHE_UPDATE()</code>宏来将 TSRM layer 中存放的全局变量填充到这个<code>void *</code>storage 当中。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=n>PHP_GINIT_FUNCTION</span><span class=p>(</span><span class=n>my_ext</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl><span class=cp>#ifdef ZTS
</span></span></span><span class=line><span class=cl><span class=cp></span>		<span class=n>ZEND_TSRMLS_CACHE_UPDATE</span><span class=p>();</span>
</span></span><span class=line><span class=cl><span class=cp>#endif
</span></span></span><span class=line><span class=cl><span class=cp></span><span class=p>}</span>
</span></span></code></pre></div><p>下面是这个宏展开的样子：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define ZEND_TSRMLS_CACHE_UPDATE() _tsrm_ls_cache = tsrm_get_ls_cache();
</span></span></span></code></pre></div><p>针对 pthread 的实现：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#define tsrm_get_ls_cache() pthread_getspecific(tls_key)
</span></span></span></code></pre></div><p>至此，你应该能理解全局变量是如何通过下面的宏来访问的了：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=cp>#ifdef ZTS
</span></span></span><span class=line><span class=cl><span class=cp>#define MY_G(v) (((my_globals *) (*((void ***) _tsrm_ls_cache))[((my_globals_id)-1)])-&gt;(v))
</span></span></span></code></pre></div><p>使用<code>MY_G()</code>宏来访问全局变量，当在多线程环境中的时候，它将会被展开未通过扩展的 id 查找<code>_tsrm_ls_cache</code>区域：</p><p>my_globals_id:</p><p><picture><img class="img-fluid mx-auto d-block" alt src=https://iliubang.cn/images/2017-10-13/php_extensions_resources.png loading=lazy width=560 height=268></picture></p><p>每一个扩展都有存放它全局变量的空间，id 用于返回此扩展的存储空间。TSRM 会在一个新的请求/线程诞生的时候为当前线程创建这个存储空间。</p><h2 id=总结 data-numberify>总结<a class="anchor ms-1 d-none" href=#总结>#</a></h2><p>多线程编程不是一个简单的事情。在此，我只是描述了 PHP 是如何处理全局变量的管理的：它通过引擎中特定的 TSRM layer，使用 TLS 在每个新的线程和请求启动的时候分离每一个全局存储。它持有一个互斥锁，然后为当前线程创建
存储全局变量的存储空间，然后在释放互斥锁。通过这种方式，我们可以在 PHP 扩展的任何地方访问它自己的全局变量，而不需要使用互斥锁。</p><p>TSRMLS layer 背后的一切都是那么的抽象：这是一个用来简化全局变量管理的 C 代码层，尤其对于 PHP 扩展开发者而言，你通过一个宏来访问你的全局空间，如果你在 ZTS 环境下运行，这个宏会展开成特定的代码来访问每一个扩展中属于
你自己的一小部分，通过 TSRM 缓存，你不必在每次访问全局变量的时候去做查找操作，而是给你一个指向特定的存储空间的指针，你缓存起来，并在需要访问全局变量的时候使用它。</p><p>当然，这些说的都是基于请求的全局变量。你可能任然在使用 C 语言的全局变量，但是不要尝试着在处理一个请求的时候去写他们：这么做即使你没有使得整个服务器崩溃，也会给企业造成巨大的损失，而且会出现很难 debug 的奇怪行为！</p></div></div><div class="modal fade" id=rewardModal tabindex=-1 aria-labelledby=rewardModalLabel aria-hidden=true><div class=modal-dialog><div class="modal-content surface"><div class=modal-header><h5 class="modal-title text-surface" id=rewardModalLabel><i class="fas fa-fw fa-coffee me-1"></i>打赏</h5><a href=# data-bs-dismiss=modal class=btn-close aria-label=Close></a></div><div class=modal-body><ul class="nav nav-tabs mb-3" role=tablist><li class="nav-item text-nowrap" role=presentation><a class="nav-link active" id=reward-alipay-tab data-bs-toggle=tab href=#reward-alipay role=tab aria-controls=reward-alipay aria-selected=true><i class="fab fa-fw fa-alipay me-1"></i>支付宝</a></li><li class="nav-item text-nowrap" role=presentation><a class=nav-link id=reward-wechat-tab data-bs-toggle=tab href=#reward-wechat role=tab aria-controls=reward-wechat aria-selected=true><i class="fab fa-fw fa-weixin me-1"></i>微信</a></li></ul><div class=tab-content id=rewardTabContent><div class="tab-pane fade post-reward-content text-center show active" id=reward-alipay role=tabpanel aria-labelledby=reward-alipay-tab><img class="img-fluid post-reward-img" src=https://iliubang.cn/images/reward/alipay.jpg loading=lazy data-viewer-invisible></div><div class="tab-pane fade post-reward-content text-center show" id=reward-wechat role=tabpanel aria-labelledby=reward-wechat-tab><img class="img-fluid post-reward-img" src=https://iliubang.cn/images/reward/wechat.jpg loading=lazy data-viewer-invisible></div></div></div></div></div></div></div><div class=card-footer><div class="post-navs d-flex justify-content-evenly"><div class="post-nav post-prev"><i class="fas fa-fw fa-chevron-down post-prev-icon me-1" data-fa-transform=rotate-90></i>
<a href=https://iliubang.cn/posts/sp/2017-09-12-%E7%90%86%E8%A7%A3c%E8%AF%AD%E8%A8%80%E4%B8%AD%E7%9A%84%E5%A3%B0%E6%98%8E/>理解c语言中的声明</a></div><div class="post-nav post-next"><a href=https://iliubang.cn/posts/php/2017-11-29-php7%E8%99%9A%E6%8B%9F%E6%9C%BA/>PHP7虚拟机</a>
<i class="fas fa-fw fa-chevron-down post-next-icon ms-1" data-fa-transform=rotate-270></i></div></div></div></article><div class="post-copyright mb-3 row card component" id=post-copyright><div class=card-header><h2 class="card-title fs-4 my-2 text-surface">版权</h2></div><div class=card-body><a class="d-flex align-items-center flex-column" target=_blank rel="license noopener noreferrer" href=https://creativecommons.org/licenses/by-nc-nd/4.0/deed.zh><span><i class="fab fa-fw fa-2x fa-creative-commons"></i><i class="fab fa-fw fa-2x fa-creative-commons-by"></i><i class="fab fa-fw fa-2x fa-creative-commons-nc"></i><i class="fab fa-fw fa-2x fa-creative-commons-nd"></i></span>
CC BY-NC-ND 4.0</a></div></div><section class="related-posts row card component"><div class=card-header><h2 class="card-title fs-4 my-2 text-surface">相关文章</h2></div><div class=card-body><ul class="post-list list-unstyled"><li class="mb-3 border-bottom"><a class=post-title href=https://iliubang.cn/posts/php/2017-08-28-php%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91%E4%B9%8B%E8%BF%AD%E4%BB%A3%E5%99%A8/>PHP扩展开发之迭代器</a>
<span class="post-meta post-date float-end">2017-08-28</span><div class="post-summary my-3"><p>preface# 在之前的文章中，我们已经实现了一些 object handlers 来将我们的 ArrayBuffer 整合到 php 中。但是美中不足的是，我们的 ArrayBufferView 并不支持迭代器操作。也就是它不能像 php 中的数组那样使用foreach来遍历。 那么，我们接下来就来看看迭代器在内核中是如何实现的，并且给我们的 ArrayBufferView 也增加一个迭代器。
get_iterator handler# 内核中的迭代器跟用户端的IteratorAggregate接口功能是一样的。一个具有迭代功能的类都有一个get_iterator处理器，它会返回一个zend_object_iterator *类...</p><div><a class="btn btn-sm btn-outline-primary btn-read-more" href=https://iliubang.cn/posts/php/2017-08-28-php%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91%E4%B9%8B%E8%BF%AD%E4%BB%A3%E5%99%A8/>阅读更多</a></div></div></li><li class="mb-3 border-bottom"><a class=post-title href=https://iliubang.cn/posts/php/2017-08-27-php%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91%E4%B9%8B%E5%AF%B9%E8%B1%A1%E5%A4%84%E7%90%86%E5%99%A8/>PHP扩展开发之对象处理器(Object Handlers)</a>
<span class="post-meta post-date float-end">2017-08-27</span><div class="post-summary my-3"><p>Object Handlers# 在前面的博文中，已经介绍过一些 object handlers 了，也特别介绍了如何通过指定 handlers 来创建一个自定义的结构和使用clone_obj来对自定义的结构进行克隆操作。 然而，这只是开始：在 php 中，几乎所有的对象操作，都可以通过 object handlers 来实现，而且所有的魔术方法和魔术接口在内核中都是实现了对应的 object handler。此外， 一些 handlers 并没有开放给用户端的 php，例如，内部类可以自定义类的比较操作，而使用 php 代码是无法实现的。
由于 php 中有很多不同的 object handlers，这里只挑几个来讨论，其它的只给...</p><div><a class="btn btn-sm btn-outline-primary btn-read-more" href=https://iliubang.cn/posts/php/2017-08-27-php%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91%E4%B9%8B%E5%AF%B9%E8%B1%A1%E5%A4%84%E7%90%86%E5%99%A8/>阅读更多</a></div></div></li><li class="mb-3 border-bottom"><a class=post-title href=https://iliubang.cn/posts/php/2017-08-25-php%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91%E4%B9%8B%E6%89%93%E9%80%A0%E4%B8%80%E4%B8%AA%E7%AE%80%E6%98%93%E7%9A%84arraybuffer/>PHP扩展开发之打造一个简易的ArrayBuffer</a>
<span class="post-meta post-date float-end">2017-08-25</span><div class="post-summary my-3"><p>ArrayBuffer 简介# ArrayBuffer 又叫二进制数组，是一个用来表示通用的，固定长度的二进制数据缓冲区。你不能直接操纵 ArrayBuffer 的内容， 而是创建一个表示特定格式的 buffer 的类型化数组对象（也叫做数据视图对象）来对 buffer 的内容进行读写操作。
我最早了解 ArrayBuffer 是从 JavaScript 开始的，具体的用法和 api 可以参考JavaScript 标准库－－ArrayBuffer
那么接下来，我们就给 PHP 扩展一个简单的 ArrayBuffer，顺便巩固一下php 扩展开发之自定义对象的存储。
定义 ArrayBuffer 的数据结构和相关 handlers#...</p><div><a class="btn btn-sm btn-outline-primary btn-read-more" href=https://iliubang.cn/posts/php/2017-08-25-php%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91%E4%B9%8B%E6%89%93%E9%80%A0%E4%B8%80%E4%B8%AA%E7%AE%80%E6%98%93%E7%9A%84arraybuffer/>阅读更多</a></div></div></li><li class="mb-3 border-bottom"><a class=post-title href=https://iliubang.cn/posts/php/2017-08-24-php%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91%E4%B9%8B%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%AD%98%E5%82%A8/>PHP扩展开发之自定义对象的存储</a>
<span class="post-meta post-date float-end">2017-08-24</span><div class="post-summary my-3"><p>前言# 对于 php 扩展开发，很多人可能已经不那么陌生了，zend 引擎为了们提供了非常丰富了函数和 macro，来帮助我们很快速的创建一个标准的 php 类，然而，当我们在使用自定义的数据结构(struct)， 并想把我们自己定义的数据结构封装成 php 的类的时候可能就会有些困惑，因为我们都知道 php 中的所有变量都是通过 zval 来存储的，而我们自定义的数据结构要怎样才能和 zval 实现完美的对接呢？ 以前我通常采用的一种方式就是使用 zend 引擎提供的资源类型，因为资源类型的封装中包含了通用的数据类型，而且有很丰富的函数来操作资源，所以使用起来很简单也很方便。然而，强大的 zend 引擎真的没有其他方式扩展数据结构...</p><div><a class="btn btn-sm btn-outline-primary btn-read-more" href=https://iliubang.cn/posts/php/2017-08-24-php%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91%E4%B9%8B%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AF%B9%E8%B1%A1%E7%9A%84%E5%AD%98%E5%82%A8/>阅读更多</a></div></div></li><li class="mb-3 border-bottom"><a class=post-title href=https://iliubang.cn/posts/php/2017-03-09-php%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91%E4%B9%8Bcall-user-func%E5%8E%9F%E7%90%86%E5%92%8C%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%9E%E7%8E%B0/>PHP扩展开发之call_user_func原理和回调函数的实现</a>
<span class="post-meta post-date float-end">2017-03-09</span><div class="post-summary my-3"><p>函数调用# 很多时候，我们需要通过函数名来调用函数，并传递参数，或者把匿名函数作为函数的参数传递，实现回调。当我们在遇到这样的需求的时候，用 php 代码实现起来肯定是非常容易和简单的。但是，当我们在用 c 语言编写 php 扩展的时候，如何来实现这样的功能呢？下面就一起来深入了解 php 内核，看看如何实现。
在 Zend 引擎中，给我们提供了zend_call_function,call_user_function以及call_user_function_ex函数来帮助我们实现函数调用。在zend_API.h文件中，我们可以看到如下函数原型的声明：
ZEND_API int...</p><div><a class="btn btn-sm btn-outline-primary btn-read-more" href=https://iliubang.cn/posts/php/2017-03-09-php%E6%89%A9%E5%B1%95%E5%BC%80%E5%8F%91%E4%B9%8Bcall-user-func%E5%8E%9F%E7%90%86%E5%92%8C%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%9E%E7%8E%B0/>阅读更多</a></div></div></li></ul></div></section><div class="card component row post-comments" id=post-comments><div class=card-header><h2 class="card-title my-2 fs-4 text-surface">评论</h2></div><div class=card-body><script src=https://utteranc.es/client.js repo=liubang/blog issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></div></div></div></div><aside class="col-lg-4 sidebar d-flex"><div class="container d-flex flex-column"><div class="accordion profile"><div class="accordion-item card row text-center component"><div class="accordion-header card-header border-0" id=profile-header><a class="accordion-button d-lg-none mb-2 shadow-none p-0 bg-transparent text-surface collapsed" type=button data-bs-toggle=collapse data-bs-target=#profile aria-expanded=false aria-controls=profile>Profile</a></div><div class="card-body collapse accordion-collapse accordion-body d-lg-block" id=profile aria-labelledby=profile-header><div class="col-12 d-flex align-items-center justify-content-center"><picture><img class="profile-avatar rounded-circle" alt=liubang src=https://iliubang.cn/images/profile.webp loading=lazy data-viewer-invisible width=484 height=483></picture></div><div class="col-12 profile-meta"><div class="profile-name fw-fold fs-lg">liubang</div><div class=profile-bio>Whether you are an antelope or a lion, you ought to dash forward without hesitation when the sun rise</div><div class=profile-company><i class="fas fa-fw fa-building"></i>Baidu</div><div class=profile-location><i class="fas fa-fw fa-map-marker-alt"></i>Beijing</div><div class="profile-about text-primary"><i class="fas fa-fw fa-user"></i><a href=https://iliubang.cn/about/>关于</a></div></div><nav class="social-links nav justify-content-center mt-1 justify-content-around"><a class="nav-link social-link" href=mailto:it.liubang@gmail.com title=电子邮箱><i class="fas fa-fw fa-2x fa-envelope"></i></a>
<a class="nav-link social-link" target=_blank href=https://github.com/liubang title=GitHub rel="noopener noreferrer"><i class="fa-fw fa-2x fab fa-github"></i></a>
<a class="nav-link social-link" target=_blank href=https://weibo.com/2113750192 title=微博 rel="noopener noreferrer"><i class="fa-fw fa-2x fab fa-weibo"></i></a>
<a class="nav-link social-link" target=_blank href=https://iliubang.cn/index.xml title=RSS rel="noopener noreferrer"><i class="fas fa-fw fa-2x fa-rss"></i></a></nav></div></div></div><div class="accordion taxonomies-toggle"><section class="row card component accordion-item"><div class="accordion-header card-header border-0"><a class="accordion-button d-lg-none mb-1 shadow-none p-0 bg-transparent collapsed" type=button data-bs-toggle=collapse data-bs-target=#taxonomies-toggle aria-expanded=false aria-controls=taxonomies-toggle>Taxonomies</a></div><div class="card-body collapse accordion-collapse accordion-body d-lg-block" id=taxonomies-toggle><ul class="nav nav-pills nav-fill" id=myTab role=tablist><li class=nav-item role=presentation><button class="nav-link active" id=taxonomyTagsTab data-bs-toggle=tab data-bs-target=#taxonomyTags type=button role=tab aria-controls=标签 aria-selected=true>
标签</button></li><li class=nav-item role=presentation><button class=nav-link id=taxonomySeriesTab data-bs-toggle=tab data-bs-target=#taxonomySeries type=button role=tab aria-controls=专栏 aria-selected=true>
专栏</button></li><li class=nav-item role=presentation><button class=nav-link id=taxonomyArchivesTab data-bs-toggle=tab data-bs-target=#taxonomyArchive type=button role=tab aria-controls=taxonomyArchives aria-selected=true>
归档</button></li></ul><div class="tab-content mt-3"><div class="tab-pane active" id=taxonomyTags role=tabpanel aria-labelledby=taxonomyTagsTab tabindex=0><a href=https://iliubang.cn/tags/c++/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=c++>c++
<span class="badge badge-sm text-secondary bg-white ms-1">17</span></a>
<a href=https://iliubang.cn/tags/c/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=c>c
<span class="badge badge-sm text-secondary bg-white ms-1">14</span></a>
<a href=https://iliubang.cn/tags/php/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=php>php
<span class="badge badge-sm text-secondary bg-white ms-1">8</span></a>
<a href=https://iliubang.cn/tags/sp/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=sp>sp
<span class="badge badge-sm text-secondary bg-white ms-1">5</span></a>
<a href=https://iliubang.cn/tags/c++17/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=c++17>c++17
<span class="badge badge-sm text-secondary bg-white ms-1">4</span></a>
<a href=https://iliubang.cn/tags/c++11/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=c++11>c++11
<span class="badge badge-sm text-secondary bg-white ms-1">3</span></a>
<a href=https://iliubang.cn/tags/java/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=Java>Java
<span class="badge badge-sm text-secondary bg-white ms-1">3</span></a>
<a href=https://iliubang.cn/tags/jni/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=JNI>JNI
<span class="badge badge-sm text-secondary bg-white ms-1">3</span></a>
<a href=https://iliubang.cn/tags/unionfind/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=UnionFind>UnionFind
<span class="badge badge-sm text-secondary bg-white ms-1">3</span></a>
<a href=https://iliubang.cn/tags/c++14/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=c++14>c++14
<span class="badge badge-sm text-secondary bg-white ms-1">2</span></a>
<a href=https://iliubang.cn/tags class="btn btn-sm btn-secondary post-taxonomy ps-3 post-tag me-2 mb-2" title=全部>全部
<span class="badge badge-sm text-secondary bg-white ms-1">22</span></a></div><div class=tab-pane id=taxonomySeries role=tabpanel aria-labelledby=taxonomySeriesTab tabindex=0><a href=https://iliubang.cn/series/leetcode/ class="btn btn-sm btn-secondary post-taxonomy ps-3 post-series me-2 mb-2" title=LeetCode>LeetCode
<span class="badge badge-sm text-secondary bg-white ms-1">3</span></a></div><div class=tab-pane id=taxonomyArchive role=tabpanel aria-labelledby=taxonomyArchiveTab tabindex=0><a href class="btn btn-sm btn-secondary post-taxonomy ps-3 me-2 mb-2" title=2022>2022 <span class="badge badge-sm text-secondary bg-white ms-1">12</span></a>
<a href class="btn btn-sm btn-secondary post-taxonomy ps-3 me-2 mb-2" title=2021>2021 <span class="badge badge-sm text-secondary bg-white ms-1">1</span></a>
<a href class="btn btn-sm btn-secondary post-taxonomy ps-3 me-2 mb-2" title=2020>2020 <span class="badge badge-sm text-secondary bg-white ms-1">1</span></a>
<a href class="btn btn-sm btn-secondary post-taxonomy ps-3 me-2 mb-2" title=2019>2019 <span class="badge badge-sm text-secondary bg-white ms-1">2</span></a>
<a href class="btn btn-sm btn-secondary post-taxonomy ps-3 me-2 mb-2" title=2018>2018 <span class="badge badge-sm text-secondary bg-white ms-1">10</span></a>
<a href class="btn btn-sm btn-secondary post-taxonomy ps-3 me-2 mb-2" title=2017>2017 <span class="badge badge-sm text-secondary bg-white ms-1">15</span></a></div></div></div></section></div><div class="accordion posts-toggle"><section class="row card component accordion-item"><div class="accordion-header card-header border-0"><a class="accordion-button d-lg-none mb-1 shadow-none p-0 bg-transparent collapsed" type=button data-bs-toggle=collapse data-bs-target=#posts-toggle aria-expanded=false aria-controls=posts-toggle>文章</a></div><div class="card-body collapse accordion-collapse accordion-body d-lg-block" id=posts-toggle><ul class="nav nav-pills nav-fill" id=myTab role=tablist><li class=nav-item role=presentation><button class="nav-link active" id=recent-posts-tab data-bs-toggle=tab data-bs-target=#recent-posts type=button role=tab aria-controls=recent-posts aria-selected=true>
最近文章</button></li></ul><div class="tab-content mt-3"><div class="tab-pane active" id=recent-posts role=tabpanel aria-labelledby=recent-posts-tab tabindex=0><ul class="post-list list-unstyled ms-1"><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=https://iliubang.cn/posts/rust/2022-11-01-rust%E5%92%8Cc++%E5%AF%B9%E6%AF%94%E4%B9%8B%E5%8F%AF%E5%8F%98%E6%80%A7%E7%A7%BB%E5%8A%A8%E5%92%8C%E6%89%80%E6%9C%89%E6%9D%83/>Rust和C+++: 可变性、移动和所有权</a><div class="post-meta mt-2"><span class=post-date>2022-11-01</span></div></div></div></li><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=https://iliubang.cn/posts/cpp/2022-09-28-%E4%B8%BA%E4%BB%80%E4%B9%88c++%E4%B8%AD%E6%9C%89%E4%BA%86%E5%87%BD%E6%95%B0%E6%8C%87%E9%92%88%E5%8D%B4%E8%BF%98%E9%9C%80%E8%A6%81stdfunction/>为什么c++中有了函数指针却还需要std::function</a><div class="post-meta mt-2"><span class=post-date>2022-09-28</span></div></div></div></li><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=https://iliubang.cn/posts/cpp/2022-05-15-%E4%BD%BF%E7%94%A8stdlist%E7%9A%84splice%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0lru-cache/>使用std::list的splice方法实现LRU Cache</a><div class="post-meta mt-2"><span class=post-date>2022-05-15</span></div></div></div></li><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=https://iliubang.cn/posts/cpp/2022-05-03-%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3enable_shared_from_this/>深入理解 enable_shared_from_this</a><div class="post-meta mt-2"><span class=post-date>2022-05-03</span></div></div></div></li><li class=mb-2><div class=d-flex><div class="flex-grow-1 d-flex flex-column h-auto justify-content-center"><a class=post-title href=https://iliubang.cn/posts/cpp/2022-04-20-c++%E4%B8%ADunique_ptr%E7%9A%84%E4%B8%80%E4%BA%9B%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7/>c++ 中 unique_ptr 的一些使用技巧</a><div class="post-meta mt-2"><span class=post-date>2022-04-20</span></div></div></div></li></ul></div></div></div></section></div><div class="accordion post-toc d-none d-lg-block"><div class="accordion-item row mb-4 card component" id=postTOC><div class="card-header accordion-header"><h2 class="card-title fs-4 my-2 text-surface d-none d-lg-block">目录</h2><a class="accordion-button d-lg-none mb-1 collapsed shadow-none p-0 bg-transparent" type=button data-bs-toggle=collapse data-bs-target=#post-toc aria-expanded=false aria-controls=post-toc>目录</a></div><div class="card-body collapse accordion-collapse accordion-body d-lg-block" id=post-toc aria-labelledby=post-toc-header><nav id=TableOfContents><ul><li><a href=#前言>前言</a></li><li><a href=#线程的简介>线程的简介</a></li><li><a href=#线程的内存布局>线程的内存布局</a></li><li><a href=#thread-libraries>Thread libraries</a></li><li><a href=#php-和多线程>PHP 和多线程</a></li><li><a href=#php-是如何处理请求的>PHP 是如何处理请求的</a></li><li><a href=#zend-thread-safety-的内部细节>Zend Thread Safety 的内部细节</a></li><li><a href=#使用和设计可重入函数>使用和设计可重入函数</a></li><li><a href=#不要连接非线程安全的程式库>不要连接非线程安全的程式库</a></li><li><a href=#使用-zts>使用 ZTS</a></li><li><a href=#宏的必要>宏的必要</a></li><li><a href=#tsrm-layer>TSRM layer</a></li><li><a href=#tsrm-boot>TSRM boot</a></li><li><a href=#tsrm-resources>TSRM Resources</a></li><li><a href=#在请求开始的时候>在请求开始的时候</a></li><li><a href=#扩展中的-local-storage-缓存>扩展中的 Local Storage 缓存</a></li><li><a href=#总结>总结</a></li></ul></nav></div></div></div></div></aside></div></main><footer class="footer mt-auto py-3 text-center container"><div class="offcanvas offcanvas-bottom h-auto" tabindex=-1 id=offcanvasActionsPanel aria-labelledby=offcanvasActionsPanelLabel><div class=offcanvas-header><h5 class="offcanvas-title fs-4" id=offcanvasActionsPanelLabel><i class="fas fa-fw fa-th-large me-1"></i>
操作</h5><button type=button class="btn-close ms-auto" data-bs-dismiss=offcanvas data-bs-target=offcanvasActionsPanel aria-label=Close></button></div><div class="offcanvas-body mt-2"><div class="actions d-flex overflow-auto align-items-center"><a role=button class="action action-go-back d-flex flex-column align-items-center me-3" href="javascript: window.history.back();"><span class="action-icon mb-2"><i class="fas fa-2x fa-chevron-circle-down" data-fa-transform=rotate-90></i></span> 返回</a>
<a role=button class="action action-reload-page d-flex flex-column align-items-center me-3"><span class="action-icon mb-2"><i class="fas fa-2x fa-redo-alt"></i></span> 刷新</a>
<a role=button class="action action-copy-url d-flex flex-column align-items-center me-3"><span class="action-icon mb-2"><i class="fas fa-2x fa-link"></i></span> 复制链接</a></div></div></div><nav class="social-links nav justify-content-center mb-2"><a class="nav-link social-link" href=mailto:it.liubang@gmail.com title=电子邮箱><i class="fas fa-fw fa-2x fa-envelope"></i></a>
<a class="nav-link social-link" target=_blank href=https://github.com/liubang title=GitHub rel="noopener noreferrer"><i class="fa-fw fa-2x fab fa-github"></i></a>
<a class="nav-link social-link" target=_blank href=https://weibo.com/2113750192 title=微博 rel="noopener noreferrer"><i class="fa-fw fa-2x fab fa-weibo"></i></a>
<a class="nav-link social-link" target=_blank href=https://iliubang.cn/index.xml title=RSS rel="noopener noreferrer"><i class="fas fa-fw fa-2x fa-rss"></i></a></nav><div class="copyright mb-2">Copyright © 2016-2022 LiuBang. All Rights Reserved.</div><div class="powered-by mb-2">Powered by <a class=text-primary href=https://gohugo.io target=_blank rel="noopener noreferrer">Hugo</a> and the <a class=text-primary href=https://github.com/razonyang/hugo-theme-bootstrap target=_blank rel="noopener noreferrer">HBS</a> theme.</div></footer><script data-precache src=https://iliubang.cn/assets/main/bundle.min.3f08584561b4b96a5a502b7e880c02be584aa88f43e47c960ce2da037b960e81.js integrity="sha256-PwhYRWG0uWpaUCt+iAwCvlhKqI9D5HyWDOLaA3uWDoE=" crossorigin=anonymous defer></script><script data-precache src=https://iliubang.cn/assets/icons/bundle.min.4ba087d9c203230e40a605c4c44dd349f33064ce869ff4f34e2ae194ce745b74.js integrity="sha256-S6CH2cIDIw5ApgXExE3TSfMwZM6Gn/TzTirhlM50W3Q=" crossorigin=anonymous defer></script>
<script data-precache src=https://iliubang.cn/assets/viewer/bundle.min.9f713149f059d05fcb65e7f7c27308e61c384500e80ab1c333c2510a36a5d70c.js integrity="sha256-n3ExSfBZ0F/LZef3wnMI5hw4RQDoCrHDM8JRCjal1ww=" crossorigin=anonymous defer></script><script data-precache defer src=https://iliubang.cn/assets/katex/bundle.min.5d4e21071a95ce5b1f635fc99cc98e30d14b157ff223fb4f76117fdf4029c3a5.js integrity="sha256-XU4hBxqVzlsfY1/JnMmOMNFLFX/yI/tPdhF/30Apw6U=" crossorigin=anonymous></script>
<script data-precache defer src=https://iliubang.cn/assets/mermaid/bundle.min.e0678d67a61d9ab297dc3f1de9ca8e43614ce49e9e0d310b80787e532fca37a1.js integrity="sha256-4GeNZ6YdmrKX3D8d6cqOQ2FM5J6eDTELgHh+Uy/KN6E=" crossorigin=anonymous></script>
<script>"serviceWorker"in navigator&&window.addEventListener("load",()=>{navigator.serviceWorker.register("https://iliubang.cn/service-worker.min.js").then(function(e){console.log("Successfully registered service worker",e)}).catch(function(e){console.warn("Error whilst registering service worker",e)})})</script></body></html>